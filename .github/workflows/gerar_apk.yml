name: F√°brica Turbo V56 (No Splash & Discord Log) ü§ñ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
  repository_dispatch:
    types: [build_app]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      # Passa o secret explicitamente
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. DADOS E LIMPEZA ---
      - name: üßπ Ler Dados
        id: dados
        run: |
          if [ -f package.json ]; then mv package.json package.json.bak; fi
          if [ -f config.xml ]; then mv config.xml config.xml.bak; fi
          
          cat <<EOF > ler.py
          import json, os
          try:
              with open('features.json') as f: d = json.load(f)
          except: d = {}
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={d.get('packageId', 'com.fabrica.v56')}\n")
              f.write(f"APP_VER={d.get('version', '1.0.0')}\n")
              f.write(f"APP_NAME={d.get('appName', 'App V56')}\n")
              f.write(f"HAS_SPLASH={d.get('hasSplash', False)}\n")
          EOF
          python3 ler.py

      # --- 2. DISCORD DEBUGGER (VERIFICA O PROBLEMA) ---
      - name: üîç Debug Discord Conex√£o
        run: |
          echo "Testando Webhook..."
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ùå ERRO: O Secret DISCORD_WEBHOOK est√° vazio ou n√£o existe!"
          else
            echo "‚úÖ Secret detectado. Tentando enviar..."
            # Usa curl verbose para mostrar o erro exato
            curl -v -H "Content-Type: application/json" \
            -d "{\"content\": \"@everyone üè≠ **F√ÅBRICA V56**\n\n‚öôÔ∏è App: ${{ env.APP_NAME }}\nüö´ Splash: ${{ env.HAS_SPLASH }}\"}" \
            $DISCORD_WEBHOOK || echo "Falha no CURL"
          fi

      # --- 3. SETUP ---
      - name: üõ†Ô∏è Setup Tools
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH

      # --- 4. CRIA√á√ÉO E L√ìGICA NO-SPLASH ---
      - name: üèóÔ∏è Configurando XML (Com L√≥gica Splash)
        run: |
          cordova create app-temp ${{ env.APP_ID }} "TempName"
          cp -r www/* app-temp/www/
          
          cd app-temp
          cat <<EOF > edit.py
          import xml.etree.ElementTree as ET, os
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              root.set('id', os.environ['APP_ID'])
              root.set('version', os.environ['APP_VER'])
              for n in root.findall('{http://www.w3.org/ns/widgets}name'): n.text = os.environ['APP_NAME']
              
              # Configura√ß√µes Padr√£o
              prefs = {
                  'AndroidPersistentFileLocation': 'Compatibility',
                  'AllowFileAccess': 'true',
                  'AndroidInsecureFileModeEnabled': 'true'
              }
              
              # L√ìGICA DO SPLASH
              has_splash = os.environ.get('HAS_SPLASH') == 'True'
              
              if not has_splash:
                  print("üö´ SPLASH DESATIVADO (Delay 0)")
                  prefs['SplashScreenDelay'] = '0'
                  prefs['ShowSplashScreen'] = 'false'
                  prefs['FadeSplashScreen'] = 'false'
              else:
                  print("‚úÖ SPLASH ATIVADO")
                  prefs['SplashScreenDelay'] = '3000'
                  prefs['ShowSplashScreen'] = 'true'

              for k,v in prefs.items():
                  found = False
                  for p in root.findall('{http://www.w3.org/ns/widgets}preference'):
                      if p.get('name') == k: p.set('value',v); found=True
                  if not found:
                      el = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
                      el.set('name',k); el.set('value',v)
                      
              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
          except Exception as e:
              print(f"Erro XML: {e}")
              exit(1)
          EOF
          python3 edit.py

      # --- 5. PLATAFORMA ---
      - name: üîå Adicionando Android
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          cordova plugin add cordova-plugin-ionic-webview

      # --- 6. PLUGINS ---
      - name: üß© Plugins
        run: |
          cd app-temp
          cat <<EOF > plugins.py
          import json, os, subprocess
          try:
              with open('../features.json') as f: d = json.load(f)
          except: d = {}
          def install(p): subprocess.run(f"cordova plugin add {p}", shell=True)

          if d.get('notification'): install("cordova-plugin-x-toast")
          if d.get('file'): install("cordova-plugin-file-opener2")
          if d.get('camera'): install("cordova-plugin-camera")
          if d.get('geolocation'): install("cordova-plugin-geolocation")
          if d.get('vibration'): install("cordova-plugin-vibration")
          if d.get('fullscreen'): install("cordova-plugin-fullscreen")
          if d.get('microphone'): install("cordova-plugin-media cordova-plugin-media-capture")
          if d.get('insomnia'): install("cordova-plugin-insomnia")
          install("cordova-plugin-android-permissions")
          EOF
          python3 plugins.py
          cordova prepare android

      # --- 7. √çCONES (FIND & DELETE OLD) ---
      - name: üé® Injetando √çcones e ID
        run: |
          cd app-temp
          ICON="www/icon.png"
          SPLASH="www/splash.png"
          
          # √çCONE
          if [ -f "$ICON" ]; then
             find platforms/android -name "ic_launcher*.xml" -delete
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher.png \;
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher_round.png \;
          fi
          
          # SPLASH (Se existir)
          if [ -f "$SPLASH" ]; then
             # Copia splash para drawable (padr√£o antigo) para garantir
             mkdir -p platforms/android/app/src/main/res/drawable
             cp "$SPLASH" platforms/android/app/src/main/res/drawable/screen.png
          fi
          
          GRADLE=$(find platforms/android -name "build.gradle" | grep "app/build.gradle" | head -n 1)
          if [ -f "$GRADLE" ]; then
             sed -i 's/applicationId ".*"/applicationId "${{ env.APP_ID }}"/' "$GRADLE"
             sed -i 's/namespace ".*"/namespace "${{ env.APP_ID }}"/' "$GRADLE"
          fi

      # --- 8. BUILD ---
      - name: üì± Compilando
        id: build_apk
        run: |
          cd app-temp
          echo "android.useAndroidX=true" >> platforms/android/gradle.properties
          echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
             echo "STATUS=FALHA" >> $GITHUB_ENV; exit 1
          else
             SAFE=$(echo "${{ env.APP_NAME }}" | sed 's/[^a-zA-Z0-9]/_/g')
             FINAL="App_${SAFE}_v${{ env.APP_VER }}.apk"
             mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL"
             echo "APK_FINAL=$FINAL" >> $GITHUB_ENV
             echo "STATUS=SUCESSO" >> $GITHUB_ENV
          fi

      # --- 9. RELEASE ---
      - name: üöÄ Publicar
        uses: softprops/action-gh-release@v1
        if: env.STATUS == 'SUCESSO'
        with:
          tag_name: v${{ github.run_number }}
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 10. NOTIFICA√á√ÉO FINAL ---
      - name: üîî Discord (Fim)
        if: always()
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then echo "Sem webhook."; exit 0; fi
          if [ "${{ env.STATUS }}" == "SUCESSO" ]; then
             MSG="{\"content\": \"@everyone ‚úÖ **SUCESSO!**\n[Baixar APK](https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }})\"}"
          else
             MSG="{\"content\": \"@everyone ‚ùå **ERRO CR√çTICO.**\"}"
          fi
          curl -H "Content-Type: application/json" -d "$MSG" $DISCORD_WEBHOOK || true
