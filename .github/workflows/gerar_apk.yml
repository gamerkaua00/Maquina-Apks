name: F√°brica Turbo V47 (Nuclear Fix) ‚ò¢Ô∏è

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
  repository_dispatch:
    types: [build_app]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. PREPARA√á√ÉO DOS DADOS ---
      - name: üß† Ler JSON e Definir Vari√°veis
        id: dados
        run: |
          # Extrai dados do features.json com Python seguro
          cat <<EOF > ler.py
          import json, os
          try:
              with open('features.json') as f: d = json.load(f)
          except: d = {}
          
          # Define valores padr√£o se falhar
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={d.get('packageId', 'com.fabrica.nuclear')}\n")
              f.write(f"APP_VER={d.get('version', '1.0.0')}\n")
              f.write(f"APP_NAME={d.get('appName', 'App Nuclear')}\n")
          EOF
          python3 ler.py

      # --- 2. NOTIFICA√á√ÉO TURBO (IN√çCIO) ---
      - name: üîî Discord (IN√çCIO)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"@everyone üö® **F√ÅBRICA INICIADA!**\n\n‚öôÔ∏è **App:** ${{ env.APP_NAME }}\nüÜî **ID:** \`${{ env.APP_ID }}\`\nüî¢ **Vers√£o:** ${{ env.APP_VER }}\n\n*Aguarde o processamento...*\"}" \
          $DISCORD_WEBHOOK

      # --- 3. AMBIENTE ---
      - name: ‚òï Java 17 & Ferramentas
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üõ†Ô∏è Android SDK & Cordova
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH
          npm install -g cordova
          
      # --- 4. CRIA√á√ÉO (M√âTODO LIMPO) ---
      - name: üèóÔ∏è Criando Estrutura
        run: |
          # Cria j√° com o ID e Nome corretos para o Cordova registrar internamente
          cordova create app-temp ${{ env.APP_ID }} "TempName"
          
          # Copia seus arquivos
          cp -r www/* app-temp/www/
          
          cd app-temp
          # Configura vers√£o no XML antes de adicionar plataforma
          sed -i 's/version="1.0.0"/version="${{ env.APP_VER }}"/' config.xml
          
          # Ajusta o Nome no XML
          sed -i "s/<name>TempName<\/name>/<name>${{ env.APP_NAME }}<\/name>/" config.xml

      # --- 5. PLATAFORMA ---
      - name: üîå Adicionando Android
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          cordova plugin add cordova-plugin-ionic-webview
          # Adicione outros plugins aqui se necess√°rio...

      # --- 6. CORRE√á√ÉO NUCLEAR (ID E VERS√ÉO NO GRADLE) ---
      - name: ‚ò¢Ô∏è INJE√á√ÉO NO GRADLE (For√ßar ID)
        run: |
          cd app-temp
          # Encontra o build.gradle do app e substitui o applicationId na for√ßa bruta
          GRADLE_FILE="platforms/android/app/build.gradle"
          
          if [ -f "$GRADLE_FILE" ]; then
             echo "Encontrado build.gradle. Injetando ID..."
             # Substitui qualquer applicationId "com.x.x" pelo nosso ID
             sed -i 's/applicationId ".*"/applicationId "${{ env.APP_ID }}"/' $GRADLE_FILE
             # For√ßa o namespace tamb√©m (importante para Android 12+)
             sed -i 's/namespace ".*"/namespace "${{ env.APP_ID }}"/' $GRADLE_FILE
          else
             echo "ERRO CR√çTICO: build.gradle n√£o encontrado!"
             exit 1
          fi

      # --- 7. √çCONES (LOCALIZAR E DESTRUIR) ---
      - name: üé® Injetando √çcones (Global)
        run: |
          cd app-temp
          ICON_SOURCE="www/icon.png"
          
          if [ -f "$ICON_SOURCE" ]; then
             echo "Injetando √≠cones em TODAS as pastas mipmap..."
             # O comando find procura qualquer pasta que comece com mipmap- dentro de platforms
             # e copia o √≠cone para dentro dela
             find platforms/android -type d -name "mipmap-*" -exec cp $ICON_SOURCE {}/ic_launcher.png \;
             find platforms/android -type d -name "mipmap-*" -exec cp $ICON_SOURCE {}/ic_launcher_round.png \;
             find platforms/android -type d -name "mipmap-*" -exec cp $ICON_SOURCE {}/ic_launcher_foreground.png \;
          else
             echo "‚ö†Ô∏è AVISO: √çcone n√£o enviado (www/icon.png n√£o existe)"
          fi

      # --- 8. BUILD ---
      - name: üì± Compilando APK
        id: build_apk
        run: |
          cd app-temp
          echo "android.useAndroidX=true" >> platforms/android/gradle.properties
          
          # Build
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
             echo "STATUS=FALHA" >> $GITHUB_ENV
             exit 1
          else
             # Prepara nome final
             SAFE_NAME=$(echo "${{ env.APP_NAME }}" | sed 's/[^a-zA-Z0-9]/_/g')
             FINAL="App_${SAFE_NAME}_v${{ env.APP_VER }}.apk"
             mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL"
             
             echo "APK_FINAL=$FINAL" >> $GITHUB_ENV
             echo "STATUS=SUCESSO" >> $GITHUB_ENV
          fi

      # --- 9. RELEASE ---
      - name: üöÄ Publicar no GitHub
        uses: softprops/action-gh-release@v1
        if: env.STATUS == 'SUCESSO'
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} v${{ env.APP_VER }}"
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 10. NOTIFICA√á√ÉO TURBO (FINAL) ---
      - name: üîî Discord (FIM)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "${{ env.STATUS }}" == "SUCESSO" ]; then
             LINK="https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
             curl -H "Content-Type: application/json" \
             -d "{\"content\": \"@everyone ‚úÖ **SUCESSO! O APK EST√Å PRONTO!**\n\nüì± **App:** ${{ env.APP_NAME }}\nüìÇ **Download:** [Clique aqui para Baixar]($LINK)\n\n*Produ√ß√£o finalizada.*\"}" \
             $DISCORD_WEBHOOK
          else
             LOG="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
             curl -H "Content-Type: application/json" \
             -d "{\"content\": \"@everyone ‚ùå **FALHA CR√çTICA NA PRODU√á√ÉO!**\n\nOcorreu um erro ao compilar o aplicativo.\n[Ver Logs de Erro]($LOG)\"}" \
             $DISCORD_WEBHOOK
          fi
