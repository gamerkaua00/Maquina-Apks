name: F√°brica Turbo V42 (Fix Syntax & Discord & Gradle) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # --- FIX CR√çTICO: FOR√áAR GRADLE 8.7 ---
    # O Gradle 9 quebra o Cordova. Estas vari√°veis for√ßam o uso da vers√£o compat√≠vel.
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME_17_X64: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. SETUP DE AMBIENTE ---
      - name: ‚òï Setup Java & Gradle
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      # ADICIONADO: Instala√ß√£o expl√≠cita do Gradle 8.7 para garantir
      - name: üõ†Ô∏è Setup Gradle 8.7 Manual
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.7'

      - name: üõ†Ô∏è Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 2. PREPARA√á√ÉO DE DADOS ---
      - name: üß† Processando Dados
        id: dados
        run: |
          # Script Python externo √© mais seguro que inline para processar JSON
          cat <<EOF > ler_dados.py
          import json, os
          
          def get_val(key, default):
              try:
                  with open('features.json') as f:
                      data = json.load(f)
                      return data.get(key, default)
              except:
                  return default
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={get_val('packageId', 'com.fabrica.app')}\n")
              f.write(f"APP_VER={get_val('version', '1.0.0')}\n")
              f.write(f"APP_NAME=App Turbo\n") 
          EOF
          python3 ler_dados.py
          
          # Sobrescreve nome se houver config.xml
          if [ -f config.xml ]; then
             NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
             if [ ! -z "$NAME" ]; then echo "APP_NAME=$NAME" >> $GITHUB_ENV; fi
          fi

      # --- NOTIFICA√á√ÉO INICIAL (CURL SIMPLIFICADO) ---
      - name: üîî Discord (In√≠cio)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Usando curl com User-Agent para evitar bloqueio 403 e erro de sintaxe YAML
          curl -H "Content-Type: application/json" \
               -H "User-Agent: Mozilla/5.0" \
               -d "{
                 \"username\": \"F√°brica Admin üõ°Ô∏è\",
                 \"avatar_url\": \"https://img.icons8.com/fluency/96/robot-2.png\",
                 \"embeds\": [{
                   \"title\": \"üü° Iniciando Build: ${{ env.APP_NAME }}\",
                   \"description\": \"üÜî \`${{ env.APP_ID }}\`\nüî¢ v${{ env.APP_VER }}\",
                   \"color\": 16776960
                 }]
               }" \
               "$DISCORD_WEBHOOK"

      # --- 3. CRIA√á√ÉO DO PROJETO ---
      - name: üèóÔ∏è Criando Estrutura
        run: |
          echo "Criando projeto com ID: ${{ env.APP_ID }}"
          cordova create app-temp ${{ env.APP_ID }} "${{ env.APP_NAME }}"
          
          # Limpa www padr√£o e copia o do usu√°rio
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/

      # --- 4. MANIPULA√á√ÉO XML ---
      - name: üîß Configura√ß√£o Cir√∫rgica (XML)
        run: |
          cd app-temp
          
          # Prepara √≠cone se existir
          HAS_ICON="false"
          ICON_SRC=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" \) | head -n 1)
          if [ -n "$ICON_SRC" ]; then
             cp "$ICON_SRC" res_icon.png
             HAS_ICON="true"
          fi
          
          # Prepara Splash
          HAS_SPLASH="false"
          SPLASH_SRC=$(find www -maxdepth 1 -type f -iname "splash.png" | head -n 1)
          if [ -n "$SPLASH_SRC" ]; then
             cp "$SPLASH_SRC" res_splash.png
             HAS_SPLASH="true"
          fi

          # Script Python para editar XML (Sem problemas de indenta√ß√£o do YAML)
          cat <<EOF > edit_xml.py
          import xml.etree.ElementTree as ET
          import os
          
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          ET.register_namespace('cdv', "http://cordova.apache.org/ns/1.0")
          
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              
              # 1. For√ßa ID e Vers√£o
              root.set('id', os.environ.get('APP_ID', 'com.error.id'))
              root.set('version', os.environ.get('APP_VER', '1.0.0'))
              
              # 2. For√ßa Nome
              for name in root.findall('{http://www.w3.org/ns/widgets}name'):
                  name.text = os.environ.get('APP_NAME', 'App Turbo')
              
              # 3. Adiciona √çcone
              if "$HAS_ICON" == "true":
                  for icon in root.findall('{http://www.w3.org/ns/widgets}icon'): root.remove(icon)
                  icon = ET.SubElement(root, '{http://www.w3.org/ns/widgets}icon')
                  icon.set('src', 'res_icon.png')
              
              # 4. Adiciona Splash
              if "$HAS_SPLASH" == "true":
                  splash = ET.SubElement(root, '{http://www.w3.org/ns/widgets}splash')
                  splash.set('src', 'res_splash.png')
                  ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference', {'name': 'ShowSplashScreen', 'value': 'true'})
                  ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference', {'name': 'SplashScreenDelay', 'value': '3000'})

              # 5. Permiss√µes
              perms = [
                  ('AndroidPersistentFileLocation', 'Compatibility'),
                  ('AllowFileAccess', 'true'),
                  ('requestLegacyExternalStorage', 'true')
              ]
              for p in perms:
                  ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference', {'name': p[0], 'value': p[1]})

              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
              print("‚úÖ XML Editado")
          except Exception as e:
              print(f"‚ùå Erro XML: {e}")
              exit(1)
          EOF
          
          python3 edit_xml.py

      # --- 5. PLUGINS ---
      - name: üîå Instalando Plugins
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          
          cordova plugin remove cordova-plugin-whitelist || true
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          if [ -f "../features.json" ]; then
             # Usando condicionais bash simples para evitar complexidade
             if [ "$(jq -r '.vibration' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-vibration; fi
             if [ "$(jq -r '.camera' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-camera; fi
             if [ "$(jq -r '.geolocation' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
             if [ "$(jq -r '.battery' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
             if [ "$(jq -r '.fullscreen' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
             if [ "$(jq -r '.flashlight' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
             if [ "$(jq -r '.microphone' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-media cordova-plugin-media-capture; fi
             if [ "$(jq -r '.insomnia' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
             if [ "$(jq -r '.toast' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-x-toast; fi
             if [ "$(jq -r '.file' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-file-opener2; fi
          fi

      - name: üöë Fix Gradle (Cirurgia)
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          fi

      - name: üì± Build APK
        id: build_apk
        run: |
          cd app-temp
          rm -rf ~/.gradle/caches/
          
          echo "üöÄ Compilando..."
          # Adicionado -PcdvCompileSdkVersion=33 para refor√ßar a vers√£o do SDK
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "STATUS_BUILD=FALHA" >> $GITHUB_ENV
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            FINAL_NAME="${SAFE_NAME}_v${{ env.APP_VER }}.apk"
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL_NAME"
            FILE_SIZE=$(ls -lh "$GITHUB_WORKSPACE/$FINAL_NAME" | awk '{print $5}')
            
            echo "APK_FINAL=$FINAL_NAME" >> $GITHUB_ENV
            echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
            echo "STATUS_BUILD=SUCESSO" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} v${{ env.APP_VER }}"
          body: |
            ‚úÖ **Build Finalizado!**
            üì± **ID:** `${{ env.APP_ID }}`
            üíæ **Tamanho:** ${{ env.FILE_SIZE }}
            
            ‚¨áÔ∏è **BAIXE O ARQUIVO ABAIXO EM ASSETS**
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # --- LOG FINAL (CURL SIMPLIFICADO) ---
      - name: üîî Discord (Fim)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          # Define variaveis de bash para usar no JSON
          if [ "$STATUS" == "success" ]; then
            COLOR=5763712
            TITLE="‚úÖ SUCESSO"
            CONTENT="@everyone üéâ **APK PRONTO!**"
            DESC="Download dispon√≠vel na Release."
          else
            COLOR=15548997
            TITLE="‚ùå FALHA"
            CONTENT="@everyone ‚ö†Ô∏è **Erro na F√°brica!**"
            DESC="Verifique os logs."
          fi
          
          DL_LINK="${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          LOG_LINK="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Envia via CURL com User-Agent e JSON montado cuidadosamente
          curl -H "Content-Type: application/json" \
               -H "User-Agent: Mozilla/5.0" \
               -d "{
                 \"username\": \"F√°brica Bot ü§ñ\",
                 \"avatar_url\": \"https://img.icons8.com/fluency/96/robot-2.png\",
                 \"content\": \"$CONTENT\",
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"description\": \"$DESC\",
                   \"color\": $COLOR,
                   \"fields\": [
                     { \"name\": \"App\", \"value\": \"${{ env.APP_NAME }}\", \"inline\": true },
                     { \"name\": \"Download\", \"value\": \"[Baixar APK]($DL_LINK)\", \"inline\": false },
                     { \"name\": \"Logs\", \"value\": \"[Ver Logs]($LOG_LINK)\", \"inline\": false }
                   ]
                 }]
               }" \
               "$DISCORD_WEBHOOK"
