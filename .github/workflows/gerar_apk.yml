name: F√°brica Inteligente v4.0 (Super Turbo + Permiss√µes) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Baixando C√≥digo
      uses: actions/checkout@v3

    - name: ‚òï Configurando Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: üõ†Ô∏è Instalando Gradle 8.7 (Est√°vel)
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.7'

    - name: üõ†Ô∏è Configurando Android SDK (Blindado)
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"

    - name: üì¶ Instalando Cordova
      run: |
        npm install -g cordova

    - name: üèóÔ∏è Criando a Base do App
      run: |
        # Cria projeto limpo
        cordova create app-temp com.kaua.app "Seu App Turbo"
        
        # Limpa o padr√£o e copia o site do usu√°rio
        rm -rf app-temp/www/*
        cp -r www/* app-temp/www/

    - name: üé® Configurando √çcone
      run: |
        cd app-temp
        if [ -f "www/icon.png" ]; then
          echo "üî• √çcone encontrado!"
          cp www/icon.png .
          sed -i '/<content src="index.html" \/>/a <icon src="icon.png" />' config.xml
        fi

    - name: üîå Instalando Super Poderes (Plugins Din√¢micos)
      run: |
        cd app-temp
        # Android 12.0.0 (O mais compat√≠vel atualmente)
        cordova platform add android@12.0.0
        
        # --- KITS DE SOBREVIV√äNCIA (Sempre instalados) ---
        echo "üîß Instalando Kit B√°sico..."
        cordova plugin add cordova-plugin-ionic-webview  # Corrige tela branca
        cordova plugin add cordova-plugin-device         # Identifica o celular
        cordova plugin add cordova-plugin-dialogs        # Popups nativos
        cordova plugin add cordova-plugin-android-permissions # VITAL para Android 13+ (Pedir pra notificar)

        # --- LEITURA DO MENU DE OP√á√ïES (features.json) ---
        if [ -f "../features.json" ]; then
          echo "üìÑ Lendo lista de desejos do usu√°rio..."
          
          # L√™ cada op√ß√£o do arquivo JSON
          USE_NOTIF=$(jq -r '.notification' ../features.json)
          USE_VIBRA=$(jq -r '.vibration' ../features.json)
          USE_CAM=$(jq -r '.camera' ../features.json)
          USE_GPS=$(jq -r '.geolocation' ../features.json)
          USE_BATTERY=$(jq -r '.battery' ../features.json)
          USE_NETWORK=$(jq -r '.network' ../features.json)
          USE_ORIENT=$(jq -r '.orientation' ../features.json)
          USE_FULLSCREEN=$(jq -r '.fullscreen' ../features.json)
          
          # Novos Poderes V4.0
          USE_BROWSER=$(jq -r '.browser' ../features.json)
          USE_FILE=$(jq -r '.file' ../features.json)
          USE_SHARING=$(jq -r '.sharing' ../features.json)
          USE_INSOMNIA=$(jq -r '.insomnia' ../features.json)

          # Instala√ß√£o Condicional
          if [ "$USE_NOTIF" = "true" ]; then 
            echo "üîî Adicionando Notifica√ß√µes Agendadas..."
            cordova plugin add cordova-plugin-local-notification
          fi

          if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; fi
          if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; fi
          if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
          if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
          if [ "$USE_NETWORK" = "true" ]; then cordova plugin add cordova-plugin-network-information; fi
          if [ "$USE_ORIENT" = "true" ]; then cordova plugin add cordova-plugin-screen-orientation; fi
          if [ "$USE_FULLSCREEN" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
          
          if [ "$USE_BROWSER" = "true" ]; then 
            echo "üåê Adicionando Navegador Interno..."
            cordova plugin add cordova-plugin-inappbrowser
          fi
          
          if [ "$USE_FILE" = "true" ]; then 
            echo "üìÇ Adicionando Gerenciador de Arquivos..."
            cordova plugin add cordova-plugin-file
          fi
          
          if [ "$USE_SHARING" = "true" ]; then 
            echo "üîó Adicionando Compartilhamento Social..."
            cordova plugin add cordova-plugin-x-socialsharing
          fi
          
          if [ "$USE_INSOMNIA" = "true" ]; then 
            echo "‚òï Adicionando Insomnia (Tela sempre ligada)..."
            cordova plugin add cordova-plugin-insomnia
          fi

        else
          echo "‚ÑπÔ∏è features.json n√£o encontrado. Instalando apenas o b√°sico."
        fi

    - name: üßπ Limpeza Preventiva
      run: |
        cd app-temp
        rm -rf ~/.gradle/caches/

    - name: üì± Compilando e Rastreando APK
      run: |
        cd app-temp
        # Compila√ß√£o Debug (Aceita em qualquer celular)
        cordova build android --debug -- --gradleArg=-PcdvMinSdkVersion=24 --packageType=apk
        
        echo "üîç Rastreando APK no sistema..."
        APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
        
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå ERRO CR√çTICO: APK n√£o encontrado ap√≥s compila√ß√£o!"
          # Lista arquivos para debug em caso de erro
          find "$GITHUB_WORKSPACE" -name "*.apk"
          exit 1
        else
          echo "‚úÖ APK CAPTURADO: $APK_PATH"
          mv "$APK_PATH" "$GITHUB_WORKSPACE/app-instalavel.apk"
        fi

    - name: üöÄ Criar Link de Download (Release)
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ github.run_number }}
        name: "APK Pronto (Vers√£o ${{ github.run_number }})"
        body: "Seu aplicativo Turbo V4.0 est√° pronto! Baixe o arquivo abaixo."
        files: app-instalavel.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
