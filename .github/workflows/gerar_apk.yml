name: F√°brica Inteligente v4.0 (Fix Upload Mirror) üõ°Ô∏è

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      - name: ‚òï Configurando Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üõ†Ô∏è Instalando Gradle 8.7
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.7'

      - name: üõ†Ô∏è Configurando Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"

      - name: üì¶ Instalando Cordova
        run: |
          npm install -g cordova

      - name: üèóÔ∏è Criando a Base do App
        run: |
          cordova create app-temp com.kaua.app "Seu App"
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/

      - name: üé® Configurando √çcone
        run: |
          cd app-temp
          if [ -f "www/icon.png" ]; then
            echo "üî• √çcone encontrado!"
            cp www/icon.png .
            sed -i '/<content src="index.html" \/>/a <icon src="icon.png" />' config.xml
          fi

      - name: üîå Instalando Plugins
        run: |
          cd app-temp
          # Android 12 j√° tem Whitelist nativa.
          cordova platform add android@12.0.0
          
          # Plugins Base
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          
          # Navegador Interno
          cordova plugin add cordova-plugin-inappbrowser

          # Leitura do features.json
          if [ -f "../features.json" ]; then
            USE_NOTIF=$(jq -r '.notification' ../features.json)
            USE_VIBRA=$(jq -r '.vibration' ../features.json)
            USE_CAM=$(jq -r '.camera' ../features.json)
            USE_GPS=$(jq -r '.geolocation' ../features.json)
            USE_BATTERY=$(jq -r '.battery' ../features.json)
            USE_NETWORK=$(jq -r '.network' ../features.json)
            USE_ORIENT=$(jq -r '.orientation' ../features.json)
            USE_FULLSCREEN=$(jq -r '.fullscreen' ../features.json)
            USE_FLASHLIGHT=$(jq -r '.flashlight' ../features.json)
            USE_MIC=$(jq -r '.microphone' ../features.json)
            USE_INSOMNIA=$(jq -r '.insomnia' ../features.json)

            if [ "$USE_NOTIF" = "true" ]; then cordova plugin add cordova-plugin-local-notification || echo "Skip"; fi
            if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; fi
            if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; fi
            if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
            if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
            if [ "$USE_NETWORK" = "true" ]; then cordova plugin add cordova-plugin-network-information; fi
            if [ "$USE_ORIENT" = "true" ]; then cordova plugin add cordova-plugin-screen-orientation; fi
            
            if [ "$USE_FULLSCREEN" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
            if [ "$USE_FLASHLIGHT" = "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
            
            if [ "$USE_MIC" = "true" ]; then
               cordova plugin add cordova-plugin-media
               cordova plugin add cordova-plugin-media-capture
            fi
            
            if [ "$USE_INSOMNIA" = "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
          fi

      - name: üè∑Ô∏è Detectando Nome do App
        id: get_name
        run: |
          cd app-temp
          APP_NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

      - name: üßπ Limpando Cache
        run: |
          cd app-temp
          rm -rf ~/.gradle/caches/

      - name: üì± Compilando APK
        run: |
          cd app-temp
          cordova build android --debug -- --gradleArg=-PcdvMinSdkVersion=24 --packageType=apk
          
          echo "üîç Procurando APK..."
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå ERRO: APK n√£o encontrado!"
            find "$GITHUB_WORKSPACE" -name "*.apk"
            exit 1
          else
            # Renomeia para o nome real do app
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | sed 's/ /_/g')
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$SAFE_NAME.apk"
            echo "APK_FINAL=$SAFE_NAME.apk" >> $GITHUB_ENV
          fi

      - name: üì§ Upload R√°pido (Mirror 0x0.st)
        id: upload_fast
        run: |
          echo "Subindo ${{ env.APK_FINAL }}..."
          # Tenta subir para o 0x0.st (Servidor mais est√°vel)
          curl -F "file=@${{ env.APK_FINAL }}" https://0x0.st > link_externo.txt || echo "" > link_externo.txt
          
          LINK=$(cat link_externo.txt)
          if [ -z "$LINK" ]; then
             echo "‚ö†Ô∏è Upload falhou, usando link padr√£o do GitHub."
             echo "LINK_MIRROR=Verifique o Assets abaixo" >> $GITHUB_ENV
          else
             echo "LINK_MIRROR=$LINK" >> $GITHUB_ENV
          fi

      - name: üöÄ Criar Release (Link Direto)
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} (v${{ github.run_number }})"
          body: |
            ‚úÖ **Seu App est√° pronto!**
            
            üì± **Nome:** ${{ env.APP_NAME }}
            
            ‚¨áÔ∏è **CLIQUE AQUI PARA BAIXAR (R√ÅPIDO):**
            MIRROR_LINK: ${{ env.LINK_MIRROR }}
            
            _(Servidor de backup no Assets abaixo)_
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üì§ Backup no Actions
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: APK-Debug-Backup
          path: ${{ env.APK_FINAL }}
