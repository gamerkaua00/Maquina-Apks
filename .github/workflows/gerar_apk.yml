name: F√°brica Turbo V30 (Discord Logs + Fix ID/Icon) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    # FIX: For√ßa o Cordova a usar Gradle 8.7 (Compat√≠vel) em vez do 9.0 (Incompat√≠vel)
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME_17_X64: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. LEITURA ANTECIPADA (Para criar o app j√° com o ID certo) ---
      - name: üßê Lendo Configura√ß√µes (Pre-Build)
        id: config
        run: |
          # Valores Padr√£o
          APP_NAME="App Turbo"
          APP_ID="com.kaua.app"
          APP_VER="1.0.0"
          HAS_ICON="‚ùå N√£o"
          
          if [ -f "features.json" ]; then
            echo "üìÑ Lendo features.json..."
            # Extrai dados usando jq
            JSON_ID=$(jq -r '.packageId // empty' features.json)
            JSON_VER=$(jq -r '.version // empty' features.json)
            
            # Se tiver ID no JSON, usa ele. Sen√£o usa o padr√£o.
            if [ ! -z "$JSON_ID" ]; then APP_ID=$JSON_ID; fi
            if [ ! -z "$JSON_VER" ]; then APP_VER=$JSON_VER; fi
          fi

          # Tenta ler nome do config.xml se existir (o frontend manda o nome l√°)
          if [ -f "config.xml" ]; then
             XML_NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
             if [ ! -z "$XML_NAME" ]; then APP_NAME=$XML_NAME; fi
          fi
          
          # Verifica se tem √≠cone
          if [ -f "www/icon.png" ]; then HAS_ICON="‚úÖ Sim"; fi
          
          echo "DADOS DO PROJETO:"
          echo "Nome: $APP_NAME"
          echo "ID: $APP_ID"
          echo "Vers√£o: $APP_VER"
          echo "√çcone: $HAS_ICON"
          
          # Salva nas vari√°veis de ambiente para usar nos pr√≥ximos passos
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_ID=$APP_ID" >> $GITHUB_ENV
          echo "APP_VER=$APP_VER" >> $GITHUB_ENV
          echo "HAS_ICON=$HAS_ICON" >> $GITHUB_ENV

      # --- 2. NOTIFICA√á√ÉO DE IN√çCIO (DISCORD) ---
      - name: üîî Discord (In√≠cio)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"embeds\":[{\"title\":\"üè≠ F√°brica Iniciada\",\"description\":\"Criando: **${{ env.APP_NAME }}**\nID: \`${{ env.APP_ID }}\`\nVers√£o: \`${{ env.APP_VER }}\`\",\"color\":16776960}]}" \
          $DISCORD_WEBHOOK

      - name: ‚òï Configurando Ambiente
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üõ†Ô∏è Ferramentas Android
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 3. CRIA√á√ÉO DO APP (COM O ID CERTO AGORA) ---
      - name: üèóÔ∏è Criando App
        run: |
          # O comando create agora usa as vari√°veis que lemos no come√ßo
          cordova create app-temp ${{ env.APP_ID }} "${{ env.APP_NAME }}"
          
          # Limpa e copia o site
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/
          
          # Ajusta vers√£o no config.xml gerado
          cd app-temp
          sed -i "s/version=\"1.0.0\"/version=\"${{ env.APP_VER }}\"/" config.xml
          
          # Adiciona permiss√µes essenciais
          sed -i '/<widget/a \    <preference name="AndroidPersistentFileLocation" value="Compatibility" />' config.xml
          sed -i '/<widget/a \    <preference name="AllowFileAccess" value="true" />' config.xml
          sed -i '/<widget/a \    <preference name="requestLegacyExternalStorage" value="true" />' config.xml

      # --- 4. √çCONE E SPLASH (FOR√áA BRUTA) ---
      - name: üé® Configurando Visual
        run: |
          cd app-temp
          
          # --- √çCONE ---
          # Se o usu√°rio mandou icon.png na pasta www
          if [ -f "www/icon.png" ]; then
             echo "üî• Aplicando √≠cone personalizado..."
             cp www/icon.png ./icon.png
             
             # M√©todo 1: Config.xml (Padr√£o)
             sed -i '/<icon/d' config.xml
             sed -i '/<widget/a \    <icon src="icon.png" />' config.xml
             
             # M√©todo 2: For√ßa Bruta (Copia para pastas do sistema Android ap√≥s add platform)
             # Faremos isso no pr√≥ximo passo ap√≥s 'cordova platform add'
          else
             echo "‚ö†Ô∏è Usando √≠cone padr√£o."
          fi
          
          # --- SPLASH ---
          if [ -f "www/splash.png" ]; then
             cp www/splash.png ./splash.png
             sed -i '/<splash/d' config.xml
             sed -i '/<widget/a \    <splash src="splash.png" />' config.xml
             sed -i '/<widget/a \    <preference name="ShowSplashScreen" value="true" />' config.xml
          fi

      - name: üîå Plugins e Plataforma
        run: |
          cd app-temp
          
          echo "üì± Adicionando Android..."
          cordova platform add android@12.0.0
          
          # --- AQUI ACONTECE A FOR√áA BRUTA DO √çCONE ---
          if [ -f "icon.png" ]; then
             echo "üëä Substituindo √≠cones do sistema Android..."
             RES="platforms/android/app/src/main/res"
             # Copia o √≠cone para todas as resolu√ß√µes (O Android redimensiona ou usa assim mesmo)
             cp icon.png $RES/mipmap-ldpi/ic_launcher.png || true
             cp icon.png $RES/mipmap-mdpi/ic_launcher.png || true
             cp icon.png $RES/mipmap-hdpi/ic_launcher.png || true
             cp icon.png $RES/mipmap-xhdpi/ic_launcher.png || true
             cp icon.png $RES/mipmap-xxhdpi/ic_launcher.png || true
             cp icon.png $RES/mipmap-xxxhdpi/ic_launcher.png || true
          fi
          
          # Plugins Base
          cordova plugin remove cordova-plugin-whitelist || true
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          # Vari√°vel para logar quais plugins foram instalados
          INSTALLED_PLUGINS="B√°sicos"

          if [ -f "../features.json" ]; then
            USE_VIBRA=$(jq -r '.vibration' ../features.json)
            USE_CAM=$(jq -r '.camera' ../features.json)
            USE_GPS=$(jq -r '.geolocation' ../features.json)
            USE_BATTERY=$(jq -r '.battery' ../features.json)
            USE_FULL=$(jq -r '.fullscreen' ../features.json)
            USE_FLASH=$(jq -r '.flashlight' ../features.json)
            USE_MIC=$(jq -r '.microphone' ../features.json)
            USE_INSOMNIA=$(jq -r '.insomnia' ../features.json)
            USE_TOAST=$(jq -r '.toast' ../features.json)
            USE_FILE=$(jq -r '.file' ../features.json)

            if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Vibra√ß√£o"; fi
            if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, C√¢mera"; fi
            if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, GPS"; fi
            if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Bateria"; fi
            if [ "$USE_FULL" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Tela Cheia"; fi
            if [ "$USE_FLASH" = "true" ]; then cordova plugin add cordova-plugin-flashlight; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Lanterna"; fi
            if [ "$USE_TOAST" = "true" ]; then cordova plugin add cordova-plugin-x-toast; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Toast"; fi
            if [ "$USE_INSOMNIA" = "true" ]; then cordova plugin add cordova-plugin-insomnia; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Insomnia"; fi
            if [ "$USE_FILE" = "true" ]; then cordova plugin add cordova-plugin-file-opener2; INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Arquivos"; fi
            
            if [ "$USE_MIC" = "true" ]; then 
               cordova plugin add cordova-plugin-media cordova-plugin-media-capture
               INSTALLED_PLUGINS="$INSTALLED_PLUGINS, Microfone"
            fi
          fi
          
          # Salva lista para o log final
          echo "PLUGINS_LIST=$INSTALLED_PLUGINS" >> $GITHUB_ENV

      - name: üöë Fix Gradle
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
              
              # FIX: For√ßar o Gradle Wrapper para a vers√£o 8.7 (Compat√≠vel)
              if [ -f "platforms/android/gradle/wrapper/gradle-wrapper.properties" ]; then
                  echo "For√ßando Gradle 8.7 no wrapper..."
                  sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.7-all.zip|g' platforms/android/gradle/wrapper/gradle-wrapper.properties
              fi
          fi

      - name: üì± Build APK
        run: |
          cd app-temp
          rm -rf ~/.gradle/caches/
          echo "üöÄ Compilando..."
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "STATUS_BUILD=FALHA" >> $GITHUB_ENV
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$SAFE_NAME.apk"
            echo "APK_FINAL=$SAFE_NAME.apk" >> $GITHUB_ENV
            echo "STATUS_BUILD=SUCESSO" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} (v${{ github.run_number }})"
          body: "‚úÖ App Criado com Sucesso!"
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # --- 5. RELAT√ìRIO FINAL (DISCORD) ---
      - name: üîî Discord (Relat√≥rio Final)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          COLOR=5763712 # Verde
          TITLE="‚úÖ SUCESSO"
          if [ "$STATUS" == "failure" ]; then 
            COLOR=15548997 # Vermelho
            TITLE="‚ùå FALHA"
          fi
          
          # Monta o JSON do Discord com detalhes
          # Link direto para a release
          DL_LINK="${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          
          curl -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"$TITLE: F√°brica de Apps\",
              \"color\": $COLOR,
              \"fields\": [
                { \"name\": \"üì± App\", \"value\": \"${{ env.APP_NAME }}\", \"inline\": true },
                { \"name\": \"üÜî ID\", \"value\": \"\`${{ env.APP_ID }}\`\", \"inline\": true },
                { \"name\": \"üî¢ Vers√£o\", \"value\": \"${{ env.APP_VER }}\", \"inline\": true },
                { \"name\": \"üñºÔ∏è √çcone\", \"value\": \"${{ env.HAS_ICON }}\", \"inline\": true },
                { \"name\": \"üîå Plugins\", \"value\": \"${{ env.PLUGINS_LIST }}\" },
                { \"name\": \"üì• Download\", \"value\": \"[Clique aqui para baixar]($DL_LINK)\" }
              ],
              \"footer\": { \"text\": \"Build #${{ github.run_number }}\" }
            }]
          }" \
          $DISCORD_WEBHOOK
