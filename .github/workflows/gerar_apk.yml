name: F√°brica Turbo V29 (Icon Brute Force + Fix Cache) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      - name: ‚ö° Cache Gradle & NPM
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.npm
          key: ${{ runner.os }}-gradle-v29-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-gradle-v29-

      - name: ‚òï Configurando Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üõ†Ô∏è Instalando Gradle 8.7
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.7'

      - name: üõ†Ô∏è Configurando Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"

      - name: üì¶ Instalando Cordova
        run: |
          npm install -g cordova

      - name: üèóÔ∏è Criando a Base do App
        run: |
          cordova create app-temp com.kaua.app "Seu App Turbo"
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/

          if [ -f config.xml ]; then 
            echo "üìÑ Config.xml encontrado! Aplicando..."
            cp config.xml app-temp/
          fi

      - name: üé® Preparando √çcone e Splash
        run: |
          cd app-temp
          
          # Procura √≠cone (qualquer nome comum)
          ICON_FILE=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" -o -iname "app-icon.png" \) | head -n 1)
          
          if [ -n "$ICON_FILE" ]; then
            echo "üî• √çcone encontrado: $ICON_FILE"
            cp "$ICON_FILE" ./icon.png
            # Remove tags antigas e define a nova
            sed -i '/<icon/d' config.xml
            sed -i '/<widget/a \    <icon src="icon.png" />' config.xml
          else
            echo "‚ö†Ô∏è Usando √≠cone padr√£o (Rob√¥)."
            curl -L -o ./icon.png "https://img.icons8.com/fluency/512/robot-2.png"
            sed -i '/<widget/a \    <icon src="icon.png" />' config.xml
          fi
          
          # Splash Screen
          SPLASH_FILE=$(find www -maxdepth 1 -type f -iname "splash.png" | head -n 1)
          if [ -n "$SPLASH_FILE" ]; then
             echo "üåä Splash Screen encontrada!"
             cp "$SPLASH_FILE" ./splash.png
             sed -i '/<splash/d' config.xml
             sed -i '/<widget/a \    <splash src="splash.png" />' config.xml
             sed -i '/<widget/a \    <preference name="SplashScreenDelay" value="3000" />' config.xml
             sed -i '/<widget/a \    <preference name="ShowSplashScreen" value="true" />' config.xml
          fi
          
          # Permiss√µes
          sed -i '/<widget/a \    <preference name="AndroidPersistentFileLocation" value="Compatibility" />' config.xml
          sed -i '/<widget/a \    <preference name="AllowFileAccess" value="true" />' config.xml
          sed -i '/<widget/a \    <preference name="requestLegacyExternalStorage" value="true" />' config.xml

      - name: üîå Instalando Plugins e Plataforma
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          cordova plugin remove cordova-plugin-whitelist || true
          
          # Plugins Base
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          # Leitura do features.json
          if [ -f "../features.json" ]; then
            
            # Personaliza√ß√£o ID/Vers√£o
            CUSTOM_ID=$(jq -r '.packageId // empty' ../features.json)
            CUSTOM_VER=$(jq -r '.version // empty' ../features.json)
            if [ ! -z "$CUSTOM_ID" ]; then sed -i "s/id=\"[^\"]*\"/id=\"$CUSTOM_ID\"/" config.xml; fi
            if [ ! -z "$CUSTOM_VER" ]; then sed -i "s/version=\"[^\"]*\"/version=\"$CUSTOM_VER\"/" config.xml; fi

            # Instala√ß√£o Plugins
            USE_VIBRA=$(jq -r '.vibration' ../features.json)
            USE_CAM=$(jq -r '.camera' ../features.json)
            USE_GPS=$(jq -r '.geolocation' ../features.json)
            USE_BATTERY=$(jq -r '.battery' ../features.json)
            USE_NETWORK=$(jq -r '.network' ../features.json)
            USE_ORIENT=$(jq -r '.orientation' ../features.json)
            USE_FULL=$(jq -r '.fullscreen' ../features.json)
            USE_FLASH=$(jq -r '.flashlight' ../features.json)
            USE_MIC=$(jq -r '.microphone' ../features.json)
            USE_INSOMNIA=$(jq -r '.insomnia' ../features.json)
            USE_TOAST=$(jq -r '.toast' ../features.json)
            USE_STATUS=$(jq -r '.statusbar' ../features.json)
            USE_CLIP=$(jq -r '.clipboard' ../features.json)
            USE_SPLASH=$(jq -r '.splashscreen' ../features.json)
            USE_FILE=$(jq -r '.file' ../features.json)
            USE_NOTIF=$(jq -r '.notification' ../features.json)

            if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; fi
            if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; fi
            if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
            if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
            if [ "$USE_NETWORK" = "true" ]; then cordova plugin add cordova-plugin-network-information; fi
            if [ "$USE_ORIENT" = "true" ]; then cordova plugin add cordova-plugin-screen-orientation; fi
            if [ "$USE_FULL" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
            if [ "$USE_FLASH" = "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
            if [ "$USE_TOAST" = "true" ]; then cordova plugin add cordova-plugin-x-toast; fi
            if [ "$USE_INSOMNIA" = "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
            if [ "$USE_STATUS" = "true" ]; then cordova plugin add cordova-plugin-statusbar; fi
            if [ "$USE_CLIP" = "true" ]; then cordova plugin add cordova-plugin-clipboard; fi
            if [ "$USE_SPLASH" = "true" ]; then cordova plugin add cordova-plugin-splashscreen; fi
            if [ "$USE_FILE" = "true" ]; then cordova plugin add cordova-plugin-file-opener2; fi
            
            if [ "$USE_MIC" = "true" ]; then 
               cordova plugin add cordova-plugin-media
               cordova plugin add cordova-plugin-media-capture
            fi
            
            # Notifica√ß√£o (Vers√£o est√°vel)
            if [ "$USE_NOTIF" = "true" ]; then
                cordova plugin add cordova-plugin-local-notification || echo "‚ö†Ô∏è Falha ao instalar notifica√ß√£o (Ignorado)"
            fi
          fi
          
          cordova prepare android

      # --- NOVO: SUBSTITUI√á√ÉO FOR√áADA DE √çCONE ---
      - name: üî® For√ßando √çcone (Brute Force)
        run: |
          cd app-temp
          if [ -f "icon.png" ]; then
             echo "üëä Substituindo √≠cones nativos do Android..."
             # Copia o √≠cone.png para todas as pastas de densidade (mipmap)
             # Isso garante que o Android use esse arquivo, ignorando config.xml se necess√°rio
             RES_PATH="platforms/android/app/src/main/res"
             cp icon.png "$RES_PATH/mipmap-ldpi/ic_launcher.png" || true
             cp icon.png "$RES_PATH/mipmap-mdpi/ic_launcher.png" || true
             cp icon.png "$RES_PATH/mipmap-hdpi/ic_launcher.png" || true
             cp icon.png "$RES_PATH/mipmap-xhdpi/ic_launcher.png" || true
             cp icon.png "$RES_PATH/mipmap-xxhdpi/ic_launcher.png" || true
             cp icon.png "$RES_PATH/mipmap-xxxhdpi/ic_launcher.png" || true
             echo "‚úÖ √çcones substitu√≠dos fisicamente."
          fi

      # --- 5. CORRE√á√ÉO DE ERROS (GRADLE) ---
      - name: üöë Reparando Scripts do Gradle
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile(/implementation(/g' {} +
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/debugCompile /debugImplementation /g' {} +
              
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          fi

      - name: üè∑Ô∏è Detectando Nome
        id: get_name
        run: |
          cd app-temp
          APP_NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          
          SAFE_ID=$(echo "$APP_NAME" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g' | tr '[:upper:]' '[:lower:]' | sed 's/\.\.\././g')
          NEW_ID="com.kaua.app.$SAFE_ID"
          sed -i "s/id=\"[^\"]*\"/id=\"$NEW_ID\"/" config.xml

      - name: üì± Compilando APK
        run: |
          cd app-temp
          # Limpa cache do Gradle antes
          rm -rf ~/.gradle/caches/
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå ERRO: APK n√£o encontrado!"
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | sed 's/ /_/g')
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$SAFE_NAME.apk"
            echo "APK_FINAL=$SAFE_NAME.apk" >> $GITHUB_ENV
          fi

      - name: üì§ Upload Turbo (Mirrors)
        id: upload_fast
        run: |
          APK="${{ env.APK_FINAL }}"
          LINK=""
          # Tenta 3 servidores de backup
          if [ -z "$LINK" ]; then RESP=$(curl -s -F "reqtype=fileupload" -F "time=24h" -F "fileToUpload=@$APK" https://litterbox.catbox.moe/resources/internals/api.php || echo "FAIL"); if [[ "$RESP" == http* ]]; then LINK=$RESP; fi; fi
          if [ -z "$LINK" ]; then RESP=$(curl -s -F "file=@$APK" https://0x0.st || echo "FAIL"); if [[ "$RESP" == http* ]]; then LINK=$RESP; fi; fi
          if [ -z "$LINK" ]; then RESP=$(curl -s -F "file=@$APK" https://file.io || echo "FAIL"); LINK=$(echo $RESP | grep -o '"link":"[^"]*' | cut -d'"' -f4); fi

          if [[ "$LINK" == http* ]]; then
             echo "LINK_MIRROR=$LINK" >> $GITHUB_ENV
          else
             echo "LINK_MIRROR=Verifique o Assets abaixo" >> $GITHUB_ENV
          fi

      - name: üöÄ Criar Release no GitHub
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} (v${{ github.run_number }})"
          body: |
            ‚úÖ **Seu App est√° pronto!**
            
            üì± **Nome:** ${{ env.APP_NAME }}
            
            ‚¨áÔ∏è **LINK TURBO:** ${{ env.LINK_MIRROR }}
            
            _(Backup: Assets do GitHub abaixo)_
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîî Notificar Discord
        if: success() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"‚úÖ **APK PRONTO!**\nüì± App: ${{ env.APP_NAME }}\nüì• Download: ${{ env.LINK_MIRROR }}\"}" \
          $DISCORD_WEBHOOK
