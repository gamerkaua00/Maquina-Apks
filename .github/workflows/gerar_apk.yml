name: FÃ¡brica Inteligente v3.0 (Download Direto + Full Power) ğŸš€

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write # PermissÃ£o necessÃ¡ria para criar Releases e Uploads

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Baixando CÃ³digo (Checkout)
      uses: actions/checkout@v3

    - name: â˜• Configurando Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ“¦ Instalando Cordova
      run: |
        npm install -g cordova

    - name: ğŸ—ï¸ Criando a Base do App
      run: |
        # Cria projeto temporÃ¡rio
        cordova create app-temp com.kaua.app "Seu App"
        
        # Limpa o padrÃ£o e copia o site do usuÃ¡rio
        rm -rf app-temp/www/*
        cp -r www/* app-temp/www/

    - name: ğŸ¨ Configurando Ãcone AutomÃ¡tico
      run: |
        cd app-temp
        if [ -f "www/icon.png" ]; then
          echo "ğŸ”¥ Ãcone personalizado encontrado!"
          cp www/icon.png .
          sed -i '/<content src="index.html" \/>/a <icon src="icon.png" />' config.xml
        fi

    - name: ğŸ”Œ Instalando Plugins (Leitura do features.json)
      run: |
        cd app-temp
        cordova platform add android
        
        # --- PLUGINS OBRIGATÃ“RIOS (Base do sistema) ---
        echo "ğŸ”§ Instalando plugins base..."
        cordova plugin add cordova-plugin-ionic-webview
        cordova plugin add cordova-plugin-device
        cordova plugin add cordova-plugin-dialogs

        # --- PLUGINS OPCIONAIS (LÃª do features.json) ---
        if [ -f "../features.json" ]; then
          echo "ğŸ“„ Lendo preferÃªncias do usuÃ¡rio..."
          
          # Usa ferramenta 'jq' do Linux para ler o JSON
          USE_NOTIF=$(jq -r '.notification' ../features.json)
          USE_VIBRA=$(jq -r '.vibration' ../features.json)
          USE_CAM=$(jq -r '.camera' ../features.json)
          USE_GPS=$(jq -r '.geolocation' ../features.json)
          
          # NOVOS RECURSOS V3.0
          USE_BATTERY=$(jq -r '.battery' ../features.json)
          USE_NETWORK=$(jq -r '.network' ../features.json)
          USE_ORIENT=$(jq -r '.orientation' ../features.json)
          USE_FULLSCREEN=$(jq -r '.fullscreen' ../features.json)

          if [ "$USE_NOTIF" = "true" ]; then
            echo "ğŸ”” Adicionando NotificaÃ§Ãµes..."
            cordova plugin add cordova-plugin-local-notification || echo "âš ï¸ Aviso: Falha na notificaÃ§Ã£o"
          fi

          if [ "$USE_VIBRA" = "true" ]; then
            echo "ğŸ“³ Adicionando VibraÃ§Ã£o..."
            cordova plugin add cordova-plugin-vibration
          fi

          if [ "$USE_CAM" = "true" ]; then
            echo "ğŸ“¸ Adicionando CÃ¢mera..."
            cordova plugin add cordova-plugin-camera
          fi

          if [ "$USE_GPS" = "true" ]; then
            echo "ğŸ“ Adicionando GeolocalizaÃ§Ã£o..."
            cordova plugin add cordova-plugin-geolocation
          fi

          if [ "$USE_BATTERY" = "true" ]; then
            echo "ğŸ”‹ Adicionando Status da Bateria..."
            cordova plugin add cordova-plugin-battery-status
          fi

          if [ "$USE_NETWORK" = "true" ]; then
            echo "ğŸ“¡ Adicionando InformaÃ§Ãµes de Rede..."
            cordova plugin add cordova-plugin-network-information
          fi

          if [ "$USE_ORIENT" = "true" ]; then
            echo "ğŸ”„ Adicionando Controle de OrientaÃ§Ã£o..."
            cordova plugin add cordova-plugin-screen-orientation
          fi
          
          if [ "$USE_FULLSCREEN" = "true" ]; then
            echo "ğŸ“º Adicionando Tela Cheia..."
            cordova plugin add cordova-plugin-fullscreen
          fi

        else
          echo "â„¹ï¸ features.json nÃ£o encontrado. Usando apenas o bÃ¡sico."
        fi

    - name: ğŸ“± Compilando APK (Modo Debug)
      run: |
        cd app-temp
        # O argumento --gradleArg=-PcdvMinSdkVersion=24 ajuda a evitar erros com plugins modernos
        cordova build android --debug -- --gradleArg=-PcdvMinSdkVersion=24 --packageType=apk
        
        # Renomeia para ficar bonito no download
        mv platforms/android/app/build/outputs/apk/debug/app-debug.apk app-instalavel.apk

    - name: ğŸš€ Criar Link de Download Direto (Release)
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ github.run_number }} # Cria uma versÃ£o Ãºnica (v1, v2, v3...)
        name: "APK Pronto (VersÃ£o ${{ github.run_number }})"
        body: "Seu aplicativo foi fabricado com sucesso! Clique no arquivo apk abaixo para instalar."
        files: app-temp/app-instalavel.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
