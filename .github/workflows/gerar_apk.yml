name: F√°brica Turbo V52 (Titan Fix) üõ°Ô∏è

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
  repository_dispatch:
    types: [build_app]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"
      # For√ßa o Cordova a usar este Gradle, ignorando vers√µes antigas
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. LIMPEZA E DADOS ---
      - name: üßπ Limpar Ambiente e Ler JSON
        id: dados
        run: |
          # Remove arquivos da raiz que causam conflito
          if [ -f package.json ]; then mv package.json package.json.bak; fi
          if [ -f config.xml ]; then mv config.xml config.xml.bak; fi
          
          # L√™ o JSON enviado pelo Painel
          cat <<EOF > ler.py
          import json, os
          try:
              with open('features.json') as f: d = json.load(f)
          except: d = {}
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={d.get('packageId', 'com.fabrica.titan')}\n")
              f.write(f"APP_VER={d.get('version', '1.0.0')}\n")
              f.write(f"APP_NAME={d.get('appName', 'App Titan')}\n")
          EOF
          python3 ler.py

      # --- 2. NOTIFICA√á√ÉO DISCORD (PYTHON) ---
      - name: üîî Discord (Start)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat <<EOF > notify.py
          import os, json, urllib.request, sys
          webhook = os.environ.get('DISCORD_WEBHOOK')
          if not webhook: print("Sem webhook"); sys.exit(0)
          
          msg = {
              "username": "F√°brica Titan ü§ñ",
              "content": "@everyone üè≠ **PRODU√á√ÉO INICIADA (V52)**",
              "embeds": [{
                  "title": "‚öôÔ∏è Processando: ${{ env.APP_NAME }}",
                  "color": 3447003,
                  "fields": [
                      {"name": "ID", "value": "\`${{ env.APP_ID }}\`", "inline": True},
                      {"name": "Vers√£o", "value": "${{ env.APP_VER }}", "inline": True}
                  ]
              }]
          }
          
          try:
              req = urllib.request.Request(webhook, data=json.dumps(msg).encode(), headers={'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'})
              urllib.request.urlopen(req)
              print("‚úÖ Notifica√ß√£o enviada!")
          except Exception as e:
              print(f"‚ùå Erro Discord: {e}")
          EOF
          python3 notify.py

      # --- 3. SETUP COMPLETO (FIX BUILD TOOLS) ---
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üõ†Ô∏è Setup Android SDK & Build Tools (CR√çTICO)
        run: |
          # Instala SDK Manager e Licen√ßas
          echo "Aceitando licen√ßas..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null || true
          
          echo "Instalando Build Tools 33.0.2 (Obrigat√≥rio)..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          
          echo "Instalando Cordova..."
          npm install -g cordova

          # For√ßa Gradle 8.7
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH

      # --- 4. CRIA√á√ÉO DO APP ---
      - name: üèóÔ∏è Criando App (Isolated)
        run: |
          echo "Criando projeto..."
          cordova create app-temp ${{ env.APP_ID }} "TempName"
          cp -r www/* app-temp/www/
          
          cd app-temp
          
          # PYTHON: Edita XML com seguran√ßa
          cat <<EOF > edit.py
          import xml.etree.ElementTree as ET, os
          
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              
              root.set('id', os.environ['APP_ID'])
              root.set('version', os.environ['APP_VER'])
              
              for n in root.findall('{http://www.w3.org/ns/widgets}name'):
                  n.text = os.environ['APP_NAME']
              
              # Prefer√™ncias essenciais
              prefs = {'AndroidPersistentFileLocation':'Compatibility', 'AllowFileAccess':'true', 'AndroidInsecureFileModeEnabled': 'true'}
              for k,v in prefs.items():
                  found = False
                  for p in root.findall('{http://www.w3.org/ns/widgets}preference'):
                      if p.get('name') == k: p.set('value',v); found=True
                  if not found:
                      el = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
                      el.set('name',k); el.set('value',v)
                      
              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
              print("‚úÖ XML Ajustado.")
          except Exception as e:
              print(f"‚ùå Erro XML: {e}"); exit(1)
          EOF
          python3 edit.py

      # --- 5. PLATAFORMA ---
      - name: üîå Adicionando Android
        run: |
          cd app-temp
          # Adiciona plataforma
          cordova platform add android@12.0.0
          cordova plugin add cordova-plugin-ionic-webview
          
          # Prepara arquivos (cria o build.gradle)
          cordova prepare android

      # --- 6. INJE√á√ÉO DE √çCONES (FIND) ---
      - name: üé® Injetando √çcones
        run: |
          cd app-temp
          ICON="www/icon.png"
          if [ -f "$ICON" ]; then
             echo "‚úÖ √çcone detectado. Injetando..."
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher.png \;
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher_round.png \;
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher_foreground.png \;
          else
             echo "‚ö†Ô∏è √çcone n√£o enviado."
          fi

      # --- 7. INJE√á√ÉO NO GRADLE (ID FIX) ---
      - name: üíâ Inje√ß√£o ID no Gradle
        run: |
          cd app-temp
          GRADLE=$(find platforms/android -name "build.gradle" | grep "app/build.gradle" | head -n 1)
          
          if [ -f "$GRADLE" ]; then
             echo "üîß Configurando Gradle: $GRADLE"
             sed -i 's/applicationId ".*"/applicationId "${{ env.APP_ID }}"/' "$GRADLE"
             sed -i 's/namespace ".*"/namespace "${{ env.APP_ID }}"/' "$GRADLE"
          else
             echo "‚ö†Ô∏è ERRO: build.gradle n√£o encontrado."
          fi

      # --- 8. BUILD ---
      - name: üì± Compilando APK
        id: build_apk
        run: |
          cd app-temp
          
          # Garante configs no properties
          echo "android.useAndroidX=true" >> platforms/android/gradle.properties
          echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          
          # Compila
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
             echo "STATUS=FALHA" >> $GITHUB_ENV
             exit 1
          else
             SAFE=$(echo "${{ env.APP_NAME }}" | sed 's/[^a-zA-Z0-9]/_/g')
             FINAL="App_${SAFE}_v${{ env.APP_VER }}.apk"
             mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL"
             echo "APK_FINAL=$FINAL" >> $GITHUB_ENV
             echo "STATUS=SUCESSO" >> $GITHUB_ENV
          fi

      # --- 9. RELEASE ---
      - name: üöÄ Publicar
        uses: softprops/action-gh-release@v1
        if: env.STATUS == 'SUCESSO'
        with:
          tag_name: v${{ github.run_number }}
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 10. NOTIFICA√á√ÉO FINAL (PYTHON) ---
      - name: üîî Discord (Fim)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat <<EOF > notify_end.py
          import os, json, urllib.request
          webhook = os.environ.get('DISCORD_WEBHOOK')
          status = os.environ.get('STATUS')
          
          if status == 'SUCESSO':
              color = 5763712
              title = "‚úÖ SUCESSO: APK PRONTO"
              desc = f"App: {os.environ.get('APP_NAME')}\n[Baixar Aqui](https://github.com/{os.environ.get('GITHUB_REPOSITORY')}/releases/tag/v{os.environ.get('GITHUB_RUN_NUMBER')})"
          else:
              color = 15548997
              title = "‚ùå FALHA CR√çTICA"
              desc = "O build falhou. Verifique os logs do GitHub."
              
          msg = {
              "username": "F√°brica Titan ü§ñ",
              "embeds": [{ "title": title, "description": desc, "color": color }]
          }
          
          try:
              req = urllib.request.Request(webhook, data=json.dumps(msg).encode(), headers={'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'})
              urllib.request.urlopen(req)
          except: pass
          EOF
          python3 notify_end.py
