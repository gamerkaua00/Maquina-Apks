name: F√°brica Turbo V27 (Compact + Discord Pro) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions: { contents: write }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Setup Ambiente
        uses: actions/checkout@v3
      
      - name: ‚ö° Cache & Java
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17', cache: 'gradle' }

      - name: üõ†Ô∏è Setup Gradle & SDK
        uses: gradle/actions/setup-gradle@v3
        with: { gradle-version: '8.7' }

      - name: ‚öôÔ∏è Instala√ß√£o Core
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      - name: üèóÔ∏è Constru√ß√£o do Projeto (All-in-One)
        run: |
          # 1. Cria√ß√£o
          cordova create app-temp com.kaua.app "Seu App"
          rm -rf app-temp/www/* && cp -r www/* app-temp/www/
          [ -f config.xml ] && cp config.xml app-temp/
          
          cd app-temp
          
          # 2. Assets (√çcone/Splash)
          ICON=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" \) | head -n 1)
          [ -n "$ICON" ] && cp "$ICON" ./icon.png && sed -i '/<icon/d' config.xml && sed -i '/<widget/a \    <icon src="icon.png" />' config.xml
          SPLASH=$(find www -maxdepth 1 -type f -iname "splash.png" | head -n 1)
          [ -n "$SPLASH" ] && cp "$SPLASH" ./splash.png && sed -i '/<widget/a \    <splash src="splash.png" />' config.xml
          
          # 3. Configura√ß√µes de Permiss√£o
          sed -i '/<widget/a \    <preference name="AndroidPersistentFileLocation" value="Compatibility" />' config.xml
          sed -i '/<widget/a \    <preference name="AllowFileAccess" value="true" />' config.xml
          sed -i '/<widget/a \    <preference name="requestLegacyExternalStorage" value="true" />' config.xml
          
          # 4. Plugins
          cordova platform add android@12.0.0
          cordova plugin remove cordova-plugin-whitelist || true
          PLUGINS="cordova-plugin-ionic-webview cordova-plugin-device cordova-plugin-dialogs cordova-plugin-android-permissions cordova-plugin-inappbrowser cordova-plugin-file cordova-plugin-filepath cordova-plugin-androidx-adapter"
          for p in $PLUGINS; do cordova plugin add $p; done
          
          # Plugins Opcionais (Features JSON)
          if [ -f "../features.json" ]; then
            # ID/Vers√£o
            CID=$(jq -r '.packageId // empty' ../features.json); [ ! -z "$CID" ] && sed -i "s/id=\"[^\"]*\"/id=\"$CID\"/" config.xml
            CVER=$(jq -r '.version // empty' ../features.json); [ ! -z "$CVER" ] && sed -i "s/version=\"[^\"]*\"/version=\"$CVER\"/" config.xml
            
            # Instala√ß√£o Condicional Compacta
            declare -A P=( ["vibration"]="cordova-plugin-vibration" ["camera"]="cordova-plugin-camera" ["geolocation"]="cordova-plugin-geolocation" ["battery"]="cordova-plugin-battery-status" ["network"]="cordova-plugin-network-information" ["orientation"]="cordova-plugin-screen-orientation" ["fullscreen"]="cordova-plugin-fullscreen" ["flashlight"]="cordova-plugin-flashlight" ["toast"]="cordova-plugin-x-toast" ["insomnia"]="cordova-plugin-insomnia" ["statusbar"]="cordova-plugin-statusbar" ["clipboard"]="cordova-plugin-clipboard" ["splashscreen"]="cordova-plugin-splashscreen" ["file"]="cordova-plugin-file-opener2" )
            for k in "${!P[@]}"; do
               if [ "$(jq -r ".$k" ../features.json)" = "true" ]; then cordova plugin add ${P[$k]}; fi
            done
            if [ "$(jq -r '.microphone' ../features.json)" = "true" ]; then cordova plugin add cordova-plugin-media cordova-plugin-media-capture; fi
            if [ "$(jq -r '.notification' ../features.json)" = "true" ]; then cordova plugin add cordova-plugin-local-notification || echo "Skip Notif"; fi
          fi

      - name: üì± Compila√ß√£o & Fix (Gradle)
        run: |
          cd app-temp
          # Fix Gradle Antigo
          if [ -d "platforms/android" ]; then
            find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
            echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
          fi
          
          # Build
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          # Renomear e Mover
          APP_NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
          SAFE_NAME=$(echo "$APP_NAME" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          [ -z "$APK_PATH" ] && exit 1 || mv "$APK_PATH" "$GITHUB_WORKSPACE/$SAFE_NAME.apk"
          
          # Vari√°veis para pr√≥ximos passos
          echo "APK_FINAL=$SAFE_NAME.apk" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

      - name: üöÄ Release & Notifica√ß√£o
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} (v${{ github.run_number }})"
          body: "‚úÖ **App Pronto!** Baixe em Assets."
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üîî Discord Pro Notification
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          COLOR=5763712; TITLE="‚úÖ SUCESSO"; DESC="APK Criado com sucesso!";
          if [ "$STATUS" == "failure" ]; then COLOR=15548997; TITLE="‚ùå FALHA"; DESC="Erro no processamento."; fi
          
          # JSON Embed Formatado para Discord
          curl -H "Content-Type: application/json" -d "{\"embeds\":[{\"title\":\"$TITLE: ${{ env.APP_NAME }}\",\"description\":\"$DESC\",\"color\":$COLOR,\"fields\":[{\"name\":\"Vers√£o\",\"value\":\"v${{ github.run_number }}\",\"inline\":true},{\"name\":\"Link\",\"value\":\"[Baixar no GitHub](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ github.run_number }})\",\"inline\":true}],\"footer\":{\"text\":\"F√°brica Turbo V27\"}}]}" $DISCORD_WEBHOOK
