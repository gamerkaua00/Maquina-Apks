name: F√°brica Turbo V39 (Genesis ID + Python Discord) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. LEITURA "GENESIS" (L√™ antes de criar) ---
      - name: üß† Ler Configura√ß√µes Iniciais
        id: genesis
        run: |
          # Valores Padr√£o
          ID="com.kaua.app"
          NAME="App Turbo"
          VER="1.0.0"
          
          # L√™ do JSON se existir
          if [ -f "features.json" ]; then
             J_ID=$(jq -r '.packageId // empty' features.json)
             J_VER=$(jq -r '.version // empty' features.json)
             if [ ! -z "$J_ID" ]; then ID=$J_ID; fi
             if [ ! -z "$J_VER" ]; then VER=$J_VER; fi
          fi
          
          # L√™ Nome do config.xml antigo (se houver) para manter compatibilidade
          if [ -f "config.xml" ]; then
             X_NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
             if [ ! -z "$X_NAME" ]; then NAME=$X_NAME; fi
          fi
          
          echo "GEN_ID=$ID" >> $GITHUB_ENV
          echo "GEN_NAME=$NAME" >> $GITHUB_ENV
          echo "GEN_VER=$VER" >> $GITHUB_ENV
          
          echo "‚úÖ Configura√ß√£o Genesis Carregada:"
          echo "ID: $ID | Nome: $NAME | Vers√£o: $VER"

      # --- 2. NOTIFICA√á√ÉO PYTHON (RICA E DETALHADA) ---
      - name: üîî Discord (Python Script)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Cria um script Python tempor√°rio para mandar o Embed bonito
          cat <<EOF > notify.py
          import os, json, urllib.request
          
          webhook = os.environ.get('DISCORD_WEBHOOK')
          if not webhook: exit(0)
          
          data = {
            "username": "F√°brica V39 ü§ñ",
            "avatar_url": "https://img.icons8.com/fluency/96/robot-2.png",
            "embeds": [{
              "title": "üè≠ In√≠cio da Fabrica√ß√£o",
              "color": 16776960, # Amarelo
              "fields": [
                {"name": "üì± Aplicativo", "value": "${{ env.GEN_NAME }}", "inline": True},
                {"name": "üÜî Package ID", "value": "\`${{ env.GEN_ID }}\`", "inline": True},
                {"name": "üî¢ Vers√£o", "value": "${{ env.GEN_VER }}", "inline": True},
                {"name": "üë§ Autor", "value": "${{ github.actor }}", "inline": True}
              ],
              "footer": {"text": "Nova arquitetura Genesis aplicada"}
            }]
          }
          
          # FIX: Adicionado User-Agent para evitar Erro 403 do Discord
          headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
          
          req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers=headers)
          try:
            urllib.request.urlopen(req)
          except Exception as e:
            print(f"Erro ao enviar notifica√ß√£o: {e}")
          EOF
          
          python3 notify.py

      # --- SETUP AMBIENTE ---
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üî® Instalar Gradle 8.7 (Manual)
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH

      - name: üõ†Ô∏è Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 3. CRIA√á√ÉO COM ID REAL ---
      - name: üèóÔ∏è Criando App (ID Nativo)
        run: |
          echo "üöÄ Criando projeto j√° com o ID: ${{ env.GEN_ID }}"
          
          # AQUI √â O PULO DO GATO: O app nasce com o ID certo
          cordova create app-temp ${{ env.GEN_ID }} "${{ env.GEN_NAME }}"
          
          # Copia o site
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/
          
          cd app-temp
          # Configura vers√£o no config.xml gerado
          sed -i "s/version=\"1.0.0\"/version=\"${{ env.GEN_VER }}\"/" config.xml
          
          # Permiss√µes
          sed -i '/<widget/a \    <preference name="AndroidPersistentFileLocation" value="Compatibility" />' config.xml
          sed -i '/<widget/a \    <preference name="AllowFileAccess" value="true" />' config.xml
          sed -i '/<widget/a \    <preference name="requestLegacyExternalStorage" value="true" />' config.xml

      - name: üîå Plugins e Plataforma
        run: |
          cd app-temp
          
          # Plugins Base
          cordova plugin remove cordova-plugin-whitelist || true
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          if [ -f "../features.json" ]; then
            USE_VIBRA=$(jq -r '.vibration' ../features.json)
            USE_CAM=$(jq -r '.camera' ../features.json)
            USE_GPS=$(jq -r '.geolocation' ../features.json)
            USE_BATTERY=$(jq -r '.battery' ../features.json)
            USE_FULL=$(jq -r '.fullscreen' ../features.json)
            USE_FLASH=$(jq -r '.flashlight' ../features.json)
            USE_MIC=$(jq -r '.microphone' ../features.json)
            USE_INSOMNIA=$(jq -r '.insomnia' ../features.json)
            USE_TOAST=$(jq -r '.toast' ../features.json)
            USE_FILE=$(jq -r '.file' ../features.json)
            USE_CLIP=$(jq -r '.clipboard' ../features.json)
            USE_SPLASH=$(jq -r '.splashscreen' ../features.json)

            if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; fi
            if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; fi
            if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
            if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
            if [ "$USE_FULL" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
            if [ "$USE_FLASH" = "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
            if [ "$USE_TOAST" = "true" ]; then cordova plugin add cordova-plugin-x-toast; fi
            if [ "$USE_INSOMNIA" = "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
            if [ "$USE_FILE" = "true" ]; then cordova plugin add cordova-plugin-file-opener2; fi
            if [ "$USE_CLIP" = "true" ]; then cordova plugin add cordova-plugin-clipboard; fi
            if [ "$USE_SPLASH" = "true" ]; then cordova plugin add cordova-plugin-splashscreen; fi
            
            if [ "$USE_MIC" = "true" ]; then cordova plugin add cordova-plugin-media cordova-plugin-media-capture; fi
          fi

          echo "üì± Adicionando Plataforma..."
          cordova platform add android@12.0.0
          
          echo "üèóÔ∏è For√ßando Prepare..."
          cordova prepare android || true
          
          # Fix API.js se necess√°rio
          if [ -d "platforms/android/cordova" ]; then
             cd platforms/android
             npm install --production --no-save
             cd ../..
          fi

      # --- 4. √çCONE NUCLEAR (SUBSTITUI√á√ÉO F√çSICA) ---
      - name: üî® Injetar √çcone (Modo Nuclear)
        run: |
          cd app-temp
          # Procura √≠cone em www
          ICON_FILE=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" \) | head -n 1)
          
          if [ -n "$ICON_FILE" ]; then
             echo "üî• √çcone encontrado: $ICON_FILE"
             
             # Caminho onde o Android guarda os recursos reais
             RES="platforms/android/app/src/main/res"
             
             # Se a pasta res existir, vamos substituir TODOS os √≠cones padr√£o
             if [ -d "$RES" ]; then
                 echo "üëä Substituindo arquivos nativos..."
                 
                 # Lista de pastas de densidade
                 FOLDERS="mipmap-ldpi mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi drawable"
                 
                 for folder in $FOLDERS; do
                     mkdir -p "$RES/$folder"
                     # Sobrescreve o √≠cone padr√£o do Android (ic_launcher)
                     cp "$ICON_FILE" "$RES/$folder/ic_launcher.png"
                     # Sobrescreve √≠cone redondo se existir
                     cp "$ICON_FILE" "$RES/$folder/ic_launcher_round.png"
                 done
                 echo "‚úÖ √çcones substitu√≠dos com sucesso no sistema de arquivos."
             fi
          else
             echo "‚ö†Ô∏è Nenhum √≠cone encontrado para inje√ß√£o nuclear."
          fi
          
          # Configura Splash no config.xml se existir
          SPLASH_FILE=$(find www -maxdepth 1 -type f -iname "splash.png" | head -n 1)
          if [ -n "$SPLASH_FILE" ]; then
             cp "$SPLASH_FILE" ./splash.png
             sed -i '/<platform name="android">/a \        <splash src="splash.png" />' config.xml
             sed -i '/<widget/a \    <preference name="ShowSplashScreen" value="true" />' config.xml
          fi

      - name: üöë Fix Gradle (Cirurgia)
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              # Troca compile por implementation
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              
              # For√ßa vers√£o 33 do SDK
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
              
              # Bloqueia Gradle 9
              if [ -f "platforms/android/gradle/wrapper/gradle-wrapper.properties" ]; then
                  sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.7-all.zip|g' platforms/android/gradle/wrapper/gradle-wrapper.properties
              fi
          fi

      - name: üì± Build APK
        run: |
          cd app-temp
          # N√ÉO limpar cache para aproveitar o Gradle 8.7
          
          echo "üöÄ Compilando..."
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå ERRO: APK n√£o encontrado!"
            exit 1
          else
            # Usa o nome do App para o arquivo (limpa espa√ßos)
            SAFE_NAME=$(echo "${{ env.GEN_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$SAFE_NAME.apk"
            echo "APK_FINAL=$SAFE_NAME.apk" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.GEN_NAME }} (v${{ github.run_number }})"
          body: |
            ‚úÖ **App Pronto!**
            üì± **Nome:** ${{ env.GEN_NAME }}
            üÜî **ID:** `${{ env.GEN_ID }}`
            
            üì• **BAIXAR AGORA:**
            Clique no arquivo `.apk` listado abaixo em **Assets**.
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîî Discord (Fim - Python)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          cat <<EOF > notify_end.py
          import os, json, urllib.request
          
          webhook = os.environ.get('DISCORD_WEBHOOK')
          status = os.environ.get('STATUS')
          apk_name = os.environ.get('APK_FINAL', 'App')
          
          color = 5763712 if status == 'success' else 15548997
          title = "‚úÖ Sucesso!" if status == 'success' else "‚ùå Falha na F√°brica"
          
          repo = "${{ github.repository }}"
          run_id = "${{ github.run_number }}"
          dl_link = f"https://github.com/{repo}/releases/tag/v{run_id}"
          
          desc = f"O APK **{apk_name}** foi gerado." if status == 'success' else "Ocorreu um erro no processo."
          
          data = {
            "username": "F√°brica Bot ü§ñ",
            "avatar_url": "https://img.icons8.com/fluency/96/robot-2.png",
            "embeds": [{
              "title": title,
              "description": desc,
              "color": color,
              "fields": [
                {"name": "üì• Download", "value": f"[Baixar APK]({dl_link})", "inline": True},
                {"name": "üìÑ Logs", "value": f"[Ver Console](${{ github.server_url }}/{repo}/actions/runs/${{ github.run_id }})", "inline": True}
              ]
            }]
          }
          
          # FIX: User-Agent adicionado
          headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
          
          if webhook:
              req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers=headers)
              try:
                urllib.request.urlopen(req)
              except Exception as e:
                print(f"Erro Discord: {e}")
          EOF
          
          python3 notify_end.py
