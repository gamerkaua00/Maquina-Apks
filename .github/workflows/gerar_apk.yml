name: F√°brica Turbo V45 (Fix Icon & ID Force) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
  repository_dispatch:
    types: [build_app]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. CONFIGURA√á√ÉO DE VARI√ÅVEIS ---
      - name: üß† Processando Dados (Python Seguro)
        id: dados
        run: |
          cat <<EOF > ler_dados.py
          import json, os
          
          def get_val(key, default):
              try:
                  with open('features.json') as f:
                      data = json.load(f)
                      return data.get(key, default)
              except:
                  return default
          
          appid = get_val('packageId', 'com.fabrica.app')
          appver = get_val('version', '1.0.0')
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={appid}\n")
              f.write(f"APP_VER={appver}\n")
          EOF
          python3 ler_dados.py
          
          APP_NAME="App Turbo"
          if [ -f config.xml ]; then
             NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
             if [ ! -z "$NAME" ]; then APP_NAME="$NAME"; fi
          fi
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

      # --- 2. NOTIFICA√á√ÉO INICIAL ---
      - name: üîî Discord (In√≠cio)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat <<EOF > notify_start.py
          import os, json, urllib.request
          
          webhook = os.environ.get('DISCORD_WEBHOOK')
          if not webhook: exit(0)
          
          data = {
            "username": "F√°brica Bot ü§ñ",
            "avatar_url": "https://img.icons8.com/fluency/96/robot-2.png",
            "content": "@everyone üè≠ **Nova ordem de produ√ß√£o recebida!**",
            "embeds": [{
              "title": "‚öôÔ∏è Iniciando Compila√ß√£o",
              "color": 16776960,
              "fields": [
                {"name": "üì± App", "value": "${{ env.APP_NAME }}", "inline": True},
                {"name": "üÜî ID", "value": "\`${{ env.APP_ID }}\`", "inline": True},
                {"name": "üî¢ Vers√£o", "value": "${{ env.APP_VER }}", "inline": True},
                {"name": "üë§ Autor", "value": "${{ github.actor }}", "inline": True}
              ],
              "footer": {"text": "F√°brica V45 Enterprise"}
            }]
          }
          
          headers = {'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'}
          try:
              req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers=headers)
              urllib.request.urlopen(req)
          except Exception as e:
              print(f"Erro Discord: {e}")
          EOF
          python3 notify_start.py

      # --- 3. SETUP DE AMBIENTE (FIX GRADLE 9) ---
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üî® For√ßar Gradle 8.7 (Downgrade Manual)
        run: |
          echo "Baixando Gradle 8.7 para substituir vers√£o 9 do sistema..."
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH
          
          # Verifica se funcionou
          $PWD/gradle-8.7/bin/gradle -v

      - name: üõ†Ô∏è Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 4. CRIA√á√ÉO E CONFIGURA√á√ÉO (CORRIGIDO) ---
      - name: üèóÔ∏è Criando App (ID For√ßado via SED)
        run: |
          echo "Criando projeto base..."
          cordova create app-temp ${{ env.APP_ID }} "${{ env.APP_NAME }}"
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/

          cd app-temp
          # Se tiver config.xml personalizado, copia ele
          if [ -f "../config.xml" ]; then cp "../config.xml" .; fi

          # --- FIX ID E VERS√ÉO (FOR√áA BRUTA) ---
          # Substitui diretamente no texto do arquivo, garantindo que o ID e Vers√£o sejam aplicados
          sed -i 's/widget id="[^"]*"/widget id="${{ env.APP_ID }}"/' config.xml
          sed -i 's/version="[^"]*"/version="${{ env.APP_VER }}"/' config.xml
          
          # Ajuste b√°sico de nome e permiss√µes via Python (mais seguro que sed para XML aninhado)
          cat <<EOF > fix_config_basic.py
          import xml.etree.ElementTree as ET
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          ET.register_namespace('cdv', "http://cordova.apache.org/ns/1.0")
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              
              # Atualiza nome se necess√°rio
              for name in root.findall('{http://www.w3.org/ns/widgets}name'):
                  name.text = '${{ env.APP_NAME }}'

              # Adiciona prefer√™ncias padr√£o
              perms = {
                  'AndroidPersistentFileLocation': 'Compatibility',
                  'AllowFileAccess': 'true',
                  'requestLegacyExternalStorage': 'true'
              }
              for k, v in perms.items():
                  found = False
                  for pref in root.findall('{http://www.w3.org/ns/widgets}preference'):
                      if pref.get('name') == k:
                          pref.set('value', v); found = True
                  if not found:
                      p = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
                      p.set('name', k); p.set('value', v)
              
              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
          except Exception as e:
              print(f"Aviso XML (n√£o cr√≠tico): {e}")
          EOF
          python3 fix_config_basic.py

      # --- 5. PLUGINS E PLATAFORMA ---
      - name: üîå Instalando Plugins
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          
          cordova plugin remove cordova-plugin-whitelist || true
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          if [ -f "../features.json" ]; then
             if [ "$(jq -r '.vibration' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-vibration; fi
             if [ "$(jq -r '.camera' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-camera; fi
             if [ "$(jq -r '.geolocation' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
             if [ "$(jq -r '.battery' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
             if [ "$(jq -r '.fullscreen' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
             if [ "$(jq -r '.flashlight' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
             if [ "$(jq -r '.microphone' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-media cordova-plugin-media-capture; fi
             if [ "$(jq -r '.insomnia' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
             if [ "$(jq -r '.toast' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-x-toast; fi
             if [ "$(jq -r '.file' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-file-opener2; fi
          fi

      # --- 6. INJE√á√ÉO DE √çCONE (NOVO - FIX DEFINITIVO) ---
      - name: üé® Injetando √çcone (Manual)
        run: |
          cd app-temp
          # Script para copiar icon.png da raiz WWW diretamente para as pastas de build do Android
          cat <<EOF > inject_icons.py
          import os, shutil
          
          source_icon = 'www/icon.png'
          # Caminho onde o Cordova gera os recursos Android
          android_res = 'platforms/android/app/src/main/res'
          
          # Todas as densidades de tela
          folders = ['mipmap-mdpi', 'mipmap-hdpi', 'mipmap-xhdpi', 'mipmap-xxhdpi', 'mipmap-xxxhdpi']
          
          if os.path.exists(source_icon):
              print(f"‚úÖ √çcone detectado! Injetando em {android_res}...")
              for folder in folders:
                  target_dir = os.path.join(android_res, folder)
                  if os.path.exists(target_dir):
                      # Substitui o √≠cone padr√£o do Android/Cordova
                      shutil.copy(source_icon, os.path.join(target_dir, 'ic_launcher.png'))
                      shutil.copy(source_icon, os.path.join(target_dir, 'ic_launcher_round.png'))
                      shutil.copy(source_icon, os.path.join(target_dir, 'ic_launcher_foreground.png'))
              print("‚úÖ Inje√ß√£o conclu√≠da.")
          else:
              print("‚ö†Ô∏è AVISO: 'www/icon.png' n√£o encontrado. O App ficar√° com √≠cone padr√£o.")
          EOF
          python3 inject_icons.py

      # --- 7. FIX GRADLE (CIRURGIA) ---
      - name: üöë Fix Gradle (Cirurgia)
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          fi

      # --- 8. BUILD FINAL ---
      - name: üì± Build APK
        id: build_apk
        run: |
          cd app-temp
          rm -rf ~/.gradle/caches/
          
          echo "üöÄ Compilando..."
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "STATUS_BUILD=FALHA" >> $GITHUB_ENV
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            FINAL_NAME="${SAFE_NAME}_v${{ env.APP_VER }}.apk"
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL_NAME"
            FILE_SIZE=$(ls -lh "$GITHUB_WORKSPACE/$FINAL_NAME" | awk '{print $5}')
            
            echo "APK_FINAL=$FINAL_NAME" >> $GITHUB_ENV
            echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
            echo "STATUS_BUILD=SUCESSO" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} v${{ env.APP_VER }}"
          body: |
            ‚úÖ **Build Finalizado com Sucesso!**
            üì± **ID:** `${{ env.APP_ID }}`
            üíæ **Tamanho:** ${{ env.FILE_SIZE }}
            
            üì• **BAIXE O ARQUIVO ABAIXO EM ASSETS**
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # --- 9. NOTIFICA√á√ÉO FINAL ---
      - name: üîî Discord (Fim)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          cat <<EOF > notify_final.py
          import os, json, urllib.request
          
          webhook = os.environ.get('DISCORD_WEBHOOK')
          status = os.environ.get('STATUS')
          apk_name = os.environ.get('APK_FINAL', 'App')
          
          if status == 'success':
              color = 5763712
              title = "‚úÖ SUCESSO: Build Finalizado"
              desc = "O APK foi gerado e publicado na aba Releases."
              
              repo = "${{ github.repository }}"
              tag = "v${{ github.run_number }}"
              filename = os.environ.get('APK_FINAL')
              dl_link = f"https://github.com/{repo}/releases/download/{tag}/{filename}"
              page_link = f"https://github.com/{repo}/releases/tag/{tag}"
              content = "@everyone üéâ **O APK est√° pronto!**"
              
              fields = [
                  {"name": "üì± App", "value": "${{ env.APP_NAME }}", "inline": True},
                  {"name": "üÜî ID", "value": "\`${{ env.APP_ID }}\`", "inline": True},
                  {"name": "üì• Download Direto", "value": f"[Baixar .apk]({dl_link})", "inline": False},
                  {"name": "üìÑ P√°gina de Download", "value": f"[Ver Release]({page_link})", "inline": False}
              ]
          else:
              color = 15548997
              title = "‚ùå FALHA CR√çTICA"
              desc = "O processo de build encontrou um erro."
              content = "@everyone ‚ö†Ô∏è **Erro na produ√ß√£o!**"
              fields = [
                  {"name": "Logs", "value": f"[Ver Console](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"}
              ]
          
          data = {
            "username": "F√°brica Admin üõ°Ô∏è",
            "avatar_url": "https://img.icons8.com/fluency/96/robot-2.png",
            "content": content,
            "embeds": [{
              "title": title,
              "description": desc,
              "color": color,
              "fields": fields,
              "footer": {"text": "Sistema V45 Enterprise"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          
          headers = {'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'}
          try:
            req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers=headers)
            urllib.request.urlopen(req)
          except Exception as e:
            print(f"Erro Discord: {e}")
          EOF
          
          python3 notify_final.py
