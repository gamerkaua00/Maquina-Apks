name: F√°brica Turbo V46 (Sync Panel Fix) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
  repository_dispatch:
    types: [build_app]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. CONFIGURA√á√ÉO DE VARI√ÅVEIS (LENDO DO PAINEL) ---
      - name: üß† Processando Dados
        id: dados
        run: |
          # Script Python para ler o JSON enviado pelo painel com seguran√ßa
          cat <<EOF > ler_dados.py
          import json, os
          
          def get_val(key, default):
              try:
                  with open('features.json') as f:
                      data = json.load(f)
                      return data.get(key, default)
              except:
                  return default
          
          appid = get_val('packageId', 'com.fabrica.app')
          appver = get_val('version', '1.0.0')
          appname = get_val('appName', 'App Turbo')
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={appid}\n")
              f.write(f"APP_VER={appver}\n")
              f.write(f"APP_NAME={appname}\n")
          EOF
          python3 ler_dados.py

      # --- 2. NOTIFICA√á√ÉO ---
      - name: üîî Discord (In√≠cio)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          cat <<EOF > notify_start.py
          import os, json, urllib.request
          
          webhook = os.environ.get('DISCORD_WEBHOOK')
          if not webhook: exit(0)
          
          data = {
            "username": "F√°brica Bot ü§ñ",
            "content": "@everyone üè≠ **Nova ordem de produ√ß√£o!**",
            "embeds": [{
              "title": "‚öôÔ∏è Compilando: ${{ env.APP_NAME }}",
              "color": 16776960,
              "fields": [
                {"name": "üÜî ID", "value": "\`${{ env.APP_ID }}\`", "inline": True},
                {"name": "üî¢ Vers√£o", "value": "${{ env.APP_VER }}", "inline": True}
              ]
            }]
          }
          
          headers = {'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'}
          try:
              req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers=headers)
              urllib.request.urlopen(req)
          except: pass
          EOF
          python3 notify_start.py

      # --- 3. SETUP AMBIENTE ---
      - name: ‚òï Setup Java & Gradle
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üî® For√ßar Gradle 8.7
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH

      - name: üõ†Ô∏è Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 4. CRIA√á√ÉO E CONFIGURA√á√ÉO (FORCE FIX) ---
      - name: üèóÔ∏è Criando App (ID For√ßado)
        run: |
          echo "Criando projeto com ID: ${{ env.APP_ID }}"
          cordova create app-temp ${{ env.APP_ID }} "AppTempName"
          
          # Copia arquivos do site
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/
          
          cd app-temp
          if [ -f "../config.xml" ]; then cp "../config.xml" .; fi

          # --- FOR√áA BRUTA: ID E VERS√ÉO ---
          sed -i 's/widget id="[^"]*"/widget id="${{ env.APP_ID }}"/' config.xml
          sed -i 's/version="[^"]*"/version="${{ env.APP_VER }}"/' config.xml
          
          # --- PYTHON PARA AJUSTAR NOME (XML SEGURO) ---
          cat <<EOF > fix_name.py
          import xml.etree.ElementTree as ET
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              for name in root.findall('{http://www.w3.org/ns/widgets}name'):
                  name.text = '${{ env.APP_NAME }}'
              
              # Configura√ß√µes Padr√£o
              perms = {'AndroidPersistentFileLocation': 'Compatibility', 'AllowFileAccess': 'true'}
              for k, v in perms.items():
                  found = False
                  for pref in root.findall('{http://www.w3.org/ns/widgets}preference'):
                      if pref.get('name') == k: pref.set('value', v); found = True
                  if not found:
                      p = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
                      p.set('name', k); p.set('value', v)

              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
          except: pass
          EOF
          python3 fix_name.py

      # --- 5. PLUGINS ---
      - name: üîå Instalando Plugins
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          cordova plugin add cordova-plugin-ionic-webview
          
          # Plugins opcionais baseados no features.json
          if [ -f "../features.json" ]; then
             if [ "$(jq -r '.vibration' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-vibration; fi
             if [ "$(jq -r '.camera' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-camera; fi
             if [ "$(jq -r '.geolocation' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
             if [ "$(jq -r '.fullscreen' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
             if [ "$(jq -r '.flashlight' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
             if [ "$(jq -r '.microphone' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-media cordova-plugin-media-capture; fi
             if [ "$(jq -r '.insomnia' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
             if [ "$(jq -r '.file' ../features.json)" == "true" ]; then cordova plugin add cordova-plugin-file-opener2; fi
          fi

      # --- 6. INJE√á√ÉO DE √çCONE (FORCE FIX) ---
      - name: üé® Injetando √çcone
        run: |
          cd app-temp
          cat <<EOF > inject_icons.py
          import os, shutil
          source = 'www/icon.png'
          res = 'platforms/android/app/src/main/res'
          folders = ['mipmap-mdpi', 'mipmap-hdpi', 'mipmap-xhdpi', 'mipmap-xxhdpi', 'mipmap-xxxhdpi']
          if os.path.exists(source):
              print(f"‚úÖ Injetando √≠cone...")
              for f in folders:
                  target = os.path.join(res, f)
                  if os.path.exists(target):
                      shutil.copy(source, os.path.join(target, 'ic_launcher.png'))
                      shutil.copy(source, os.path.join(target, 'ic_launcher_round.png'))
          else:
              print("‚ö†Ô∏è √çcone n√£o encontrado em www/icon.png")
          EOF
          python3 inject_icons.py

      # --- 7. BUILD E RELEASE ---
      - name: üì± Build APK
        id: build_apk
        run: |
          cd app-temp
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "STATUS_BUILD=FALHA" >> $GITHUB_ENV
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            FINAL_NAME="${SAFE_NAME}_v${{ env.APP_VER }}.apk"
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL_NAME"
            echo "APK_FINAL=$FINAL_NAME" >> $GITHUB_ENV
            echo "STATUS_BUILD=SUCESSO" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} v${{ env.APP_VER }}"
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîî Discord (Fim)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          cat <<EOF > notify_final.py
          import os, json, urllib.request
          webhook = os.environ.get('DISCORD_WEBHOOK')
          status = os.environ.get('STATUS')
          if status == 'success':
              content = "‚úÖ **Sucesso!** APK Dispon√≠vel na aba Releases."
          else:
              content = "‚ùå **Falha!** Verifique os logs."
          
          data = {"content": content}
          headers = {'Content-Type': 'application/json'}
          try:
            req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers=headers)
            urllib.request.urlopen(req)
          except: pass
          EOF
          python3 notify_final.py
