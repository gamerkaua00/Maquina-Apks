name: F√°brica Turbo V41 (Python XML Fix + Admin Dashboard) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL: "https://services.gradle.org/distributions/gradle-8.7-all.zip"
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"

    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. SETUP DE AMBIENTE ---
      - name: ‚òï Setup Java & Gradle
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üõ†Ô∏è Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 2. PREPARA√á√ÉO DE DADOS ---
      - name: üß† Processando Dados (Python)
        id: dados
        run: |
          # Script Python para ler JSON com seguran√ßa
          cat <<EOF > ler_dados.py
          import json, os
          
          def get_val(key, default):
              try:
                  with open('features.json') as f:
                      data = json.load(f)
                      return data.get(key, default)
              except:
                  return default
          
          # Define vari√°veis para o GitHub Action usar
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={get_val('packageId', 'com.fabrica.app')}\n")
              f.write(f"APP_VER={get_val('version', '1.0.0')}\n")
              # Nome vem do config.xml se existir, sen√£o usa padr√£o
              f.write(f"APP_NAME=App Turbo\n") 
          EOF
          python3 ler_dados.py
          
          # Tenta pegar nome do config.xml antigo se existir
          if [ -f config.xml ]; then
             NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
             if [ ! -z "$NAME" ]; then echo "APP_NAME=$NAME" >> $GITHUB_ENV; fi
          fi

      - name: üîî Discord (Status: Iniciando)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"username\": \"F√°brica Admin üõ°Ô∏è\", \"embeds\":[{\"title\": \"üü° Iniciando Build: ${{ env.APP_NAME }}\", \"description\": \"üÜî \`${{ env.APP_ID }}\`\\nüî¢ v${{ env.APP_VER }}\", \"color\": 16776960}]}" \
          $DISCORD_WEBHOOK

      # --- 3. CRIA√á√ÉO DO PROJETO ---
      - name: üèóÔ∏è Criando Estrutura
        run: |
          echo "Criando projeto com ID: ${{ env.APP_ID }}"
          cordova create app-temp ${{ env.APP_ID }} "${{ env.APP_NAME }}"
          
          # Limpa www padr√£o e copia o do usu√°rio
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/

      # --- 4. MANIPULA√á√ÉO XML (M√âTODO NOVO: PYTHON ELEMENTTREE) ---
      # Este m√©todo √© muito mais seguro que SED. Ele edita a estrutura do XML real.
      - name: üîß Configura√ß√£o Cir√∫rgica (XML)
        run: |
          cd app-temp
          
          # Prepara √≠cone se existir
          HAS_ICON="false"
          ICON_SRC=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" \) | head -n 1)
          if [ -n "$ICON_SRC" ]; then
             cp "$ICON_SRC" res_icon.png
             HAS_ICON="true"
          fi
          
          # Prepara Splash
          HAS_SPLASH="false"
          SPLASH_SRC=$(find www -maxdepth 1 -type f -iname "splash.png" | head -n 1)
          if [ -n "$SPLASH_SRC" ]; then
             cp "$SPLASH_SRC" res_splash.png
             HAS_SPLASH="true"
          fi

          # Script Python para editar o config.xml
          cat <<EOF > edit_xml.py
          import xml.etree.ElementTree as ET
          
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          ET.register_namespace('cdv', "http://cordova.apache.org/ns/1.0")
          
          tree = ET.parse('config.xml')
          root = tree.getroot()
          
          # 1. For√ßa ID e Vers√£o
          root.set('id', '${{ env.APP_ID }}')
          root.set('version', '${{ env.APP_VER }}')
          
          # 2. For√ßa Nome
          for name in root.findall('{http://www.w3.org/ns/widgets}name'):
              name.text = '${{ env.APP_NAME }}'
          
          # 3. Adiciona √çcone (Se tiver)
          if "$HAS_ICON" == "true":
              # Remove antigos
              for icon in root.findall('{http://www.w3.org/ns/widgets}icon'):
                  root.remove(icon)
              # Adiciona novo
              icon = ET.SubElement(root, '{http://www.w3.org/ns/widgets}icon')
              icon.set('src', 'res_icon.png')
          
          # 4. Adiciona Splash (Se tiver)
          if "$HAS_SPLASH" == "true":
              splash = ET.SubElement(root, '{http://www.w3.org/ns/widgets}splash')
              splash.set('src', 'res_splash.png')
              
              pref = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
              pref.set('name', 'ShowSplashScreen')
              pref.set('value', 'true')

          # 5. Permiss√µes
          perms = [
              ('AndroidPersistentFileLocation', 'Compatibility'),
              ('AllowFileAccess', 'true'),
              ('requestLegacyExternalStorage', 'true')
          ]
          for p in perms:
              pref = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
              pref.set('name', p[0])
              pref.set('value', p[1])

          tree.write('config.xml', encoding='utf-8', xml_declaration=True)
          print("‚úÖ XML Editado com Sucesso via Python")
          EOF
          
          python3 edit_xml.py
          cat config.xml # Mostra no log para confer√™ncia

      # --- 5. PLUGINS ---
      - name: üîå Instalando Plugins
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          
          # Base
          cordova plugin remove cordova-plugin-whitelist || true
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          # Opcionais via features.json
          if [ -f "../features.json" ]; then
             # (Mantendo a l√≥gica simples de bash para plugins, que funciona bem)
             USE_VIBRA=$(jq -r '.vibration' ../features.json); [ "$USE_VIBRA" = "true" ] && cordova plugin add cordova-plugin-vibration
             USE_CAM=$(jq -r '.camera' ../features.json); [ "$USE_CAM" = "true" ] && cordova plugin add cordova-plugin-camera
             USE_GPS=$(jq -r '.geolocation' ../features.json); [ "$USE_GPS" = "true" ] && cordova plugin add cordova-plugin-geolocation
             USE_BAT=$(jq -r '.battery' ../features.json); [ "$USE_BAT" = "true" ] && cordova plugin add cordova-plugin-battery-status
             USE_FULL=$(jq -r '.fullscreen' ../features.json); [ "$USE_FULL" = "true" ] && cordova plugin add cordova-plugin-fullscreen
             USE_FLASH=$(jq -r '.flashlight' ../features.json); [ "$USE_FLASH" = "true" ] && cordova plugin add cordova-plugin-flashlight
             USE_MIC=$(jq -r '.microphone' ../features.json); [ "$USE_MIC" = "true" ] && cordova plugin add cordova-plugin-media cordova-plugin-media-capture
             USE_INS=$(jq -r '.insomnia' ../features.json); [ "$USE_INS" = "true" ] && cordova plugin add cordova-plugin-insomnia
             USE_TOAST=$(jq -r '.toast' ../features.json); [ "$USE_TOAST" = "true" ] && cordova plugin add cordova-plugin-x-toast
             USE_FILE=$(jq -r '.file' ../features.json); [ "$USE_FILE" = "true" ] && cordova plugin add cordova-plugin-file-opener2
          fi

      - name: üöë Fix Gradle (Cirurgia)
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              # Corrige plugins antigos
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              
              # For√ßa SDK 33
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          fi

      - name: üì± Build APK
        id: build_apk
        run: |
          cd app-temp
          rm -rf ~/.gradle/caches/
          
          # Inicia cron√¥metro
          START_TIME=$(date +%s)
          
          echo "üöÄ Compilando..."
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          # Finaliza cron√¥metro
          END_TIME=$(date +%s)
          echo "BUILD_TIME=$((END_TIME-START_TIME))s" >> $GITHUB_ENV
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "STATUS_BUILD=FALHA" >> $GITHUB_ENV
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            # Adiciona vers√£o no nome do arquivo
            FINAL_NAME="${SAFE_NAME}_v${{ env.APP_VER }}.apk"
            
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$FINAL_NAME"
            
            # Pega tamanho do arquivo
            FILE_SIZE=$(ls -lh "$GITHUB_WORKSPACE/$FINAL_NAME" | awk '{print $5}')
            
            echo "APK_FINAL=$FINAL_NAME" >> $GITHUB_ENV
            echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
            echo "STATUS_BUILD=SUCESSO" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub (Obrigat√≥rio)
        id: create_release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} v${{ env.APP_VER }}"
          body: |
            ‚úÖ **Build Finalizado!**
            üì± **ID:** `${{ env.APP_ID }}`
            üíæ **Tamanho:** ${{ env.FILE_SIZE }}
            
            ‚¨áÔ∏è **BAIXE O ARQUIVO ABAIXO EM ASSETS**
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 6. PAINEL INFORMATIVO DO DISCORD (ADMIN) ---
      - name: üîî Discord Admin (Relat√≥rio Final)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          cat <<EOF > notify_final.py
          import os, json, urllib.request
          
          webhook = os.environ.get('DISCORD_WEBHOOK')
          status = os.environ.get('STATUS')
          
          if status == 'success':
              color = 5763712 # Verde
              title = "‚úÖ SUCESSO: Build Finalizado"
              desc = "O aplicativo foi compilado, assinado (debug) e publicado."
              
              # Monta link direto do asset (Tentativa de prever o link)
              repo = "${{ github.repository }}"
              tag = "v${{ github.run_number }}"
              filename = os.environ.get('APK_FINAL')
              # Link oficial da release
              dl_link = f"https://github.com/{repo}/releases/download/{tag}/{filename}"
              page_link = f"https://github.com/{repo}/releases/tag/{tag}"
              
              fields = [
                  {"name": "üì± App", "value": "${{ env.APP_NAME }}", "inline": True},
                  {"name": "üÜî ID", "value": "\`${{ env.APP_ID }}\`", "inline": True},
                  {"name": "üíæ Tamanho", "value": "${{ env.FILE_SIZE }}", "inline": True},
                  {"name": "‚è±Ô∏è Tempo", "value": "${{ env.BUILD_TIME }}", "inline": True},
                  {"name": "üì• Download Direto", "value": f"[Baixar .apk]({dl_link})", "inline": False},
                  {"name": "üìÑ P√°gina de Download", "value": f"[Ver Release]({page_link})", "inline": False}
              ]
          else:
              color = 15548997 # Vermelho
              title = "‚ùå FALHA CR√çTICA"
              desc = "O processo de build encontrou um erro e foi abortado."
              fields = [
                  {"name": "Logs", "value": f"[Ver Console de Erro](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"}
              ]
          
          data = {
            "username": "F√°brica Admin üõ°Ô∏è",
            "avatar_url": "https://img.icons8.com/fluency/96/robot-2.png",
            "embeds": [{
              "title": title,
              "description": desc,
              "color": color,
              "fields": fields,
              "footer": {"text": "Sistema V41 Enterprise"},
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          
          req = urllib.request.Request(webhook, data=json.dumps(data).encode('utf-8'), headers={'Content-Type': 'application/json', 'User-Agent': 'Mozilla/5.0'})
          try: urllib.request.urlopen(req)
          except: pass
          EOF
          python3 notify_final.py
