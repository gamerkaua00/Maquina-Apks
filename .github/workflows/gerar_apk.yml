name: F√°brica Inteligente v3.2 (Corre√ß√£o de Depend√™ncias) üõ°Ô∏è

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Baixando C√≥digo
      uses: actions/checkout@v3

    - name: ‚òï Configurando Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: üì¶ Instalando Cordova
      run: |
        npm install -g cordova

    - name: üèóÔ∏è Criando a Base do App
      run: |
        cordova create app-temp com.kaua.app "Seu App"
        rm -rf app-temp/www/*
        cp -r www/* app-temp/www/

    - name: üé® Configurando √çcone
      run: |
        cd app-temp
        if [ -f "www/icon.png" ]; then
          echo "üî• √çcone encontrado!"
          cp www/icon.png .
          sed -i '/<content src="index.html" \/>/a <icon src="icon.png" />' config.xml
        fi

    - name: üîå Instalando Plugins
      run: |
        cd app-temp
        cordova platform add android
        
        # Plugins Base
        cordova plugin add cordova-plugin-ionic-webview
        cordova plugin add cordova-plugin-device
        cordova plugin add cordova-plugin-dialogs

        # Leitura do features.json
        if [ -f "../features.json" ]; then
          USE_NOTIF=$(jq -r '.notification' ../features.json)
          USE_VIBRA=$(jq -r '.vibration' ../features.json)
          USE_CAM=$(jq -r '.camera' ../features.json)
          USE_GPS=$(jq -r '.geolocation' ../features.json)
          USE_BATTERY=$(jq -r '.battery' ../features.json)
          USE_NETWORK=$(jq -r '.network' ../features.json)
          USE_ORIENT=$(jq -r '.orientation' ../features.json)
          USE_FULLSCREEN=$(jq -r '.fullscreen' ../features.json)

          if [ "$USE_NOTIF" = "true" ]; then cordova plugin add cordova-plugin-local-notification || echo "Skip Notif"; fi
          if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; fi
          if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; fi
          if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
          if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
          if [ "$USE_NETWORK" = "true" ]; then cordova plugin add cordova-plugin-network-information; fi
          if [ "$USE_ORIENT" = "true" ]; then cordova plugin add cordova-plugin-screen-orientation; fi
          if [ "$USE_FULLSCREEN" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
        fi

    - name: üßπ Limpando Cache do Gradle (Corre√ß√£o de Erro 403)
      run: |
        cd app-temp
        # For√ßa limpeza para evitar depend√™ncias corrompidas ou bloqueadas
        cordova clean android
        rm -rf ~/.gradle/caches/

    - name: üì± Compilando e Rastreando APK
      run: |
        cd app-temp
        # Compila
        cordova build android --debug -- --gradleArg=-PcdvMinSdkVersion=24 --packageType=apk
        
        echo "üîç Procurando o APK gerado em todo o workspace..."
        # O comando find procura o arquivo em todo o diretorio do github workspace
        APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
        
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå ERRO CR√çTICO: O arquivo app-debug.apk n√£o foi encontrado!"
          # Debug: Lista todos os apks encontrados para ajudar no diagn√≥stico
          find "$GITHUB_WORKSPACE" -name "*.apk"
          exit 1
        else
          echo "‚úÖ APK encontrado em: $APK_PATH"
          # Move para a raiz do workspace para facilitar o upload
          mv "$APK_PATH" "$GITHUB_WORKSPACE/app-instalavel.apk"
          echo "üì¶ APK movido para a raiz com sucesso."
        fi

    - name: üöÄ Criar Download Direto (Release)
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ github.run_number }}
        name: "APK Pronto (Vers√£o ${{ github.run_number }})"
        body: "Seu aplicativo foi fabricado com sucesso! Clique no arquivo abaixo para baixar e instalar."
        files: app-instalavel.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
