name: F√°brica Turbo V63 (Mega Pack + Debug) üì°

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
  repository_dispatch:
    types: [build_app]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # --- VARI√ÅVEIS GLOBAIS (FIX PARA SEGREDOS) ---
    env:
      JAVA_HOME: "/usr/lib/jvm/temurin-17-jdk-amd64"
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: üì• C√≥digo
        uses: actions/checkout@v3

      # --- 1. DADOS ---
      - name: üß† Config
        id: dados
        run: |
          if [ -f package.json ]; then mv package.json package.json.bak; fi
          if [ -f config.xml ]; then mv config.xml config.xml.bak; fi
          
          cat <<EOF > ler.py
          import json, os
          try:
              with open('features.json') as f: d = json.load(f)
          except: d = {}
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"APP_ID={d.get('packageId', 'com.fabrica.v63')}\n")
              f.write(f"APP_VER={d.get('version', '1.0.0')}\n")
              f.write(f"APP_NAME={d.get('appName', 'App V63')}\n")
              f.write(f"HAS_SPLASH={d.get('hasSplash', False)}\n")
              f.write(f"OUT_TYPE={d.get('outputType', 'apk')}\n")
              f.write(f"ORIENT={d.get('orientation', 'default')}\n")
          EOF
          python3 ler.py

      # --- 2. NOTIFICA√á√ÉO START (COM DEBUG) ---
      - name: üîî Notificar In√≠cio
        run: |
          cat <<EOF > notify.py
          import os, json, urllib.request, urllib.parse
          
          print("--- DEBUG NOTIFICA√á√ÉO ---")
          
          # Discord
          d_url = os.environ.get('DISCORD_WEBHOOK')
          if d_url:
              print(f"Discord URL: {d_url[:20]}...")
              try:
                  msg = {"content": "@everyone üì° **V63 INICIADA**\nApp: ${{ env.APP_NAME }}"}
                  req = urllib.request.Request(d_url, data=json.dumps(msg).encode(), headers={'Content-Type': 'application/json'})
                  resp = urllib.request.urlopen(req)
                  print(f"Discord Response: {resp.getcode()}")
              except Exception as e: print(f"‚ùå Erro Discord: {e}")
          else: print("‚ö†Ô∏è Discord Webhook n√£o encontrado.")

          # Telegram
          t_token = os.environ.get('TG_TOKEN')
          t_chat = os.environ.get('TG_CHAT')
          if t_token and t_chat:
              print(f"Telegram Token: {t_token[:10]}... Chat: {t_chat}")
              try:
                  text = f"üöÄ <b>F√°brica V63</b>\nCriando: ${{ env.APP_NAME }}\nTipo: ${{ env.OUT_TYPE }}"
                  url = f"https://api.telegram.org/bot{t_token}/sendMessage"
                  data = urllib.parse.urlencode({"chat_id": t_chat, "text": text, "parse_mode": "HTML"}).encode()
                  urllib.request.urlopen(url, data=data)
                  print("Telegram enviado.")
              except Exception as e: print(f"‚ùå Erro Telegram: {e}")
          else: print("‚ö†Ô∏è Telegram Secrets n√£o encontrados.")
          EOF
          python3 notify.py

      # --- 3. SETUP ---
      - name: üõ†Ô∏è Setup
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH

      # --- 4. CRIA√á√ÉO ---
      - name: üèóÔ∏è Criar e Configurar
        run: |
          cordova create app-temp ${{ env.APP_ID }} "TempName"
          cp -r www/* app-temp/www/
          
          cd app-temp
          cat <<EOF > config.py
          import xml.etree.ElementTree as ET, os, json
          ET.register_namespace('', "http://www.w3.org/ns/widgets")
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              root.set('id', os.environ['APP_ID'])
              root.set('version', os.environ['APP_VER'])
              for n in root.findall('{http://www.w3.org/ns/widgets}name'): n.text = os.environ['APP_NAME']
              
              # Configs B√°sicas
              prefs = {'AndroidPersistentFileLocation': 'Compatibility', 'AllowFileAccess': 'true', 'AndroidInsecureFileModeEnabled': 'true'}
              
              # Splash
              if os.environ.get('HAS_SPLASH') == 'True':
                  prefs['SplashScreenDelay'] = '3000'; prefs['ShowSplashScreen'] = 'true'
              else:
                  prefs['SplashScreenDelay'] = '0'; prefs['ShowSplashScreen'] = 'false'

              # Orienta√ß√£o
              orient = os.environ.get('ORIENT', 'default')
              if orient != 'default': prefs['Orientation'] = orient

              for k,v in prefs.items():
                  found = False
                  for p in root.findall('{http://www.w3.org/ns/widgets}preference'):
                      if p.get('name') == k: p.set('value',v); found=True
                  if not found:
                      el = ET.SubElement(root, '{http://www.w3.org/ns/widgets}preference')
                      el.set('name',k); el.set('value',v)

              # ACESSO TOTAL
              for tag in root.findall('{http://www.w3.org/ns/widgets}access'): root.remove(tag)
              for tag in root.findall('{http://www.w3.org/ns/widgets}allow-navigation'): root.remove(tag)
              ET.SubElement(root, '{http://www.w3.org/ns/widgets}access').set('origin', '*')
              ET.SubElement(root, '{http://www.w3.org/ns/widgets}allow-navigation').set('href', '*')
              ET.SubElement(root, '{http://www.w3.org/ns/widgets}allow-intent').set('href', '*')

              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
          except: pass
          EOF
          python3 config.py

      # --- 5. PLATAFORMA ---
      - name: üîå Android
        run: |
          cd app-temp
          cordova platform add android@12.0.0
          cordova plugin add cordova-plugin-ionic-webview

      # --- 6. PLUGINS (MEGA PACK) ---
      - name: üß© Instalando Plugins
        run: |
          cd app-temp
          cat <<EOF > plugins.py
          import json, subprocess
          try:
              with open('../features.json') as f: d = json.load(f)
          except: d = {}
          def i(p): 
              print(f"Instalando: {p}")
              subprocess.run(f"cordova plugin add {p}", shell=True)
          
          # Essenciais
          i("cordova-plugin-network-information") # Checar internet
          i("cordova-plugin-dialogs") # Alertas nativos
          i("cordova-plugin-statusbar") # Barra de status
          i("cordova-plugin-android-permissions") # Permiss√µes
          i("cordova-plugin-whitelist") # Seguran√ßa

          # Opcionais do Painel
          if d.get('notification'): i("cordova-plugin-x-toast")
          if d.get('file'): i("cordova-plugin-file-opener2")
          if d.get('camera'): i("cordova-plugin-camera")
          if d.get('geolocation'): i("cordova-plugin-geolocation")
          if d.get('vibration'): i("cordova-plugin-vibration")
          if d.get('fullscreen'): i("cordova-plugin-fullscreen")
          if d.get('microphone'): i("cordova-plugin-media cordova-plugin-media-capture")
          
          # Novos V63
          if d.get('biometric'): i("cordova-plugin-fingerprint-aio")
          if d.get('share'): i("cordova-plugin-x-socialsharing")
          if d.get('tts'): i("cordova-plugin-tts")
          if d.get('clipboard'): i("cordova-plugin-clipboard")
          if d.get('localNotif'): i("cordova-plugin-local-notification")
          if d.get('keyboard'): i("cordova-plugin-ionic-keyboard")
          
          if d.get('admob'): i(f"cordova-plugin-admob-plus --variable APP_ID_ANDROID={d.get('admobId', 'ca-app-pub-xxx')}")
          EOF
          python3 plugins.py
          cordova prepare android

      # --- 7. FINALIZA√á√ÉO ---
      - name: ‚ò¢Ô∏è Inje√ß√£o Final
        run: |
          cd app-temp
          ICON="www/icon.png"
          SPLASH="www/splash.png"
          
          if [ -f "$ICON" ]; then
             find platforms/android -name "ic_launcher*.xml" -delete
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher.png \;
             find platforms/android -type d -name "mipmap-*" -exec cp "$ICON" {}/ic_launcher_round.png \;
          fi
          if [ -f "$SPLASH" ]; then
             mkdir -p platforms/android/app/src/main/res/drawable
             cp "$SPLASH" platforms/android/app/src/main/res/drawable/screen.png
          fi
          
          cat <<EOF > inject.py
          import re, os
          app_id = os.environ['APP_ID']
          ver = os.environ['APP_VER']
          try:
             p = ver.split('.')
             code = int(p[0])*10000 + int(p[1])*100 + int(p[2])
          except: code=10000
          
          target = None
          for r, d, f in os.walk("platforms/android"):
              if "build.gradle" in f and "app" in r: target = os.path.join(r, "build.gradle"); break
          
          if target:
              with open(target,'r') as f: c=f.read()
              c = re.sub(r'applicationId\s+".*"', f'applicationId "{app_id}"', c)
              c = re.sub(r'namespace\s+".*"', f'namespace "{app_id}"', c)
              c = re.sub(r'versionCode\s+\d+', f'versionCode {code}', c)
              with open(target,'w') as f: f.write(c)
          EOF
          python3 inject.py

      # --- 8. BUILD ---
      - name: üì± Compilar
        id: build_apk
        run: |
          cd app-temp
          echo "android.useAndroidX=true" >> platforms/android/gradle.properties
          echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          
          PKG_TYPE="apk"
          if [ "${{ env.OUT_TYPE }}" == "aab" ]; then PKG_TYPE="bundle"; fi
          
          cordova build android --debug --packageType=$PKG_TYPE -- --gradleArg=-PcdvCompileSdkVersion=33
          
          FILE_PATH=$(find "$GITHUB_WORKSPACE" -type f \( -name "*.apk" -o -name "*.aab" \) | head -n 1)
          if [ -z "$FILE_PATH" ]; then
             echo "STATUS=FALHA" >> $GITHUB_ENV; exit 1
          else
             EXT="${FILE_PATH##*.}"
             SAFE=$(echo "${{ env.APP_NAME }}" | sed 's/[^a-zA-Z0-9]/_/g')
             FINAL="App_${SAFE}_v${{ env.APP_VER }}.${EXT}"
             mv "$FILE_PATH" "$GITHUB_WORKSPACE/$FINAL"
             echo "FINAL_FILE=$FINAL" >> $GITHUB_ENV
             echo "STATUS=SUCESSO" >> $GITHUB_ENV
          fi

      # --- 9. RELEASE ---
      - name: üöÄ Release
        uses: softprops/action-gh-release@v1
        if: env.STATUS == 'SUCESSO'
        with:
          tag_name: v${{ github.run_number }}
          files: ${{ env.FINAL_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 10. NOTIFICA√á√ÉO FIM (DEBUG) ---
      - name: üîî Notificar Fim
        if: always()
        run: |
          cat <<EOF > notify_end.py
          import os, json, urllib.request, urllib.parse, sys
          
          status = os.environ.get('STATUS')
          repo = "${{ github.repository }}"
          run_id = "${{ github.run_number }}"
          app_name = os.environ.get('APP_NAME')
          
          print("--- DEBUG FINAL ---")
          
          # Links
          dl_link = f"https://github.com/{repo}/releases/tag/v{run_id}"
          
          # --- DISCORD ---
          d_url = os.environ.get('DISCORD_WEBHOOK')
          if d_url:
              if status == 'SUCESSO':
                  qr = f"https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={dl_link}"
                  embed = {"title": "‚úÖ SUCESSO!", "description": f"**{app_name}**\n[Baixar]({dl_link})", "color": 5763712, "thumbnail": {"url": qr}}
                  msg = {"content": "@everyone APK Pronto!", "embeds": [embed]}
              else:
                  msg = {"content": "@everyone ‚ùå **ERRO CR√çTICO**"}
              try:
                  req = urllib.request.Request(d_url, data=json.dumps(msg).encode(), headers={'Content-Type': 'application/json'})
                  urllib.request.urlopen(req)
                  print("Discord OK")
              except Exception as e: print(f"Erro Discord: {e}")

          # --- TELEGRAM ---
          t_token = os.environ.get('TG_TOKEN')
          t_chat = os.environ.get('TG_CHAT')
          if t_token and t_chat:
              if status == 'SUCESSO':
                  txt = f"‚úÖ <b>APP PRONTO!</b>\n\nüì± <b>{app_name}</b>\nüì• <a href='{dl_link}'>Clique para Baixar</a>"
                  try:
                      fname = os.environ.get('FINAL_FILE')
                      # Tenta mandar arquivo se pequeno
                      if fname and os.path.exists(fname) and os.path.getsize(fname) < 50000000:
                          import subprocess
                          subprocess.run(f'curl -F chat_id="{t_chat}" -F document=@"{fname}" -F caption="{txt}" -F parse_mode="HTML" https://api.telegram.org/bot{t_token}/sendDocument', shell=True)
                          print("Telegram Arquivo OK")
                      else:
                          # Sen√£o manda texto
                          url = f"https://api.telegram.org/bot{t_token}/sendMessage"
                          data = urllib.parse.urlencode({"chat_id": t_chat, "text": txt, "parse_mode": "HTML"}).encode()
                          urllib.request.urlopen(url, data=data)
                          print("Telegram Msg OK")
                  except Exception as e: print(f"Erro Telegram: {e}")
              else:
                   try:
                       url = f"https://api.telegram.org/bot{t_token}/sendMessage"
                       data = urllib.parse.urlencode({"chat_id": t_chat, "text": "‚ùå <b>ERRO</b>", "parse_mode": "HTML"}).encode()
                       urllib.request.urlopen(url, data=data)
                   except: pass
          EOF
          python3 notify_end.py
