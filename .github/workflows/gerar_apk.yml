name: F√°brica V68 (Stable Core)

on:
  push:
    paths:
      - 'features.json'
      - 'www/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # Secrets opcionais para notifica√ß√£o
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: üì• Baixar C√≥digo
        uses: actions/checkout@v4

      # --- CONFIGURA√á√ÉO DO AMBIENTE (MODERNIZADO) ---
      
      - name: ‚òï Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üü¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üõ†Ô∏è Instalar Cordova
        run: npm install -g cordova

      # --- L√ìGICA DE BUILD ---

      - name: üß† Ler Configura√ß√µes (Python)
        id: config
        run: |
          # Script seguro para ler JSON e exportar vari√°veis de ambiente
          cat <<EOF > read_config.py
          import json, os
          try:
              with open('features.json', 'r') as f:
                  data = json.load(f)
          except:
              data = {}
          
          # Mapeamento seguro com valores padr√£o
          env_vars = {
              "APP_ID": data.get('packageId', 'com.v68.app'),
              "APP_VER": data.get('version', '1.0.0'),
              "APP_NAME": data.get('appName', 'V68 App'),
              "HAS_SPLASH": str(data.get('hasSplash', False)),
              "ORIENT": data.get('orientation', 'default'),
              "STATUS_COLOR": data.get('statusBarColor', '#000000')
          }
          
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              for k, v in env_vars.items():
                  f.write(f"{k}={v}\n")
          EOF
          python3 read_config.py

      - name: üèóÔ∏è Criar Projeto Cordova
        run: |
          # Cria o projeto limpo
          cordova create app ${{ env.APP_ID }} "AppV68"
          
          # Copia os arquivos WWW
          cp -r www/* app/www/
          
          # Configura o config.xml via Python
          cd app
          cat <<EOF > update_xml.py
          import xml.etree.ElementTree as ET, os
          
          # Namespace padr√£o do Widget
          NS = "http://www.w3.org/ns/widgets"
          ET.register_namespace('', NS)
          
          try:
              tree = ET.parse('config.xml')
              root = tree.getroot()
              
              # Atributos b√°sicos
              root.set('id', os.environ['APP_ID'])
              root.set('version', os.environ['APP_VER'])
              root.set('xmlns:cdv', 'http://cordova.apache.org/ns/1.0')
              
              # Nome do App
              name_tag = root.find(f'{{{NS}}}name')
              if name_tag is not None: name_tag.text = os.environ['APP_NAME']
              
              # Prefer√™ncias
              def set_pref(name, value):
                  found = False
                  for p in root.findall(f'{{{NS}}}preference'):
                      if p.get('name') == name:
                          p.set('value', value)
                          found = True
                  if not found:
                      el = ET.SubElement(root, f'{{{NS}}}preference')
                      el.set('name', name)
                      el.set('value', value)

              # Configura√ß√µes Android
              set_pref('AndroidXEnabled', 'true')
              set_pref('GradlePluginGoogleServicesEnabled', 'true')
              set_pref('GradlePluginKotlinEnabled', 'true')
              
              # Splash Screen e Cores
              if os.environ.get('HAS_SPLASH') == 'True':
                  set_pref('SplashScreenDelay', '3000')
                  set_pref('ShowSplashScreen', 'true')
                  set_pref('SplashScreen', 'screen')
                  set_pref('SplashScreenSpinnerColor', 'white')
              else:
                  set_pref('SplashScreenDelay', '0')
                  set_pref('ShowSplashScreen', 'false')

              # Orienta√ß√£o e Cor da Barra
              orient = os.environ.get('ORIENT', 'default')
              if orient != 'default': set_pref('Orientation', orient)
              set_pref('StatusBarBackgroundColor', os.environ.get('STATUS_COLOR', '#000000'))
              
              # Permiss√µes de Navega√ß√£o (Allow All)
              for tag in ['access', 'allow-navigation', 'allow-intent']:
                  for existing in root.findall(f'{{{NS}}}{tag}'):
                      root.remove(existing)
                  ET.SubElement(root, f'{{{NS}}}{tag}').set('origin', '*')
                  if tag != 'access':
                      root.find(f'{{{NS}}}{tag}').set('href', '*')

              tree.write('config.xml', encoding='utf-8', xml_declaration=True)
          except Exception as e:
              print(f"Erro XML: {e}")
          EOF
          python3 update_xml.py

      - name: üîå Adicionar Plataforma Android
        run: |
          cd app
          # Android 12.0.0 (API 33) requer Java 11+
          cordova platform add android@12.0.0
          
          # Plugins Base Essenciais
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-statusbar
          cordova plugin add cordova-plugin-screen-orientation
          cordova plugin add cordova-plugin-whitelist

      - name: üß© Instalar Plugins Selecionados
        run: |
          cd app
          cat <<EOF > install_plugins.py
          import json, subprocess
          try:
              with open('../features.json') as f: d = json.load(f)
          except: d = {}

          def add(p):
              print(f"Instalando: {p}")
              subprocess.run(f"cordova plugin add {p}", shell=True)

          if d.get('notification'): add("cordova-plugin-x-toast")
          if d.get('camera'): add("cordova-plugin-camera")
          if d.get('file'): add("cordova-plugin-file-opener2")
          if d.get('geolocation'): add("cordova-plugin-geolocation")
          if d.get('vibration'): add("cordova-plugin-vibration")
          if d.get('microphone'): add("cordova-plugin-media")
          if d.get('flashlight'): add("cordova-plugin-flashlight")
          if d.get('battery'): add("cordova-plugin-battery-status")
          if d.get('insomnia'): add("cordova-plugin-insomnia")
          
          # Plugins Complexos
          if d.get('biometric'): add("cordova-plugin-fingerprint-aio")
          if d.get('share'): add("cordova-plugin-x-socialsharing")
          if d.get('tts'): add("cordova-plugin-tts")
          
          # AdMob (Requer configura√ß√£o de vari√°veis se usado)
          if d.get('admob') and d.get('admobId'):
              add(f"cordova-plugin-admob-plus --variable APP_ID_ANDROID={d.get('admobId')}")

          # Permiss√µes Gen√©ricas
          add("cordova-plugin-android-permissions")
          EOF
          python3 install_plugins.py

      - name: üñºÔ∏è Processar √çcones e Splash
        run: |
          cd app
          
          # Caminhos
          ICON_SRC="../www/icon.png"
          SPLASH_SRC="../www/splash.png"
          RES_DIR="platforms/android/app/src/main/res"
          
          # Inje√ß√£o Bruta de √çcone (Substitui mipmap padr√£o)
          if [ -f "$ICON_SRC" ]; then
             echo "Copiando √≠cones..."
             cp "$ICON_SRC" "$RES_DIR/mipmap-hdpi/ic_launcher.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-mdpi/ic_launcher.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-xhdpi/ic_launcher.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-xxhdpi/ic_launcher.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-xxxhdpi/ic_launcher.png"
             # Vers√£o Round
             cp "$ICON_SRC" "$RES_DIR/mipmap-hdpi/ic_launcher_round.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-mdpi/ic_launcher_round.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-xhdpi/ic_launcher_round.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-xxhdpi/ic_launcher_round.png"
             cp "$ICON_SRC" "$RES_DIR/mipmap-xxxhdpi/ic_launcher_round.png"
          fi
          
          # Inje√ß√£o Splash
          if [ -f "$SPLASH_SRC" ]; then
             echo "Copiando splash..."
             mkdir -p "$RES_DIR/drawable"
             cp "$SPLASH_SRC" "$RES_DIR/drawable/screen.png"
             
             # Cria tema de splash simples via XML para evitar erros
             cat <<XML > "$RES_DIR/drawable/splash_bg.xml"
             <?xml version="1.0" encoding="utf-8"?>
             <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
                 <item android:drawable="@color/cdv_splashscreen_background" />
                 <item>
                     <bitmap android:gravity="center" android:src="@drawable/screen" />
                 </item>
             </layer-list>
             XML
          fi

      - name: üì± Compilar APK
        id: build_step
        run: |
          cd app
          # Prepara (Cordova -> Gradle)
          cordova prepare android
          
          # Build APK (Debug para evitar necessidade de Keysystore)
          cordova build android --debug
          
          # Encontra o arquivo gerado
          APK_PATH=$(find platforms/android/app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          
          if [ -f "$APK_PATH" ]; then
             echo "APK encontrado em: $APK_PATH"
             
             # Renomeia para algo amig√°vel
             SAFE_NAME=$(echo "${{ env.APP_NAME }}" | sed 's/[^a-zA-Z0-9]/_/g')
             NEW_NAME="${SAFE_NAME}_v${{ env.APP_VER }}.apk"
             mv "$APK_PATH" "../$NEW_NAME"
             
             echo "FINAL_APK=$NEW_NAME" >> $GITHUB_ENV
             echo "STATUS=SUCCESS" >> $GITHUB_ENV
          else
             echo "Erro: APK n√£o foi gerado."
             exit 1
          fi

      # --- SA√çDA ---

      - name: üì§ Upload Artifact (Garantia)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FINAL_APK }}
          path: ${{ env.FINAL_APK }}

      - name: üöÄ Criar Release
        uses: softprops/action-gh-release@v1
        if: env.STATUS == 'SUCCESS'
        with:
          tag_name: build-${{ github.run_number }}
          name: "V68: ${{ env.APP_NAME }} (v${{ env.APP_VER }})"
          body: "Compila√ß√£o autom√°tica Titan V68.\nData: $(date)"
          files: ${{ env.FINAL_APK }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
