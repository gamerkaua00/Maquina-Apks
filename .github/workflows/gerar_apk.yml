name: F√°brica Turbo V32 (Admin Discord Logs) üöÄ

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Baixando C√≥digo
        uses: actions/checkout@v3

      # --- 1. LEITURA E CONFIGURA√á√ÉO ---
      - name: üßê Lendo Configura√ß√µes
        id: config
        run: |
          APP_NAME="App Turbo"
          APP_ID="com.kaua.app"
          APP_VER="1.0.0"
          HAS_ICON="‚ùå N√£o"
          
          if [ -f "features.json" ]; then
            JSON_ID=$(jq -r '.packageId // empty' features.json)
            JSON_VER=$(jq -r '.version // empty' features.json)
            if [ ! -z "$JSON_ID" ]; then APP_ID=$JSON_ID; fi
            if [ ! -z "$JSON_VER" ]; then APP_VER=$JSON_VER; fi
          fi

          if [ -f "config.xml" ]; then
             XML_NAME=$(grep -oP '(?<=<name>).*?(?=</name>)' config.xml)
             if [ ! -z "$XML_NAME" ]; then APP_NAME=$XML_NAME; fi
          fi
          
          # Verifica √≠cone na pasta www
          ICON_SOURCE=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" -o -iname "app-icon.png" \) | head -n 1)
          if [ -n "$ICON_SOURCE" ]; then HAS_ICON="‚úÖ Sim"; fi
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_ID=$APP_ID" >> $GITHUB_ENV
          echo "APP_VER=$APP_VER" >> $GITHUB_ENV
          echo "HAS_ICON=$HAS_ICON" >> $GITHUB_ENV

      # --- LOG DE IN√çCIO TURBINADO ---
      - name: üîî Discord Admin (In√≠cio)
        if: env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
          -d "{
            \"username\": \"F√°brica Bot ü§ñ\",
            \"avatar_url\": \"https://img.icons8.com/fluency/96/robot-2.png\",
            \"embeds\": [{
              \"title\": \"üöß Iniciando Produ√ß√£o (Admin Log)\",
              \"description\": \"O usu√°rio **${{ github.actor }}** solicitou um novo build.\",
              \"color\": 16776960,
              \"fields\": [
                { \"name\": \"üì± App\", \"value\": \"${{ env.APP_NAME }}\", \"inline\": true },
                { \"name\": \"üÜî ID\", \"value\": \"\`${{ env.APP_ID }}\`\", \"inline\": true },
                { \"name\": \"üî¢ Vers√£o\", \"value\": \"\`${{ env.APP_VER }}\`\", \"inline\": true },
                { \"name\": \"üñºÔ∏è √çcone?\", \"value\": \"${{ env.HAS_ICON }}\", \"inline\": true },
                { \"name\": \"üîó Repo\", \"value\": \"[Ver Arquivos](${{ github.server_url }}/${{ github.repository }})\", \"inline\": false }
              ],
              \"footer\": { \"text\": \"Run #${{ github.run_number }} ‚Ä¢ V32 Enterprise\" },
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" \
          $DISCORD_WEBHOOK

      - name: ‚òï Setup Java & Gradle
        uses: actions/setup-java@v3
        with: { distribution: 'temurin', java-version: '17' }

      - name: üõ†Ô∏è Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2" "platforms;android-33"
          npm install -g cordova

      # --- 2. CRIA√á√ÉO E CONFIGURA√á√ÉO ---
      - name: üèóÔ∏è Criando App
        run: |
          # Cria projeto base
          cordova create app-temp com.temp.id "TempName"
          
          # Copia site do usu√°rio
          rm -rf app-temp/www/*
          cp -r www/* app-temp/www/
          
          cd app-temp
          
          # 1. FOR√áA O NOME (Substitui tags name)
          sed -i "s|<name>.*</name>|<name>${{ env.APP_NAME }}</name>|g" config.xml
          
          # 2. FOR√áA O ID (Substitui o id="...")
          sed -i "s/id=\"[^\"]*\"/id=\"${{ env.APP_ID }}\"/g" config.xml
          
          # 3. FOR√áA A VERS√ÉO
          sed -i "s/version=\"[^\"]*\"/version=\"${{ env.APP_VER }}\"/g" config.xml
          
          # Permiss√µes
          sed -i '/<widget/a \    <preference name="AndroidPersistentFileLocation" value="Compatibility" />' config.xml
          sed -i '/<widget/a \    <preference name="AllowFileAccess" value="true" />' config.xml
          sed -i '/<widget/a \    <preference name="requestLegacyExternalStorage" value="true" />' config.xml

      - name: üé® Configurando √çcone (Pr√©-Build)
        run: |
          cd app-temp
          # Procura √≠cone na pasta www copiada
          ICON_FILE=$(find www -maxdepth 1 -type f \( -iname "icon.png" -o -iname "logo.png" \) | head -n 1)
          
          # Remove configura√ß√µes antigas
          sed -i '/<icon/d' config.xml
          
          if [ -n "$ICON_FILE" ]; then
            echo "üî• √çcone encontrado! Configurando..."
            cp "$ICON_FILE" ./icon.png
            # Injeta no XML
            sed -i '/<widget/a \    <icon src="icon.png" />' config.xml
          else
            echo "‚ö†Ô∏è Sem √≠cone. Usando padr√£o."
          fi
          
          # Splash
          SPLASH_FILE=$(find www -maxdepth 1 -type f -iname "splash.png" | head -n 1)
          if [ -n "$SPLASH_FILE" ]; then
             cp "$SPLASH_FILE" ./splash.png
             sed -i '/<splash/d' config.xml
             sed -i '/<widget/a \    <splash src="splash.png" />' config.xml
             sed -i '/<widget/a \    <preference name="ShowSplashScreen" value="true" />' config.xml
          fi

      - name: üîå Instalando Plugins
        run: |
          cd app-temp
          # Adiciona plataforma (Isso gera a estrutura Android)
          cordova platform add android@12.0.0
          
          # Plugins Base
          cordova plugin remove cordova-plugin-whitelist || true
          cordova plugin add cordova-plugin-ionic-webview
          cordova plugin add cordova-plugin-device
          cordova plugin add cordova-plugin-dialogs
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-file
          cordova plugin add cordova-plugin-filepath
          cordova plugin add cordova-plugin-androidx-adapter

          # Plugins Opcionais (Features)
          if [ -f "../features.json" ]; then
            USE_VIBRA=$(jq -r '.vibration' ../features.json)
            USE_CAM=$(jq -r '.camera' ../features.json)
            USE_GPS=$(jq -r '.geolocation' ../features.json)
            USE_BATTERY=$(jq -r '.battery' ../features.json)
            USE_FULL=$(jq -r '.fullscreen' ../features.json)
            USE_FLASH=$(jq -r '.flashlight' ../features.json)
            USE_MIC=$(jq -r '.microphone' ../features.json)
            USE_INSOMNIA=$(jq -r '.insomnia' ../features.json)
            USE_TOAST=$(jq -r '.toast' ../features.json)
            USE_FILE=$(jq -r '.file' ../features.json)

            if [ "$USE_VIBRA" = "true" ]; then cordova plugin add cordova-plugin-vibration; fi
            if [ "$USE_CAM" = "true" ]; then cordova plugin add cordova-plugin-camera; fi
            if [ "$USE_GPS" = "true" ]; then cordova plugin add cordova-plugin-geolocation; fi
            if [ "$USE_BATTERY" = "true" ]; then cordova plugin add cordova-plugin-battery-status; fi
            if [ "$USE_FULL" = "true" ]; then cordova plugin add cordova-plugin-fullscreen; fi
            if [ "$USE_FLASH" = "true" ]; then cordova plugin add cordova-plugin-flashlight; fi
            if [ "$USE_TOAST" = "true" ]; then cordova plugin add cordova-plugin-x-toast; fi
            if [ "$USE_INSOMNIA" = "true" ]; then cordova plugin add cordova-plugin-insomnia; fi
            if [ "$USE_FILE" = "true" ]; then cordova plugin add cordova-plugin-file-opener2; fi
            
            if [ "$USE_MIC" = "true" ]; then 
               cordova plugin add cordova-plugin-media cordova-plugin-media-capture
            fi
          fi

      # --- 3. FOR√áA BRUTA (√çCONES NUCLEARES) ---
      - name: üî® Substitui√ß√£o F√≠sica de √çcones
        run: |
          cd app-temp
          if [ -f "icon.png" ]; then
             echo "üëä Esmagando √≠cones padr√£o do Android..."
             # Caminho onde o Android guarda os √≠cones
             RES="platforms/android/app/src/main/res"
             
             # Substitui em TODAS as pastas de densidade (mipmap e drawable)
             for folder in mipmap-ldpi mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi drawable; do
                 mkdir -p "$RES/$folder"
                 cp icon.png "$RES/$folder/ic_launcher.png"
                 cp icon.png "$RES/$folder/icon.png"
             done
             echo "‚úÖ √çcones substitu√≠dos fisicamente no disco."
          fi

      - name: üöë Fix Gradle & Config
        run: |
          cd app-temp
          if [ -d "platforms/android" ]; then
              # Fix Compile/Implementation
              find platforms/android -name "*.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
              
              # Garante ID no AndroidManifest tamb√©m (Seguran√ßa Extra)
              sed -i 's/package="com.temp.id"/package="${{ env.APP_ID }}"/g' platforms/android/app/src/main/AndroidManifest.xml || true
              
              # For√ßa vers√£o SDK 33
              echo "cdvCompileSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvTargetSdkVersion=33" >> platforms/android/gradle.properties
              echo "cdvMinSdkVersion=24" >> platforms/android/gradle.properties
              echo "android.useAndroidX=true" >> platforms/android/gradle.properties
              echo "android.enableJetifier=true" >> platforms/android/gradle.properties
          fi

      - name: üì± Build APK
        run: |
          cd app-temp
          rm -rf ~/.gradle/caches/
          echo "üöÄ Compilando..."
          cordova build android --debug --packageType=apk -- --gradleArg=-PcdvCompileSdkVersion=33
          
          APK_PATH=$(find "$GITHUB_WORKSPACE" -type f -name "app-debug.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå ERRO: APK n√£o encontrado!"
            exit 1
          else
            SAFE_NAME=$(echo "${{ env.APP_NAME }}" | iconv -f utf-8 -t ascii//TRANSLIT | sed 's/[^a-zA-Z0-9]/./g')
            mv "$APK_PATH" "$GITHUB_WORKSPACE/$SAFE_NAME.apk"
            echo "APK_FINAL=$SAFE_NAME.apk" >> $GITHUB_ENV
          fi

      - name: üöÄ Release GitHub (Final)
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: "${{ env.APP_NAME }} (v${{ github.run_number }})"
          body: |
            ‚úÖ **Seu App est√° pronto!**
            
            üì± **Nome:** ${{ env.APP_NAME }}
            üÜî **ID:** `${{ env.APP_ID }}`
            
            üì• **COMO BAIXAR:**
            Clique no arquivo `.apk` listado abaixo em **Assets**.
          files: ${{ env.APK_FINAL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- LOG DE FIM TURBINADO (DISCORD) ---
      - name: üîî Discord Admin (Relat√≥rio Final)
        if: always() && env.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
        run: |
          if [ "$STATUS" == "success" ]; then
            COLOR=5763712
            TITLE="‚úÖ Build Conclu√≠do com Sucesso"
            DESC="O APK foi gerado e publicado na aba Releases."
          else
            COLOR=15548997
            TITLE="‚ùå Falha no Build"
            DESC="Ocorreu um erro durante o processamento. Verifique os logs."
          fi
          
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          DL_LINK="${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
          
          curl -H "Content-Type: application/json" \
          -d "{
            \"username\": \"F√°brica Bot ü§ñ\",
            \"avatar_url\": \"https://img.icons8.com/fluency/96/robot-2.png\",
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"description\": \"$DESC\",
              \"color\": $COLOR,
              \"fields\": [
                { \"name\": \"üì± App\", \"value\": \"${{ env.APP_NAME }}\", \"inline\": true },
                { \"name\": \"üë§ Autor\", \"value\": \"${{ github.actor }}\", \"inline\": true },
                { \"name\": \"üì• Download APK\", \"value\": \"[Clique para Baixar]($DL_LINK)\", \"inline\": false },
                { \"name\": \"üìÑ Logs do Console (Admin)\", \"value\": \"[Ver Logs Completos]($LOG_URL)\", \"inline\": false }
              ],
              \"footer\": { \"text\": \"Finalizado em $(date -u +%H:%M:%S)\" },
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" \
          $DISCORD_WEBHOOK
