<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F√°brica Turbo V6</title>
    
    <!-- ==========================================
         CONFIGURA√á√ÉO PWA (APP INSTAL√ÅVEL)
         ========================================== -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="F√°brica Apps">
    
    <!-- Manifesto Embutido -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZhYnJpY2EgZGUgQXBwcyIsCiAgInNob3J0X25hbWUiOiAiRmFicmljYSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29sb3IiOiAiIzAwMDAwMCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vaW1nLmljb25zOC5jb20vZmx1ZW5jeS8xOTIvcm9ib3QtMi5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pbWcuaWNvbnM4LmNvbS9mbHVlbmN5LzUxMi9yb2JvdC0yLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/robot-2.png">

    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS VISUAIS (NEON & GLASS) --- */
        body { 
            background-color: #000; 
            background-image: radial-gradient(circle at 50% 0%, #0f172a 0%, #000 100%); 
            color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass { 
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.08); 
        }
        
        .neon-text { 
            text-shadow: 0 0 15px rgba(59, 130, 246, 0.5); 
        }

        .neon-border:focus-within {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        
        /* Utilit√°rios de Visualiza√ß√£o */
        .hidden-view { display: none !important; }
        
        /* Anima√ß√£o de Entrada Suave */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        /* Checkbox Customizado Mobile-Friendly */
        .check-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .check-card input:checked + div { 
            border-color: #3b82f6; 
            background: rgba(59, 130, 246, 0.15); 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        .check-card input:checked + div i { 
            color: #60a5fa; 
            transform: scale(1.1); 
        }
        
        /* Anima√ß√£o de Processamento (Loading) */
        .processing { 
            border-color: #22c55e; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } 
        }

        /* Scrollbar Fina e Estilosa */
        .custom-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f0f0f; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    </style>
</head>

<body class="flex flex-col h-[100dvh]">

    <!-- BARRA SUPERIOR PWA (Instalar) -->
    <div id="pwa-install-bar" class="hidden bg-gradient-to-r from-blue-700 to-indigo-600 p-4 shadow-lg z-50 flex justify-between items-center px-6 shrink-0 safe-area-top">
        <div class="flex items-center">
            <i class="fas fa-download mr-3 text-white animate-bounce"></i>
            <span class="text-xs font-bold uppercase tracking-widest text-white">Instalar App</span>
        </div>
        <button onclick="instalarPWA()" class="bg-white text-blue-800 text-[10px] font-bold px-5 py-2 rounded-full shadow-md hover:bg-gray-100 active:scale-95 transition">
            BAIXAR
        </button>
    </div>

    <!-- ==========================================
         VIEW 1: TELA DE LOGIN / CADASTRO
         ========================================== -->
    <div id="view-login" class="flex-1 flex flex-col justify-center items-center p-6 hidden-view overflow-y-auto custom-scroll">
        <div class="glass p-8 rounded-3xl w-full max-w-md text-center shadow-2xl border-t-4 border-blue-500">
            <div class="w-20 h-20 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_30px_rgba(59,130,246,0.2)]">
                <i class="fas fa-user-astronaut text-4xl text-blue-400"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 tracking-tight text-white">Bem-vindo</h1>
            <p class="text-gray-400 text-sm mb-8 font-medium">Conecte sua conta GitHub para come√ßar.</p>
            
            <div class="space-y-4">
                <div class="relative w-full group neon-border rounded-xl transition-all">
                    <i class="fas fa-user absolute left-4 top-4 text-gray-500 transition-colors"></i>
                    <input type="text" id="input-user" placeholder="Seu Usu√°rio GitHub" class="w-full bg-black/50 border border-gray-700 rounded-xl p-3.5 pl-12 text-blue-400 focus:border-blue-500 outline-none font-mono text-sm placeholder-gray-600">
                </div>

                <div class="relative w-full group neon-border rounded-xl transition-all">
                    <i class="fas fa-key absolute left-4 top-4 text-gray-500 transition-colors"></i>
                    <input type="password" id="input-token" placeholder="Token (ghp_...)" class="w-full bg-black/50 border border-gray-700 rounded-xl p-3.5 pl-12 text-green-400 focus:border-green-500 outline-none font-mono text-sm placeholder-gray-600">
                </div>
            </div>
            
            <button onclick="fazerLogin()" class="w-full mt-8 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-[0.98] uppercase tracking-wider text-sm flex items-center justify-center gap-2">
                <span>Acessar Painel</span> <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ==========================================
         VIEW 2: DASHBOARD (LISTA DE APPS)
         ========================================== -->
    <div id="view-dashboard" class="flex-1 flex flex-col hidden-view h-full">
        <!-- Cabe√ßalho Perfil -->
        <div class="p-6 shrink-0 flex justify-between items-center border-b border-gray-800 bg-black/60 backdrop-blur-md z-10 pt-8">
            <div class="flex items-center gap-3">
                <img id="user-avatar" src="" class="w-10 h-10 rounded-full border-2 border-blue-500 shadow-lg bg-gray-800">
                <div>
                    <h1 class="text-lg font-bold text-white leading-tight" id="user-name">Ol√°!</h1>
                    <p class="text-gray-500 text-[10px] uppercase tracking-wide font-bold">Gerenciador V6</p>
                </div>
            </div>
            <button onclick="showView('view-profile')" class="bg-gray-800 hover:bg-gray-700 p-2.5 rounded-xl transition active:scale-95 border border-gray-700">
                <i class="fas fa-cog text-gray-400"></i>
            </button>
        </div>

        <!-- Lista de Apps (Com Scroll) -->
        <div id="apps-list" class="grid grid-cols-2 gap-4 p-5 overflow-y-auto custom-scroll flex-1 pb-32 content-start">
            <!-- Os cards ser√£o injetados aqui pelo JavaScript -->
        </div>

        <!-- Bot√£o Flutuante (Novo App) -->
        <button onclick="novoApp()" class="fixed bottom-8 right-6 w-16 h-16 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl shadow-[0_10px_30px_-10px_rgba(37,99,235,0.6)] flex items-center justify-center text-white text-3xl z-50 hover:scale-105 transition active:scale-95 border border-white/20">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- ==========================================
         VIEW 3: EDITOR (CONFIGURA√á√ÉO DO APP)
         ========================================== -->
    <div id="view-editor" class="flex-1 flex flex-col hidden-view h-full bg-black relative">
        
        <!-- 1. Topo Fixo -->
        <div class="p-4 shrink-0 flex items-center border-b border-gray-800 bg-gray-900/90 backdrop-blur-md z-20 shadow-lg pt-6">
            <button onclick="voltarDashboard()" class="p-2.5 mr-4 text-gray-400 hover:text-white bg-gray-800/80 rounded-xl transition active:scale-90 border border-gray-700">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2 id="editor-title" class="text-lg font-bold truncate text-white tracking-wide">Novo App</h2>
        </div>

        <!-- 2. Conte√∫do com Scroll (Meio) -->
        <div class="flex-1 overflow-y-auto p-5 space-y-8 custom-scroll" style="padding-bottom: 240px;">
            <input type="hidden" id="edit-id">

            <!-- Nome do App -->
            <div class="bg-gray-900/50 p-4 rounded-2xl border border-gray-800">
                <label class="text-[10px] text-blue-400 font-bold uppercase tracking-wider ml-1 flex items-center gap-2 mb-2">
                    <i class="fas fa-tag"></i> Nome do Projeto
                </label>
                <input type="text" id="app-name" placeholder="Ex: Minha Loja" class="w-full bg-black/60 border border-gray-700 rounded-xl p-3.5 text-white focus:border-blue-500 outline-none font-bold shadow-inner placeholder-gray-700 transition">
            </div>

            <!-- Uploads -->
            <div class="grid grid-cols-2 gap-4">
                <!-- √çcone -->
                <div class="bg-gray-900/50 border border-gray-700 border-dashed rounded-2xl p-4 text-center relative group hover:border-blue-500 transition cursor-pointer h-32 flex flex-col items-center justify-center active:bg-gray-800">
                    <div class="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center mb-2 group-hover:bg-blue-500/20 transition">
                        <i class="fas fa-image text-2xl text-blue-400"></i>
                    </div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider group-hover:text-white">√çcone (PNG)</p>
                    <input type="file" id="app-icon" accept="image/png" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onchange="updateFileStatus(this, 'icon-dot')">
                    <div id="icon-dot" class="absolute top-3 right-3 w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] hidden ring-2 ring-black"></div>
                </div>
                <!-- Site -->
                <div class="bg-gray-900/50 border border-gray-700 border-dashed rounded-2xl p-4 text-center relative group hover:border-green-500 transition cursor-pointer h-32 flex flex-col items-center justify-center active:bg-gray-800">
                    <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center mb-2 group-hover:bg-green-500/20 transition">
                        <i class="fas fa-code text-2xl text-green-400"></i>
                    </div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider group-hover:text-white">Index.html</p>
                    <input type="file" id="app-index" accept=".html" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onchange="updateFileStatus(this, 'index-dot')">
                    <div id="index-dot" class="absolute top-3 right-3 w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] hidden ring-2 ring-black"></div>
                </div>
            </div>

            <!-- Grade de Recursos (Plugins) -->
            <div>
                <label class="text-[10px] text-blue-400 font-bold uppercase tracking-wider ml-1 mb-4 block flex items-center gap-2">
                    <i class="fas fa-microchip"></i> Recursos & Permiss√µes
                </label>
                <div class="grid grid-cols-3 gap-3">
                    <!-- Fun√ß√µes -->
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-notification" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-bell text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">Notificar</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-vibration" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-mobile-alt text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">Vibrar</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-camera" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-camera text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">C√¢mera</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-file" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-folder-open text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">Arquivos</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-geolocation" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-map-marker-alt text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">GPS</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-orientation" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-sync text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">Girar</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-fullscreen" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-expand text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] text-gray-400 uppercase font-bold text-center leading-tight">Tela Cheia</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-flashlight" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-lightbulb text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Lanterna</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-microphone" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-microphone text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Mic</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-insomnia" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-eye text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Acordado</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-browser" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-globe text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Browser</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-toast" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-comment-alt text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Toast</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-statusbar" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-window-maximize text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Status Bar</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-clipboard" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-clipboard text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Copiar</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-network" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-wifi text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Wifi</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-splashscreen" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-image text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Splash</span></div></label>
                    <label class="check-card cursor-pointer relative"><input type="checkbox" id="feat-battery" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-xl p-2 h-20 flex flex-col items-center justify-center hover:bg-gray-800"><i class="fas fa-battery-half text-gray-500 text-lg mb-1.5 transition"></i><span class="text-[9px] font-bold">Bateria</span></div></label>
                </div>
            </div>

            <!-- Terminal Log -->
            <div id="status-log" class="hidden bg-black/80 rounded-xl p-4 text-[10px] font-mono text-green-400 h-28 border border-gray-800 shadow-inner overflow-y-auto custom-scroll"></div>
        </div>

        <!-- Barra Inferior Fixa -->
        <div class="absolute bottom-0 left-0 w-full bg-black/95 border-t border-gray-800 p-4 z-30 shadow-[0_-5px_30px_rgba(0,0,0,0.9)] backdrop-blur-lg safe-area-bottom">
            <div class="max-w-xl mx-auto grid grid-cols-3 gap-3">
                <button onclick="salvarRascunho()" class="bg-gray-800 text-gray-300 font-bold py-4 rounded-2xl text-xs hover:bg-gray-700 transition active:scale-95 border border-gray-700">SALVAR</button>
                <button id="btn-build" onclick="fabricarApp()" class="col-span-2 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold py-4 rounded-2xl text-xs hover:scale-[1.02] transition shadow-lg shadow-blue-500/20 uppercase tracking-wide flex items-center justify-center space-x-2 active:scale-95">
                    <i class="fas fa-hammer"></i> <span>Fabricar APK</span>
                </button>
            </div>
            
            <!-- BOT√ÉO DE DOWNLOAD OFICIAL (RELEASE GITHUB) -->
            <a id="btn-download" href="#" target="_blank" class="hidden mt-3 w-full max-w-xl mx-auto bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-2xl text-center shadow-lg shadow-green-500/40 animate-bounce flex items-center justify-center space-x-2 text-sm active:scale-95 transition">
                <i class="fab fa-github text-lg"></i> <span>BAIXAR NO GITHUB (OFICIAL)</span>
            </a>
        </div>
    </div>

    <!-- VIEW 4: PERFIL -->
    <div id="view-profile" class="flex-1 flex flex-col hidden-view fade-in bg-black">
        <div class="p-6 flex items-center gap-4 border-b border-gray-800">
            <button onclick="voltarDashboard()" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-xl font-bold">Meu Perfil</h2>
        </div>
        <div class="p-6 flex flex-col items-center">
            <img id="profile-avatar" src="" class="w-24 h-24 rounded-full border-4 border-blue-500 shadow-xl mb-4">
            <h2 id="profile-name" class="text-2xl font-bold text-white">Usu√°rio</h2>
            <p id="profile-login" class="text-gray-500 text-sm mb-8">@usuario</p>
            
            <div class="w-full bg-gray-900 rounded-xl p-4 border border-gray-800 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-xs uppercase font-bold">Status do Token</span>
                    <span class="text-green-500 text-xs font-bold flex items-center"><div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div> ATIVO</span>
                </div>
                <div class="h-1 w-full bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 w-full shadow-[0_0_10px_#22c55e]"></div>
                </div>
            </div>

            <button onclick="logout()" class="w-full bg-red-600/20 text-red-500 hover:bg-red-600/30 font-bold py-4 rounded-xl border border-red-600/30 transition">
                DESCONECTAR CONTA
            </button>
        </div>
    </div>

    <!-- Scripts do Sistema -->
    <script>
        const GITHUB_REPO = "Maquina-Apks";
        let GITHUB_USER = localStorage.getItem('github_user_login') || "gamerkaua00";
        let MEUS_APPS = JSON.parse(localStorage.getItem('meus_apps') || '[]');

        function updateFileStatus(input, dotId) { 
            if(input.files.length > 0) document.getElementById(dotId).classList.remove('hidden'); 
        }

        // --- SISTEMA PWA ---
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.protocol === 'http:')) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); 
            deferredPrompt = e;
            document.getElementById('pwa-install-bar').classList.remove('hidden');
            document.getElementById('pwa-install-bar').classList.add('flex');
        });

        async function instalarPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwa-install-bar').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        }

        // --- AUTH & INIT ---
        window.onload = async () => {
            const token = localStorage.getItem('github_token');
            const savedUser = localStorage.getItem('github_user_login');
            if(savedUser) GITHUB_USER = savedUser;

            const buildPendente = localStorage.getItem('build_pendente');
            
            if (token) { 
                await carregarPerfil(token); // Atualiza dados do perfil
                showView('view-dashboard'); 
                renderAppsList(); 
                
                if (buildPendente) {
                    showView('view-editor');
                    const logBox = document.getElementById('status-log');
                    logBox.classList.remove('hidden');
                    logBox.innerHTML = '<div class="text-yellow-400 border-b border-gray-800 pb-1 mb-1 font-bold">> Retomando conex√£o com a f√°brica...</div>';
                    monitorar(token, (msg, err) => {
                        logBox.innerHTML += `<div class="${err?'text-red-400':'text-green-400'} border-b border-gray-800 pb-1 mb-1">> ${msg}</div>`;
                        logBox.scrollTop = logBox.scrollHeight;
                    });
                }
            } else {
                showView('view-login');
            }
        };

        // --- L√ìGICA DE PERFIL E LOGIN ---
        async function carregarPerfil(token) {
            try {
                const res = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${token}` } });
                if(res.ok) {
                    const data = await res.json();
                    GITHUB_USER = data.login;
                    localStorage.setItem('github_user_login', data.login);
                    localStorage.setItem('github_user_avatar', data.avatar_url);
                    localStorage.setItem('github_user_name', data.name || data.login);
                    
                    // Atualiza UI
                    document.getElementById('user-avatar').src = data.avatar_url;
                    document.getElementById('profile-avatar').src = data.avatar_url;
                    document.getElementById('user-name').innerText = (data.name || data.login).split(' ')[0];
                    document.getElementById('profile-name').innerText = data.name || data.login;
                    document.getElementById('profile-login').innerText = "@" + data.login;
                }
            } catch(e) { console.error("Erro perfil", e); }
        }

        async function fazerLogin() {
            const token = document.getElementById('input-token').value.trim();
            const user = document.getElementById('input-user').value.trim(); // Opcional, o sistema busca sozinho
            
            if (!token.startsWith('ghp_')) return alert("Token inv√°lido! Deve come√ßar com ghp_");
            
            const btn = document.querySelector('#view-login button');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';
            btn.disabled = true;

            try {
                // Valida o Token buscando o usu√°rio
                const res = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${token}` } });
                if(!res.ok) throw new Error("Token n√£o autorizado ou inv√°lido.");
                
                const data = await res.json();
                
                // Salva tudo
                localStorage.setItem('github_token', token);
                localStorage.setItem('github_user_login', data.login);
                GITHUB_USER = data.login;
                
                await carregarPerfil(token);
                showView('view-dashboard');
                renderAppsList();

            } catch(e) {
                alert("Erro no Login: " + e.message);
                btn.innerHTML = 'ENTRAR';
                btn.disabled = false;
            }
        }

        function salvarToken() { fazerLogin(); } // Alias para compatibilidade

        function logout() {
            if(confirm("Deseja realmente desconectar?")) {
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_user_login');
                location.reload();
            }
        }

        function showView(id) {
            ['view-login', 'view-dashboard', 'view-editor', 'view-profile'].forEach(v => {
                const el = document.getElementById(v);
                if(el) el.classList.add('hidden-view');
            });
            document.getElementById(id).classList.remove('hidden-view');
        }

        // --- DASHBOARD ---
        function renderAppsList() {
            const list = document.getElementById('apps-list');
            list.innerHTML = '';
            
            if (MEUS_APPS.length === 0) {
                list.innerHTML = `<div class="col-span-2 text-center py-20 text-gray-700 select-none flex flex-col items-center justify-center opacity-60"><i class="fas fa-ghost text-5xl mb-3 animate-bounce"></i><br>Nenhum projeto encontrado.</div>`;
                return;
            }

            MEUS_APPS.forEach(app => {
                const icon = app.iconData ? `data:image/png;base64,${app.iconData}` : 'https://img.icons8.com/fluency/48/android-os.png';
                
                // Bot√£o de Download Linkado
                let downloadBtn = '';
                if (app.lastDownloadUrl) {
                    downloadBtn = `
                        <a href="${app.lastDownloadUrl}" target="_blank" onclick="event.stopPropagation()" class="absolute bottom-3 left-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-3 py-1.5 rounded-full shadow-lg font-bold z-10 flex items-center active:scale-95 transition border border-white/10">
                            <i class="fas fa-download mr-1"></i> BAIXAR
                        </a>
                    `;
                }

                list.innerHTML += `
                    <div onclick="abrirApp(${app.id})" class="app-card bg-gray-900 rounded-2xl p-4 cursor-pointer relative overflow-hidden group shadow-lg min-h-[150px] hover:border-blue-500/50">
                        <div class="flex flex-col items-center">
                            <div class="w-14 h-14 bg-black rounded-xl mb-3 shadow-inner flex items-center justify-center p-1 border border-gray-800">
                                <img src="${icon}" class="w-full h-full object-contain rounded-lg">
                            </div>
                            <h3 class="font-bold text-sm text-center truncate w-full text-gray-200">${app.name}</h3>
                            <span class="text-[10px] text-gray-500 mt-1 mb-8">${new Date(app.date).toLocaleDateString()}</span>
                        </div>
                        ${downloadBtn}
                        <button onclick="event.stopPropagation(); deletarApp(${app.id})" class="absolute top-3 right-3 w-7 h-7 rounded-full bg-black/60 text-gray-500 hover:text-red-500 flex items-center justify-center transition backdrop-blur-sm"><i class="fas fa-times text-[10px]"></i></button>
                    </div>
                `;
            });
        }

        function novoApp() {
            document.getElementById('edit-id').value = '';
            document.getElementById('app-name').value = '';
            document.getElementById('editor-title').innerText = "Novo Projeto";
            document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
            document.getElementById('status-log').classList.add('hidden');
            document.getElementById('btn-download').classList.add('hidden');
            document.getElementById('btn-build').classList.remove('hidden');
            document.getElementById('icon-dot').classList.add('hidden');
            document.getElementById('index-dot').classList.add('hidden');
            showView('view-editor');
        }

        function abrirApp(id) {
            const app = MEUS_APPS.find(a => a.id === id);
            if(!app) return;
            document.getElementById('edit-id').value = app.id;
            document.getElementById('app-name').value = app.name;
            document.getElementById('editor-title').innerText = app.name;
            
            if(app.features) {
                for (let k in app.features) {
                    const el = document.getElementById('feat-'+k);
                    if(el) el.checked = app.features[k];
                }
            }
            if(app.iconData) document.getElementById('icon-dot').classList.remove('hidden');
            if(app.indexData) document.getElementById('index-dot').classList.remove('hidden');
            
            showView('view-editor');
        }

        function deletarApp(id) {
            if(confirm("Apagar este projeto permanentemente?")) {
                MEUS_APPS = MEUS_APPS.filter(a => a.id !== id);
                localStorage.setItem('meus_apps', JSON.stringify(MEUS_APPS));
                renderAppsList();
            }
        }

        function voltarDashboard() { 
            localStorage.removeItem('build_pendente');
            showView('view-dashboard'); renderAppsList(); 
        }

        const toBase64 = file => new Promise((res, rej) => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = () => res(r.result.split(',')[1]); r.onerror = e => rej(e);
        });

        // --- SALVAR LOCALMENTE (COM LINK) ---
        async function salvarRascunho(downloadUrl = null) {
            const name = document.getElementById('app-name').value;
            if(!name) return alert("D√™ um nome!");
            
            const idInput = document.getElementById('edit-id');
            const iconFile = document.getElementById('app-icon').files[0];
            const indexFile = document.getElementById('app-index').files[0];

            let app = idInput.value ? MEUS_APPS.find(a => a.id == idInput.value) : {id: Date.now()};
            if(!app) app = {id: Date.now()};

            app.name = name;
            app.date = Date.now();
            if(downloadUrl) app.lastDownloadUrl = downloadUrl; // Salva o link da release do GitHub
            
            app.features = {};
            document.querySelectorAll('input[type=checkbox]').forEach(c => app.features[c.id.replace('feat-','')] = c.checked);

            if(iconFile) app.iconData = await toBase64(iconFile);
            if(indexFile) app.indexData = await toBase64(indexFile);

            const idx = MEUS_APPS.findIndex(a => a.id === app.id);
            if(idx >= 0) MEUS_APPS[idx] = app; else MEUS_APPS.push(app);
            
            localStorage.setItem('meus_apps', JSON.stringify(MEUS_APPS));
            
            if(!downloadUrl) { alert("‚úÖ Projeto salvo na mem√≥ria!"); voltarDashboard(); }
        }

        // --- UI LOG ---
        const log = (m, e) => {
            const logBox = document.getElementById('status-log');
            const t = new Date().toLocaleTimeString('pt-BR',{hour12:false});
            logBox.innerHTML += `<div class="${e?'text-red-400':'text-green-400'} border-b border-gray-800 pb-1 mb-1 font-mono leading-tight"><span class="text-gray-500 text-[9px]">[${t}]</span> ${m}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        };

        // --- FABRICA√á√ÉO ---
        async function fabricarApp() {
            const token = localStorage.getItem('github_token');
            const name = document.getElementById('app-name').value;
            const id = document.getElementById('edit-id').value;
            let app = id ? MEUS_APPS.find(a => a.id == id) : {};

            const iconFile = document.getElementById('app-icon').files[0];
            const indexFile = document.getElementById('app-index').files[0];
            
            let iconData = iconFile ? await toBase64(iconFile) : app.iconData;
            let indexData = indexFile ? await toBase64(indexFile) : app.indexData;

            if(!indexData) return alert("Faltou o arquivo Index.html!");

            const features = {};
            document.querySelectorAll('input[type=checkbox]').forEach(c => features[c.id.replace('feat-','')] = c.checked);

            const btn = document.getElementById('btn-build');
            const logBox = document.getElementById('status-log');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ENVIANDO...';
            logBox.classList.remove('hidden');
            logBox.innerHTML = '';
            
            const log = (m, e) => { 
                const t = new Date().toLocaleTimeString('pt-BR',{hour12:false});
                logBox.innerHTML += `<div class="${e?'text-red-400':'text-green-400'} border-b border-gray-800 pb-1 mb-1"><span class="text-gray-600">[${t}]</span> ${m}</div>`; 
                logBox.scrollTop=logBox.scrollHeight; 
            };

            try {
                log("üöÄ Iniciando envio...");
                await upload(token, "www/index.html", indexData);
                if(iconData) await upload(token, "www/icon.png", iconData);
                await upload(token, "features.json", btoa(JSON.stringify(features)));
                await updateConfig(token, name);

                log("‚úÖ ENVIO CONCLU√çDO! Iniciando f√°brica...");
                
                if(!id) document.getElementById('edit-id').value = Date.now();
                await salvarRascunho(); 
                localStorage.setItem('build_pendente', 'true');

                monitorar(token, log);

            } catch(e) {
                log(e.message, true);
                btn.disabled = false;
                btn.innerHTML = "ERRO - TENTAR DE NOVO";
            }
        }

        // --- API GITHUB ---
        async function upload(token, path, content) {
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`;
            let sha = null;
            try { const c = await fetch(url, { headers: { Authorization: `token ${token}` }}); if(c.ok) sha = (await c.json()).sha; } catch(e){}
            const res = await fetch(url, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Update", content, sha, branch: "main" })
            });
            if(!res.ok) throw new Error("Erro upload "+path);
        }

        async function updateConfig(token, name) {
            const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/config.xml`;
            const check = await fetch(url, { headers: { Authorization: `token ${token}` }});
            let content = `<?xml version='1.0'?><widget id="com.kaua.app" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0"><name>App</name><content src="index.html"/><access origin="*"/><allow-navigation href="*"/><allow-intent href="*"/><preference name="AndroidInsecureFileModeEnabled" value="true"/><preference name="scheme" value="http"/><preference name="hostname" value="localhost"/></widget>`;
            let sha = null;
            if(check.ok) {
                const data = await check.json();
                content = decodeURIComponent(escape(atob(data.content.replace(/\s/g, ''))));
                sha = data.sha;
            }
            const newContent = content.replace(/<name>.*?<\/name>/, `<name>${name}</name>`);
            await fetch(url, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Config", content: btoa(unescape(encodeURIComponent(newContent))), sha, branch: "main" })
            });
        }

        // --- MONITORAMENTO ---
        async function monitorar(token, log) {
            const btn = document.getElementById('btn-build');
            btn.innerHTML = "FABRICANDO... (3 min)";
            btn.classList.add('processing');
            
            let attempts = 0;
            const i = setInterval(async () => {
                attempts++;
                try {
                    const r = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/actions/runs?per_page=1`, { headers: { Authorization: `token ${token}` }});
                    const d = await r.json();
                    if(d.workflow_runs?.[0]) {
                        const run = d.workflow_runs[0];
                        if(run.status === "completed") {
                            clearInterval(i);
                            btn.classList.remove('processing');
                            localStorage.removeItem('build_pendente'); 
                            if(run.conclusion === "success") {
                                log("‚ú® SUCESSO! Buscando link...");
                                await getLink(token, log);
                            } else {
                                log("‚ùå Falha na produ√ß√£o.", true);
                                btn.disabled = false;
                                btn.innerHTML = "FALHOU";
                            }
                        } else {
                            if(attempts%3===0) log(`üî® Trabalhando... [${run.status}]`);
                        }
                    }
                } catch(e){}
                if(attempts > 60) { clearInterval(i); log("Tempo esgotado.", true); btn.disabled=false; btn.innerHTML="TIMEOUT"; btn.classList.remove('processing'); }
            }, 10000);
        }

        async function getLink(token, log) {
            try {
                const r = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/releases/latest`, { headers: { Authorization: `token ${token}` }});
                const d = await r.json();
                
                // PEGA SEMPRE O LINK DA P√ÅGINA DO GITHUB (Seguran√ßa Total)
                let urlRepo = d.html_url; 

                const btnDown = document.getElementById('btn-download');
                const btnBuild = document.getElementById('btn-build');
                btnBuild.classList.add('hidden');

                // MOSTRA LINK DA P√ÅGINA OFICIAL
                if (urlRepo) {
                    btnDown.href = urlRepo;
                    btnDown.classList.remove('hidden');
                    btnDown.innerHTML = `<i class="fab fa-github text-xl"></i> ABRIR P√ÅGINA DO DOWNLOAD`;
                    log("‚úÖ Link Seguro Gerado!");
                    
                    // Salva o link da p√°gina no card do app
                    salvarRascunho(urlRepo);
                } else {
                    log("Link n√£o encontrado.", true);
                }

            } catch(e){ log("Erro ao buscar link.", true); }
        }
    </script>
</body>
</html>
