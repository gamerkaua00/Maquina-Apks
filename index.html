<script>
    const CFG = { u: "gamerkaua00", r: "Maquina-Apks" };
    const $ = id => document.getElementById(id);
    const log = m => $('logs').innerText = "> " + m;

    window.onload = () => { if(localStorage.getItem('tk')) { $('view-login').classList.add('hidden'); $('view-main').classList.remove('hidden'); loadHistory(); } };
    function login() { const t=$('tkn').value; if(t.startsWith('ghp_')){localStorage.setItem('tk',t); location.reload();}else alert('Token Inválido'); }
    function logout() { localStorage.removeItem('tk'); location.reload(); }

    function tab(t) {
        ['editor','plugins','history'].forEach(x => { $(`content-${x}`).classList.add('hidden'); $(`tab-${x}`).classList.remove('tab-active','text-emerald-500'); });
        $(`content-${t}`).classList.remove('hidden'); $(`tab-${t}`).classList.add('tab-active');
        if(t==='history') loadHistory();
    }

    function preview(input, img) { if(input.files[0]){ const r=new FileReader(); r.onload=e=>{ $(img).src=e.target.result; $(img).classList.remove('hidden'); }; r.readAsDataURL(input.files[0]); } }
    function loadFile(input) { if(input.files[0]){ const r=new FileReader(); r.onload=e=> $('code-editor').value=e.target.result; r.readAsText(input.files[0]); } }
    const toB64 = f => new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result.split(',')[1]);d.onerror=j;});

    async function upload(path, content, msg) {
        const t=localStorage.getItem('tk');
        const url=`https://api.github.com/repos/${CFG.u}/${CFG.r}/contents/${path}`;
        let sha=null; try{const c=await fetch(url,{headers:{Authorization:`token ${t}`}});if(c.ok)sha=(await c.json()).sha;}catch(e){}
        const body={message:msg,content:content,branch:"main"}; if(sha)body.sha=sha;
        await fetch(url,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
    }

    async function build() {
        const btn=$('btn-build'); 
        
        // --- 1. VALIDAÇÃO RIGOROSA DO ID (CORREÇÃO DO ERRO DO ANDROID) ---
        const pkgInput = $('pkg').value || "com.app.v68";
        // Regex: Começa com letra, tem ponto no meio, termina com letra/número
        const idValido = /^[a-z][a-z0-9_]*(\.[a-z0-9_]+)+$/.test(pkgInput.trim().toLowerCase());

        if (!idValido) {
            alert("❌ ERRO NO ID!\n\nO ID do pacote deve ter pontos e ser minúsculo.\nCorreto: com.kaua.app\nErrado: AppKaua");
            $('pkg').focus();
            $('pkg').style.borderColor = "red";
            return; // PARA TUDO AQUI
        }
        $('pkg').style.borderColor = "#374151"; // Volta a cor normal

        btn.disabled=true; btn.innerText="ENVIANDO...";
        try {
            const html=$('code-editor').value;
            if(!html) throw "Cole o HTML!";

            log("Subindo Core...");
            await upload("www/index.html", btoa(unescape(encodeURIComponent(html))), "Core Update");
            const fIco=$('f-icon').files[0]; if(fIco) await upload("www/icon.png", await toB64(fIco), "Icon Update");
            const fSpl=$('f-splash').files[0]; if(fSpl) await upload("www/splash.png", await toB64(fSpl), "Splash Update");

            log("Configurando Bot...");
            const feat = {
                appName: $('name').value||"AppV68", 
                packageId: pkgInput.trim().toLowerCase(), // Envia o ID tratado
                version: $('ver').value||"1.0.0",
                hasSplash: !!fSpl, outputType: $('build-type')?.value||'apk', orientation: $('orient').value, admobId: $('ad-id').value,
                statusBarColor: $('status-color').value,
                // Plugins
                notification: $('c-notif').checked, camera: $('c-cam').checked, file: $('c-file').checked,
                geolocation: $('c-geo').checked, vibration: $('c-vib').checked, microphone: $('c-mic').checked,
                biometric: $('c-bio').checked, share: $('c-share').checked, tts: $('c-tts').checked,
                flashlight: $('c-flash').checked, battery: $('c-bat').checked, 
                // Novos V68
                brightness: $('c-bright').checked, badge: $('c-badge').checked, email: $('c-email').checked,
                admob: !!$('ad-id').value
            };
            
            // O commit message "Build Trigger" é importante
            await upload("features.json", btoa(unescape(encodeURIComponent(JSON.stringify(feat)))), "Build Trigger V68");
            btn.innerText="FABRICANDO..."; monitor();

        } catch(e) { alert(e); btn.disabled=false; btn.innerText="TENTAR DE NOVO"; }
    }

    async function monitor() {
        const t=localStorage.getItem('tk');
        const int = setInterval(async()=>{
            // Monitora apenas o workflow que foi disparado recentemente
            const r=await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/actions/runs?per_page=1`,{headers:{Authorization:`token ${t}`}});
            const d=await r.json(); const run=d.workflow_runs[0];
            
            if(run.status==="completed") {
                clearInterval(int);
                $('btn-build').disabled=false; $('btn-build').innerText="NOVA ORDEM";
                if(run.conclusion==="success") { tab('history'); alert("✅ SUCESSO!"); }
                else alert("❌ FALHA! O GitHub encontrou um erro.");
            } else {
                log(run.status === "in_progress" ? "O Robô está compilando..." : "Na fila de espera...");
            }
        }, 5000); // Aumentei para 5s para evitar flood na API
    }

    async function loadHistory() {
        const l=$('hist-list'); l.innerHTML='Carregando...';
        const t=localStorage.getItem('tk');
        const r=await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/releases?per_page=5`,{headers:{Authorization:`token ${t}`}});
        const d=await r.json();
        l.innerHTML = '';
        d.forEach(rel => {
            const asset = rel.assets[0]; if(!asset) return;
            l.innerHTML += `<div class="bg-gray-800 p-2 mb-2 rounded flex justify-between items-center border border-gray-700"><div><div class="font-bold text-xs text-emerald-400">${rel.name}</div><div class="text-[9px] text-gray-500">${new Date(rel.published_at).toLocaleDateString()}</div></div><a href="${asset.browser_download_url}" class="bg-emerald-700 text-white px-3 py-1 rounded text-xs font-bold">BAIXAR</a></div>`;
        });
    }
</script>
