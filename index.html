<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√°brica de Apps üè≠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex items-center justify-center p-4">

    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-green-400 mb-2"><i class="fas fa-robot"></i> F√°brica de Apps</h1>
            <p class="text-gray-400 text-sm">Painel de Controle Completo v2.0</p>
        </div>

        <div id="config-section" class="space-y-4">
            
            <!-- 1. Configura√ß√µes de Acesso -->
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                <h3 class="text-gray-300 font-bold mb-3 text-xs uppercase tracking-wider text-blue-400">1. Acesso ao GitHub</h3>
                <label class="block text-xs text-gray-400 mb-1">Seu Token (ghp_...)</label>
                <input type="password" id="github-token" placeholder="Cole seu token aqui" class="w-full bg-gray-800 text-white border border-gray-600 rounded p-2 focus:border-green-500 outline-none text-sm">
            </div>

            <!-- 2. Dados do App -->
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                <h3 class="text-gray-300 font-bold mb-3 text-xs uppercase tracking-wider text-blue-400">2. Identidade do App</h3>
                
                <label class="block text-xs text-gray-400 mb-1">Nome do Aplicativo</label>
                <input type="text" id="app-name" placeholder="Ex: Meu App Incr√≠vel" class="w-full bg-gray-800 text-white border border-gray-600 rounded p-2 mb-4 focus:border-blue-500 outline-none">

                <label class="block text-xs text-gray-400 mb-1">√çcone (PNG Quadrado)</label>
                <input type="file" id="app-icon" accept="image/png" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 mb-4"/>

                <label class="block text-xs text-gray-400 mb-1">C√≥digo do Site (index.html)</label>
                <input type="file" id="app-index" accept=".html" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700"/>
            </div>

            <!-- 3. Recursos (O que o app precisa?) -->
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-600">
                <h3 class="text-gray-300 font-bold mb-3 text-xs uppercase tracking-wider text-blue-400">3. Poderes do App</h3>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="feat-notification" class="form-checkbox h-5 w-5 text-green-500 rounded border-gray-600 bg-gray-800 focus:ring-offset-gray-900">
                        <span class="text-sm text-gray-300"><i class="fas fa-bell w-5"></i> Notifica√ß√µes Locais</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="feat-vibration" class="form-checkbox h-5 w-5 text-green-500 rounded border-gray-600 bg-gray-800 focus:ring-offset-gray-900">
                        <span class="text-sm text-gray-300"><i class="fas fa-mobile-alt w-5"></i> Vibra√ß√£o</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="feat-camera" class="form-checkbox h-5 w-5 text-green-500 rounded border-gray-600 bg-gray-800 focus:ring-offset-gray-900">
                        <span class="text-sm text-gray-300"><i class="fas fa-camera w-5"></i> C√¢mera</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="feat-geolocation" class="form-checkbox h-5 w-5 text-green-500 rounded border-gray-600 bg-gray-800 focus:ring-offset-gray-900">
                        <span class="text-sm text-gray-300"><i class="fas fa-map-marker-alt w-5"></i> Geolocaliza√ß√£o (GPS)</span>
                    </label>
                </div>
            </div>

            <!-- Bot√£o de A√ß√£o -->
            <button onclick="iniciarFabrica()" id="btn-build" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg transform transition hover:scale-105 uppercase tracking-wide">
                <i class="fas fa-cogs"></i> Construir Aplicativo
            </button>
        </div>

        <!-- Log de Status -->
        <div id="status-log" class="mt-6 p-3 bg-black rounded text-xs font-mono text-green-400 h-40 overflow-y-auto hidden border border-gray-700 shadow-inner">
            > Aguardando ordens...
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO PADR√ÉO ---
        const GITHUB_USER = "gamerkaua00"; 
        const GITHUB_REPO = "Maquina-Apks"; 
        
        // --- FUN√á√ïES AUXILIARES ---
        const log = (msg, type = 'info') => {
            const logBox = document.getElementById('status-log');
            logBox.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-400' : (type === 'warn' ? 'text-yellow-400' : 'text-green-400');
            const icon = type === 'error' ? '‚ùå' : (type === 'warn' ? '‚ö†Ô∏è' : '‚úÖ');
            logBox.innerHTML += `<div class="${color} border-b border-gray-800 pb-1 mb-1">${icon} ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- FUN√á√ÉO PRINCIPAL ---
        async function iniciarFabrica() {
            const token = document.getElementById('github-token').value.trim();
            const appName = document.getElementById('app-name').value;
            const iconFile = document.getElementById('app-icon').files[0];
            const indexFile = document.getElementById('app-index').files[0];

            // Coletar Recursos Marcados
            const features = {
                notification: document.getElementById('feat-notification').checked,
                vibration: document.getElementById('feat-vibration').checked,
                camera: document.getElementById('feat-camera').checked,
                geolocation: document.getElementById('feat-geolocation').checked
            };

            if (!token) { alert("ERRO: Cole seu Token do GitHub!"); return; }
            if (!appName || !indexFile) { alert("ERRO: Preencha o Nome e selecione o index.html!"); return; }

            const btn = document.getElementById('btn-build');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando √† F√°brica...';
            document.getElementById('status-log').innerHTML = ''; // Limpa log

            try {
                log("Iniciando processo de fabrica√ß√£o...");

                // 1. Enviar Index.html
                log("Enviando c√≥digo do site...");
                const indexContent = await readFileAsBase64(indexFile);
                await uploadFile(GITHUB_USER, GITHUB_REPO, token, "www/index.html", indexContent, `Update Site: ${appName}`);

                // 2. Enviar √çcone (se houver)
                if (iconFile) {
                    log("Enviando √≠cone personalizado...");
                    const iconContent = await readFileAsBase64(iconFile);
                    await uploadFile(GITHUB_USER, GITHUB_REPO, token, "www/icon.png", iconContent, "Update Icon");
                }

                // 3. Enviar Configura√ß√µes de Recursos (features.json)
                // Isso servir√° para o bot saber quais plugins instalar no futuro
                log("Salvando prefer√™ncias de plugins...");
                const featuresContent = btoa(JSON.stringify(features, null, 2));
                await uploadFile(GITHUB_USER, GITHUB_REPO, token, "features.json", featuresContent, "Update Features Config");

                // 4. Atualizar/Criar Config.xml (Nome do App)
                log(`Configurando nome: ${appName}...`);
                await updateConfigXml(GITHUB_USER, GITHUB_REPO, token, appName);

                log("üéâ SUCESSO TOTAL!");
                log("O rob√¥ recebeu seus arquivos e est√° trabalhando.");
                log("‚è≥ Tempo estimado: 3 a 5 minutos.");
                
                log(`<a href="https://github.com/${GITHUB_USER}/${GITHUB_REPO}/actions" target="_blank" class="block mt-2 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 rounded font-bold no-underline">ACOMPANHAR E BAIXAR APK ‚¨áÔ∏è</a>`);

            } catch (error) {
                log(`FALHA: ${error.message}`, 'error');
                if (error.message.includes("401")) {
                    log("Dica: Seu Token parece inv√°lido. Verifique se copiou certo.", 'warn');
                } else if (error.message.includes("404")) {
                    log("Dica: Reposit√≥rio n√£o encontrado. Verifique o nome 'Maquina-Apks'.", 'warn');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cogs"></i> CONSTRUIR NOVO APP';
            }
        }

        // --- FUN√á√ïES DE API GITHUB ---

        async function uploadFile(user, repo, token, path, content, message) {
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            let sha = null;
            
            // Verifica se arquivo existe para pegar o SHA (Necess√°rio para atualizar)
            try {
                const checkReq = await fetch(url, { headers: { Authorization: `token ${token}` } });
                if (checkReq.ok) {
                    const data = await checkReq.json();
                    sha = data.sha;
                }
            } catch (e) {}

            const body = { message: message, content: content, branch: "main" };
            if (sha) body.sha = sha;

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) throw new Error(`Erro no arquivo ${path} (${response.status})`);
        }

        async function updateConfigXml(user, repo, token, newName) {
            const path = "config.xml";
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            
            // Tenta buscar o arquivo existente
            const getReq = await fetch(url, { headers: { Authorization: `token ${token}` } });
            
            let currentContent = "";
            let sha = null;

            if (getReq.status === 404) {
                // SE N√ÉO EXISTE (404), CRIA UM NOVO PADR√ÉO
                log("Config.xml n√£o existia. Criando um novo...", 'warn');
                currentContent = `<?xml version='1.0' encoding='utf-8'?>
<widget id="com.kaua.app" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
    <name>NomePadrao</name>
    <description>App criado pela Fabrica</description>
    <author email="dev@example.com" href="http://example.com">Dev</author>
    <content src="index.html" />
    <access origin="*" />
    <allow-intent href="http://*/*" />
    <allow-intent href="https://*/*" />
    <!-- Corre√ß√£o de Tela Branca -->
    <preference name="AndroidInsecureFileModeEnabled" value="true" />
    <preference name="scheme" value="http" />
    <preference name="hostname" value="localhost" />
</widget>`;
            } else if (getReq.ok) {
                // SE EXISTE, PEGA O CONTE√öDO
                const data = await getReq.json();
                // Corrige problemas de quebra de linha na decodifica√ß√£o
                currentContent = decodeURIComponent(escape(atob(data.content.replace(/\s/g, ''))));
                sha = data.sha;
            } else {
                throw new Error(`Erro ao buscar config.xml (${getReq.status})`);
            }
            
            // Substitui o nome no XML (Regex robusto)
            const newContent = currentContent.replace(/<name>.*?<\/name>/, `<name>${newName}</name>`);
            
            // Envia de volta para o GitHub
            const body = { 
                message: "Update App Name", 
                // Codifica corretamente para Base64 (suporta acentos)
                content: btoa(unescape(encodeURIComponent(newContent))),
                branch: "main" 
            };
            
            if (sha) body.sha = sha;

            const putReq = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (!putReq.ok) throw new Error("Falha ao salvar config.xml");
        }
    </script>
</body>
</html>
