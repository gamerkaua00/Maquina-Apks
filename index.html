<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fábrica V17</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body{background:#000;color:#fff;font-family:sans-serif}.hidden{display:none!important}</style>
</head>
<body class="flex flex-col h-screen">

    <div id="view-login" class="flex-1 flex items-center justify-center p-6">
        <div class="bg-gray-900 p-8 rounded-xl w-full max-w-sm text-center border border-gray-800">
            <h1 class="text-xl font-bold mb-4 text-green-500">Acesso V17</h1>
            <input type="password" id="tkn" placeholder="Token GitHub" class="w-full bg-black border border-gray-700 rounded p-3 text-center mb-4 text-white">
            <button onclick="login()" class="w-full bg-green-600 font-bold py-3 rounded">ENTRAR</button>
        </div>
    </div>

    <div id="view-editor" class="hidden flex-1 flex flex-col h-full">
        <div class="p-4 bg-gray-900 border-b border-gray-800 flex justify-between">
            <span class="font-bold text-green-400">Criador Pro</span>
            <button onclick="logout()" class="text-red-500 text-xs">SAIR</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <input type="text" id="name" placeholder="Nome do App" class="w-full bg-gray-900 p-3 rounded border border-gray-700 text-white">
            <div class="flex gap-2">
                <input type="text" id="pkg" placeholder="com.app" class="w-2/3 bg-gray-900 p-3 rounded border border-gray-700 text-gray-300">
                <input type="text" id="ver" placeholder="1.0.0" class="w-1/3 bg-gray-900 p-3 rounded border border-gray-700 text-center text-gray-300">
            </div>

            <div class="grid grid-cols-3 gap-2">
                <div onclick="$('f-index').click()" class="bg-gray-800 h-20 rounded flex flex-col items-center justify-center border border-gray-700 cursor-pointer"><i class="fas fa-code mb-1"></i><span class="text-[8px]">INDEX</span></div>
                <div onclick="$('f-icon').click()" class="bg-gray-800 h-20 rounded flex flex-col items-center justify-center border border-gray-700 cursor-pointer"><i class="fas fa-image mb-1"></i><span class="text-[8px]">ICON</span></div>
                <div onclick="$('f-splash').click()" class="bg-gray-800 h-20 rounded flex flex-col items-center justify-center border border-gray-700 cursor-pointer"><i class="fas fa-mobile mb-1"></i><span class="text-[8px]">SPLASH</span></div>
            </div>
            
            <div class="grid grid-cols-4 gap-2 text-[8px] font-bold text-center">
                <label><input type="checkbox" id="c-notif"> NOTIF</label>
                <label><input type="checkbox" id="c-cam"> CAM</label>
                <label><input type="checkbox" id="c-file"> FILE</label>
                <label><input type="checkbox" id="c-geo"> GPS</label>
                <label><input type="checkbox" id="c-vib"> VIB</label>
                <label><input type="checkbox" id="c-full"> FULL</label>
                <label><input type="checkbox" id="c-mic"> MIC</label>
                <label><input type="checkbox" id="c-wake"> WAKE</label>
            </div>

            <input type="file" id="f-index" accept=".html" class="hidden">
            <input type="file" id="f-icon" accept="image/png" class="hidden">
            <input type="file" id="f-splash" accept="image/png" class="hidden">

            <div id="logs" class="bg-black border border-gray-800 p-2 text-[10px] h-32 overflow-auto font-mono text-green-400 rounded">Logs...</div>
        </div>

        <div class="p-4 bg-gray-900 border-t border-gray-800 space-y-2">
            <button id="btn-go" onclick="build()" class="w-full bg-green-600 font-bold py-3 rounded shadow-lg text-white">FABRICAR APK</button>
            <a id="btn-dl" href="#" target="_blank" class="hidden w-full bg-blue-600 font-bold py-3 rounded shadow-lg text-white text-center block">BAIXAR</a>
        </div>
    </div>

    <script>
        const CFG = { u: "gamerkaua00", r: "Maquina-Apks" };
        const $ = id => document.getElementById(id);
        const log = m => { const l = $('logs'); l.innerHTML += `<div>> ${m}</div>`; l.scrollTop = l.scrollHeight; };
        
        // Auto Login
        window.onload = () => {
            const t = localStorage.getItem('tk');
            if(t && t.startsWith('ghp_')) { $('view-login').classList.add('hidden'); $('view-editor').classList.remove('hidden'); }
        }

        function login() { 
            const t = $('tkn').value; 
            if(t.startsWith('ghp_')) { localStorage.setItem('tk', t); location.reload(); } 
            else alert('Token Inválido'); 
        }
        function logout() { localStorage.removeItem('tk'); location.reload(); }

        const toB64 = f => new Promise((r,j) => { const rd = new FileReader(); rd.readAsDataURL(f); rd.onload = () => r(rd.result.split(',')[1]); rd.onerror = j; });

        async function upload(path, content, msg) {
            const t = localStorage.getItem('tk');
            const url = `https://api.github.com/repos/${CFG.u}/${CFG.r}/contents/${path}`;
            let sha = null;
            try { const chk = await fetch(url, {headers:{Authorization:`token ${t}`}}); if(chk.ok) sha = (await chk.json()).sha; } catch(e){}
            const body = { message: msg, content: content, branch: "main" }; if(sha) body.sha = sha;
            await fetch(url, { method: 'PUT', headers: {Authorization:`token ${t}`, 'Content-Type':'application/json'}, body: JSON.stringify(body) });
        }

        async function build() {
            const btn = $('btn-go'); btn.disabled = true; btn.innerText = "ENVIANDO...";
            try {
                const name = $('name').value || "App";
                const pkg = $('pkg').value || "com.app";
                const ver = $('ver').value || "1.0.0";

                const fIdx = $('f-index').files[0];
                const fIco = $('f-icon').files[0];
                const fSpl = $('f-splash').files[0];

                if(!fIdx) return alert("Faltou Index.html");

                log("Enviando arquivos...");
                await upload("www/index.html", await toB64(fIdx), "Index");
                if(fIco) await upload("www/icon.png", await toB64(fIco), "Icon");
                if(fSpl) await upload("www/splash.png", await toB64(fSpl), "Splash");

                const feat = { 
                    appName: name, packageId: pkg, version: ver, hasSplash: !!fSpl,
                    notification: $('c-notif').checked, file: $('c-file').checked, camera: $('c-cam').checked,
                    geolocation: $('c-geo').checked, vibration: $('c-vib').checked, fullscreen: $('c-full').checked,
                    microphone: $('c-mic').checked, insomnia: $('c-wake').checked
                };
                
                await upload("features.json", btoa(unescape(encodeURIComponent(JSON.stringify(feat)))), `Build: ${name}`);

                btn.innerText = "FABRICANDO... (Aguarde)";
                monitor();
            } catch(e) { log("Erro: " + e); btn.disabled = false; btn.innerText = "ERRO"; }
        }

        async function monitor() {
            const t = localStorage.getItem('tk');
            const int = setInterval(async () => {
                const r = await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/actions/runs?per_page=1`, {headers:{Authorization:`token ${t}`}});
                const d = await r.json();
                const run = d.workflow_runs[0];
                if(run && run.status === "completed") {
                    clearInterval(int);
                    // Habilita fabricar de novo
                    $('btn-go').disabled = false;
                    $('btn-go').innerText = "FABRICAR NOVAMENTE";
                    
                    if(run.conclusion === "success") {
                        log("SUCESSO!");
                        const rel = await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/releases/latest`, {headers:{Authorization:`token ${t}`}});
                        const rd = await rel.json();
                        if(rd.assets && rd.assets[0]) {
                            $('btn-dl').href = rd.assets[0].browser_download_url;
                            $('btn-dl').classList.remove('hidden');
                        }
                    } else log("FALHA!");
                }
            }, 5000);
        }
    </script>
</body>
</html>
