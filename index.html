<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F√°brica Turbo V9</title>
    
    <!-- PWA Config -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/robot-2.png">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZhYnJpY2EgVjkiLAogICJzaG9ydF9uYW1lIjogIkZhYnJpY2EiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJpY29ucyI6IFt7InNyYyI6Imh0dHBzOi8vaW1nLmljb25zOC5jb20vZmx1ZW5jeS8xOTIvcm9ib3QtMi5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #000; background-image: radial-gradient(circle at 50% 0%, #111827 0%, #000 100%); color: white; font-family: system-ui, sans-serif; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 25, 40, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .hidden-view { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .check-card { transition: all 0.2s; }
        .check-card input:checked + div { border-color: #3b82f6; background: rgba(59, 130, 246, 0.15); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        .check-card input:checked + div i { color: #60a5fa; transform: scale(1.1); }
        .processing { border-color: #22c55e; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .scroll::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
    
    <script>
        // --- FUN√á√ïES UTILIT√ÅRIAS CARREGADAS ANTES ---
        function showView(targetId) {
            const views = ['view-login', 'view-dashboard', 'view-editor'];
            
            // Esconde todas as views
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden-view');
            });

            // Mostra a view alvo (com prote√ß√£o contra null)
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.remove('hidden-view');
            } else {
                console.error(`Erro Cr√≠tico: Tela '${targetId}' n√£o encontrada no HTML.`);
                // Fallback de seguran√ßa: tenta ir pro login
                if(targetId !== 'view-login') showView('view-login');
            }
        }

        function updateFileStatus(input, dotId) {
            if (input.files.length > 0) {
                const dot = document.getElementById(dotId);
                if(dot) dot.classList.remove('hidden');
            }
        }
    </script>
</head>

<body class="flex flex-col h-[100dvh]">

    <!-- PWA Bar -->
    <div id="pwa-install-bar" class="hidden bg-blue-600 p-3 shadow-lg z-50 flex justify-between items-center px-6 shrink-0 safe-area-top">
        <div class="flex items-center"><i class="fas fa-download mr-3 text-white animate-bounce"></i><span class="text-xs font-bold uppercase tracking-widest">Instalar App</span></div>
        <button onclick="instalarPWA()" class="bg-white text-blue-700 text-[10px] font-bold px-4 py-1.5 rounded-full shadow hover:bg-gray-100">BAIXAR</button>
    </div>

    <!-- TELA 1: LOGIN -->
    <div id="view-login" class="flex-1 flex flex-col justify-center items-center p-6 hidden-view scroll fade-in">
        <div class="glass p-8 rounded-3xl w-full max-w-md text-center shadow-2xl border-t-4 border-blue-500">
            <i class="fas fa-robot text-5xl text-blue-500 mb-4 block"></i>
            <h1 class="text-2xl font-bold mb-2">F√°brica V9</h1>
            <p class="text-gray-400 text-sm mb-6">Acesso Seguro</p>
            
            <input type="password" id="input-token" placeholder="Cole seu Token GitHub" class="w-full bg-black/50 border border-gray-700 rounded-xl p-3 text-center text-green-400 focus:border-green-500 outline-none mb-4 text-sm font-mono shadow-inner">
            
            <button onclick="salvarToken()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95 mb-4">ENTRAR</button>
            <button onclick="resetarDados()" class="text-[10px] text-red-400 hover:text-red-300 underline cursor-pointer">Limpar Dados / Resetar</button>
        </div>
    </div>

    <!-- TELA 2: DASHBOARD -->
    <div id="view-dashboard" class="flex-1 flex flex-col hidden-view h-full">
        <div class="p-5 shrink-0 flex justify-between items-end border-b border-gray-800 bg-black/40 backdrop-blur-md pt-8">
            <div><h1 class="text-xl font-bold text-blue-400">Meus Apps</h1><p class="text-gray-500 text-xs">Gerenciador Pro</p></div>
            <button onclick="logout()" class="text-gray-500 hover:text-white transition p-2"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div id="apps-list" class="grid grid-cols-2 gap-3 p-4 scroll flex-1 pb-32 content-start"></div>
        <button onclick="novoApp()" class="fixed bottom-8 right-6 w-14 h-14 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl shadow-lg flex items-center justify-center text-white text-2xl z-50 hover:scale-105 active:scale-90 transition border border-white/20"><i class="fas fa-plus"></i></button>
    </div>

    <!-- TELA 3: EDITOR -->
    <div id="view-editor" class="flex-1 flex flex-col hidden-view h-full bg-black relative">
        <div class="p-4 shrink-0 flex items-center border-b border-gray-800 bg-gray-900/90 z-20 shadow-lg pt-6">
            <button onclick="voltarDashboard()" class="p-2 mr-3 text-gray-400 hover:text-white bg-gray-800 rounded-lg transition active:scale-90 border border-gray-700"><i class="fas fa-chevron-left"></i></button>
            <h2 id="editor-title" class="text-lg font-bold">Novo App</h2>
        </div>

        <div class="flex-1 scroll p-5 space-y-6 pb-48">
            <input type="hidden" id="edit-id">

            <!-- Identidade -->
            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-800 space-y-3">
                <input type="text" id="app-name" placeholder="Nome (Ex: Minha Loja)" class="w-full bg-black/60 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none mt-1 font-bold shadow-inner placeholder-gray-700 transition">
                <div class="flex gap-2">
                    <input type="text" id="app-pkg" placeholder="ID (com.loja)" class="w-2/3 bg-black/60 border border-gray-700 rounded-lg p-2 text-xs font-mono text-gray-300 outline-none mt-1">
                    <input type="text" id="app-ver" placeholder="1.0.0" class="w-1/3 bg-black/60 border border-gray-700 rounded-lg p-2 text-xs font-mono text-center text-gray-300 outline-none mt-1">
                </div>
            </div>

            <!-- Uploads -->
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-gray-900 border border-gray-700 border-dashed rounded-xl p-2 h-24 flex flex-col items-center justify-center relative cursor-pointer hover:border-blue-500 transition">
                    <i class="fas fa-image text-xl text-gray-500 mb-1 group-hover:text-blue-500"></i><p class="text-[8px] text-gray-400 font-bold uppercase">√çcone</p>
                    <input type="file" id="app-icon" accept="image/png" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onchange="updateFileStatus(this, 'icon-dot')">
                    <div id="icon-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] hidden"></div>
                </div>
                <div class="bg-gray-900 border border-gray-700 border-dashed rounded-xl p-2 h-24 flex flex-col items-center justify-center relative cursor-pointer hover:border-purple-500 transition">
                    <i class="fas fa-mobile-alt text-xl text-gray-500 mb-1 group-hover:text-purple-500"></i><p class="text-[8px] text-gray-400 font-bold uppercase">Splash</p>
                    <input type="file" id="app-splash" accept="image/png" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onchange="updateFileStatus(this, 'splash-dot')">
                    <div id="splash-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] hidden"></div>
                </div>
                <div class="bg-gray-900 border border-gray-700 border-dashed rounded-xl p-2 h-24 flex flex-col items-center justify-center relative cursor-pointer hover:border-green-500 transition">
                    <i class="fas fa-code text-xl text-gray-500 mb-1 group-hover:text-green-500"></i><p class="text-[8px] text-gray-400 font-bold uppercase">Index</p>
                    <input type="file" id="app-index" accept=".html" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10" onchange="updateFileStatus(this, 'index-dot')">
                    <div id="index-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] hidden"></div>
                </div>
            </div>

            <!-- Recursos -->
            <div>
                <label class="text-[10px] text-blue-500 font-bold uppercase ml-1 mb-3 block">Recursos</label>
                <div class="grid grid-cols-4 gap-2">
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-notif" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-bell text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Notif</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-cam" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-camera text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Cam</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-gps" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-map-marker-alt text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">GPS</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-full" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-expand text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Tela</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-vib" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-wave-square text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Vib</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-mic" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-microphone text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Mic</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-flash" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-lightbulb text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Luz</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-file" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-folder text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">File</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-clip" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-clipboard text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Copy</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-net" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-wifi text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Wifi</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-bat" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-battery-half text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Bat</span></div></label>
                    <label class="check-card relative cursor-pointer"><input type="checkbox" id="c-bar" class="hidden"><div class="bg-gray-900 border border-gray-700 rounded-lg h-12 flex flex-col items-center justify-center"><i class="fas fa-window-maximize text-[10px] text-gray-500 mb-1"></i><span class="text-[7px] font-bold">Bar</span></div></label>
                </div>
            </div>
            
            <div id="status-log" class="hidden bg-black/80 rounded-xl p-3 text-[10px] font-mono text-green-400 h-24 border border-gray-800 shadow-inner scroll"></div>
        </div>

        <div class="absolute bottom-0 left-0 w-full bg-black/95 border-t border-gray-800 p-4 z-30 shadow-2xl">
            <div class="max-w-xl mx-auto grid grid-cols-3 gap-3">
                <button onclick="salvarRascunho()" class="bg-gray-800 text-gray-300 font-bold py-3.5 rounded-xl text-xs hover:bg-gray-700 transition active:scale-95 border border-gray-700">SALVAR</button>
                <button id="btn-build" onclick="fabricarApp()" class="col-span-2 bg-blue-600 text-white font-bold py-3.5 rounded-xl text-xs hover:scale-[1.02] transition shadow-lg flex items-center justify-center space-x-2 active:scale-95"><i class="fas fa-hammer"></i> <span>FABRICAR APK</span></button>
            </div>
            <a id="btn-dl" href="#" target="_blank" class="hidden mt-3 w-full bg-green-600 text-white font-bold py-3 rounded-xl text-center text-xs block shadow-lg transition transform active:scale-95"><i class="fas fa-download mr-1"></i> BAIXAR (TURBO)</a>
            <a id="btn-backup" href="#" target="_blank" class="hidden mt-3 w-full bg-gray-800 text-gray-300 font-bold py-3 rounded-xl text-center text-xs block shadow-lg border border-gray-700"><i class="fab fa-github mr-1"></i> P√ÅGINA DO GITHUB</a>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ïES GLOBAIS
        const GITHUB_USER = "gamerkaua00";
        const GITHUB_REPO = "Maquina-Apks";
        let MEUS_APPS = JSON.parse(localStorage.getItem('ma') || '[]');

        // --- SISTEMA PWA ---
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.protocol === 'http:')) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-bar').classList.remove('hidden');
            document.getElementById('pwa-install-bar').classList.add('flex');
        });

        async function instalarPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwa-install-bar').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        }

        // --- AUTH & INIT ---
        window.onload = () => {
            const token = localStorage.getItem('gt');
            const buildPendente = localStorage.getItem('bp');
            if (token) { 
                showView('view-dashboard'); 
                renderAppsList(); 
                
                // Sistema de Resgate de Build
                if (buildPendente) {
                    showView('view-editor');
                    const logBox = document.getElementById('status-log');
                    if (logBox) {
                        logBox.classList.remove('hidden');
                        logBox.innerHTML = '<div class="text-yellow-400 border-b border-gray-800 pb-1 mb-1 font-bold">> Retomando...</div>';
                    }
                    monitorar(token, (msg, err) => {
                        if (logBox) {
                            logBox.innerHTML += `<div class="${err?'text-red-400':'text-green-400'} border-b border-gray-800 pb-1 mb-1">> ${msg}</div>`;
                            logBox.scrollTop = logBox.scrollHeight;
                        }
                    });
                }
            } else {
                showView('view-login');
            }
        };

        function salvarToken() {
            const t = document.getElementById('input-token').value.trim();
            if (t.startsWith('ghp_')) {
                localStorage.setItem('gt', t);
                showView('view-dashboard');
                renderAppsList();
            } else alert("Token inv√°lido! Deve come√ßar com ghp_");
        }

        function logout() {
            if(confirm("Tem certeza que deseja sair?")) {
                localStorage.removeItem('gt');
                location.reload();
            }
        }

        function resetarDados() {
            if(confirm("Isso apagar√° TODOS os apps salvos e o token. Continuar?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function showView(id) {
            ['view-login', 'view-dashboard', 'view-editor'].forEach(v => {
                const el = document.getElementById(v);
                if(el) el.classList.add('hidden-view');
            });
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden-view');
        }

        function voltarDashboard() { 
            localStorage.removeItem('bp'); 
            showView('view-dashboard'); 
            renderAppsList(); 
        }

        // --- DASHBOARD LOGIC (LOJA DE APPS) ---
        function renderAppsList() {
            const list = document.getElementById('apps-list');
            if(!list) return;
            list.innerHTML = '';
            
            if (MEUS_APPS.length === 0) {
                list.innerHTML = `<div class="col-span-2 text-center py-20 text-gray-700 opacity-60"><i class="fas fa-ghost text-5xl mb-3"></i><br>Nenhum projeto.</div>`;
                return;
            }

            MEUS_APPS.forEach(app => {
                const icon = app.iconData ? `data:image/png;base64,${app.iconData}` : 'https://img.icons8.com/fluency/48/android-os.png';
                let btn = app.lastDownloadUrl ? `<a href="${app.lastDownloadUrl}" target="_blank" onclick="event.stopPropagation()" class="absolute bottom-3 left-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-3 py-1.5 rounded-full shadow-lg font-bold z-10 flex items-center active:scale-95 transition border border-white/10"><i class="fas fa-download mr-1"></i> BAIXAR</a>` : '';
                list.innerHTML += `<div onclick="openApp(${app.id})" class="bg-gray-900 rounded-xl p-3 relative group border border-gray-800 hover:border-blue-500 transition"><div class="flex flex-col items-center"><img src="${icon}" class="w-10 h-10 mb-2 rounded bg-black object-contain"><h3 class="font-bold text-xs truncate w-full text-center">${app.name}</h3><div class="text-[9px] text-gray-500">${app.ver||'v1.0'}</div></div>${btn}<button onclick="event.stopPropagation();del(${app.id})" class="absolute top-2 right-2 text-gray-600 hover:text-red-500"><i class="fas fa-times"></i></button></div>`;
            });
        }

        // --- FUN√á√ïES EDITOR ---
        function novoApp() {
            // Limpa tudo com verifica√ß√µes de seguran√ßa
            const editId = document.getElementById('edit-id'); if(editId) editId.value = '';
            const appName = document.getElementById('app-name'); if(appName) appName.value = '';
            const appPkg = document.getElementById('app-pkg'); if(appPkg) appPkg.value = '';
            const appVer = document.getElementById('app-ver'); if(appVer) appVer.value = '1.0.0';
            
            // Limpa inputs file
            ['app-icon', 'app-index', 'app-splash'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Esconde dots
            ['icon-dot', 'index-dot', 'splash-dot'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            
            // Uncheck all
            document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
            
            // Reset bot√µes
            const statusLog = document.getElementById('status-log'); if(statusLog) statusLog.classList.add('hidden');
            const btnDownload = document.getElementById('btn-download'); if(btnDownload) btnDownload.classList.add('hidden');
            const btnBackup = document.getElementById('btn-backup'); if(btnBackup) btnBackup.classList.add('hidden');
            const btnBuild = document.getElementById('btn-build'); if(btnBuild) btnBuild.classList.remove('hidden');
            
            const editorTitle = document.getElementById('editor-title');
            if(editorTitle) editorTitle.innerText = "Novo Projeto";
            
            showView('view-editor');
        }

        function openApp(id) {
            const app = MEUS_APPS.find(x => x.id === id);
            if(!app) return;
            
            const editId = document.getElementById('edit-id'); if(editId) editId.value = app.id;
            const appName = document.getElementById('app-name'); if(appName) appName.value = app.name;
            const appPkg = document.getElementById('app-pkg'); if(appPkg) appPkg.value = app.pkg || '';
            const appVer = document.getElementById('app-ver'); if(appVer) appVer.value = app.ver || '1.0.0';
            
            const editorTitle = document.getElementById('editor-title');
            if(editorTitle) editorTitle.innerText = app.name;
            
            // Limpa file inputs
            ['app-icon', 'app-index', 'app-splash'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });

            if(app.features) {
                for (let k in app.features) {
                    const el = document.getElementById('c-'+k);
                    if(el) el.checked = app.features[k];
                }
            }
            
            // Mostra dots
            const iconDot = document.getElementById('icon-dot');
            if(iconDot) { if(app.iconData) iconDot.classList.remove('hidden'); else iconDot.classList.add('hidden'); }
            
            const indexDot = document.getElementById('index-dot');
            if(indexDot) { if(app.indexData) indexDot.classList.remove('hidden'); else indexDot.classList.add('hidden'); }
            
            const splashDot = document.getElementById('splash-dot');
            if(splashDot) { if(app.splashData) splashDot.classList.remove('hidden'); else splashDot.classList.add('hidden'); }
            
            showView('view-editor');
        }

        function del(id) {
            if(confirm("Apagar?")) {
                MEUS_APPS = MEUS_APPS.filter(x => x.id !== id);
                localStorage.setItem('ma', JSON.stringify(MEUS_APPS));
                renderAppsList();
            }
        }

        const b64 = f => new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result.split(',')[1]);d.onerror=j;});

        // --- SAVE & BUILD ---
        async function save(url = null) {
            const nameEl = document.getElementById('app-name');
            const name = nameEl ? nameEl.value : null;
            
            if(!name) return alert("D√™ um nome ao app!");
            
            const idInput = document.getElementById('edit-id');
            const iconFile = document.getElementById('app-icon').files[0];
            const indexFile = document.getElementById('app-index').files[0];
            const splashFile = document.getElementById('app-splash').files[0];
            
            const pkgInput = document.getElementById('app-pkg');
            const verInput = document.getElementById('app-ver');

            let app = idInput.value ? MEUS_APPS.find(x => x.id == idInput.value) : null;
            if(!app) { app = {id: Date.now()}; MEUS_APPS.push(app); }

            app.name = name;
            app.date = Date.now();
            app.pkg = pkgInput ? pkgInput.value : '';
            app.ver = verInput ? verInput.value : '1.0.0';
            
            if(url) app.lastDownloadUrl = url;
            
            app.features = {};
            document.querySelectorAll('input[type=checkbox]').forEach(c => app.features[c.id.replace('c-','')] = c.checked);

            if(iconFile) app.iconData = await b64(iconFile);
            if(indexFile) app.indexData = await b64(indexFile);
            if(splashFile) app.splashData = await b64(splashFile);

            const idx = MEUS_APPS.findIndex(x => x.id === app.id);
            if(idx >= 0) MEUS_APPS[idx] = app; else MEUS_APPS.push(app);
            
            localStorage.setItem('ma', JSON.stringify(MEUS_APPS));
            
            if(!url) { alert("‚úÖ Salvo!"); voltarDashboard(); }
        }

        const logger = (m, e) => {
            const b = document.getElementById('status-log');
            if(!b) return;
            const t = new Date().toLocaleTimeString('pt-BR',{hour12:false});
            b.innerHTML += `<div class="${e?'text-red-400':'text-green-400'} border-b border-gray-800 pb-1 mb-1 font-mono leading-tight"><span class="text-gray-500 text-[9px]">[${t}]</span> ${m}</div>`;
            b.scrollTop = b.scrollHeight;
        };

        async function build() {
            const t=localStorage.getItem('gt'); 
            const nameEl = document.getElementById('app-name');
            const n = nameEl ? nameEl.value : "SemNome";
            
            const fh=document.getElementById('app-index').files[0]; 
            const fi=document.getElementById('app-icon').files[0]; 
            const fs=document.getElementById('app-splash').files[0];
            
            const idInput = document.getElementById('edit-id');
            const id = idInput ? idInput.value : null;
            
            let a = id ? MEUS_APPS.find(x => x.id == id) : {};
            
            let h=fh?await b64(fh):a.html; let i=fi?await b64(fi):a.icon; let s=fs?await b64(fs):a.splash;
            if(!h)return alert("Falta Index!");

            const pkgInput = document.getElementById('app-pkg');
            const verInput = document.getElementById('app-ver');
            const ft={packageId: pkgInput ? pkgInput.value : '', version: verInput ? verInput.value : '1.0.0'};
            
            document.querySelectorAll('input[type=checkbox]').forEach(c => { 
                const key = c.id.replace('c-', '');
                const map = {notif:'notification',vib:'vibration',cam:'camera',gps:'geolocation',full:'fullscreen',flash:'flashlight',mic:'microphone',ins:'insomnia',file:'file',clip:'clipboard',net:'network',bar:'statusbar',toast:'toast'};
                ft[map[key]||key] = c.checked; 
            });

            const btn=document.getElementById('btn-build'); 
            const logBox=document.getElementById('status-log');
            
            if(logBox) {
                logBox.classList.remove('hidden'); 
                logBox.innerHTML='';
            }
            if(btn) {
                btn.disabled=true; 
                btn.innerHTML='ENVIANDO...';
            }

            try {
                logger("üöÄ Upload Arquivos...");
                await up(t,"www/index.html",h,`Site:${n} [skip ci]`);
                if(i) await up(t,"www/icon.png",i,"Icon [skip ci]");
                if(s) await up(t,"www/splash.png",s,"Splash [skip ci]");
                await up(t,"features.json",btoa(JSON.stringify(ft)),"Feat [skip ci]");
                
                logger("‚ö° Disparando F√°brica...");
                await cfg(t,n);
                
                logger("‚úÖ INICIADO! Aguarde...");
                
                if(!id){ 
                    const newId = Date.now(); 
                    if(idInput) idInput.value = newId; 
                    await save(null); 
                } else await save(null);
                
                localStorage.setItem('bp', '1');
                monitor(t);
            } catch(e){ logger(e.message,1); if(btn){btn.disabled=false; btn.innerHTML="ERRO";} }
        }

        // --- API GITHUB ---
        async function up(t,p,c,m){
            const u=`https://api.github.com/repos/${CFG.u}/${CFG.r}/contents/${p}`; let s=null;
            try{const r=await fetch(u,{headers:{Authorization:`token ${t}`}});if(r.ok)s=(await r.json()).sha;}catch(e){}
            const res=await fetch(u,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:m,content:c,sha:s,branch:"main"})});
            if(!res.ok) throw new Error("Erro upload "+p);
        }

        async function cfg(t,n){
            const u=`https://api.github.com/repos/${CFG.u}/${CFG.r}/contents/config.xml`;
            const r=await fetch(u,{headers:{Authorization:`token ${t}`}});
            let c=`<?xml version='1.0'?><widget id="com.default" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0"><name>App</name><content src="index.html"/><access origin="*"/><allow-navigation href="*"/><allow-intent href="*"/><preference name="AndroidInsecureFileModeEnabled" value="true"/><preference name="scheme" value="http"/><preference name="hostname" value="localhost"/></widget>`;
            let s=null; if(r.ok){const d=await r.json();c=decodeURIComponent(escape(atob(d.content.replace(/\s/g,''))));s=d.sha;}
            const nc=c.replace(/<name>.*?<\/name>/,`<name>${n}</name>`);
            await fetch(u,{method:'PUT',headers:{Authorization:`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:"Trig:"+n,content:btoa(unescape(encodeURIComponent(nc))),sha:s,branch:"main"})});
        }

        // --- MONITOR ---
        async function monitor(t){
            const btn=document.getElementById('btn-build'); 
            if(btn) { btn.innerHTML="FABRICANDO... (3 min)"; btn.classList.add('processing'); }
            
            let att=0;
            const i=setInterval(async()=>{
                att++;
                try{
                    const r=await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/actions/runs?per_page=1`,{headers:{Authorization:`token ${t}`}});
                    const d=await r.json();
                    if(d.workflow_runs?.[0]){
                        const run=d.workflow_runs[0];
                        if(run.status==="completed"){
                            clearInterval(i); 
                            if(btn) btn.classList.remove('processing'); 
                            localStorage.removeItem('bp');
                            if(run.conclusion==="success"){ logger("‚ú® SUCESSO! Pegando link..."); await link(t); }
                            else{ logger("‚ùå Falha no Build.",1); if(btn){btn.disabled=false; btn.innerHTML="FALHA";} }
                        } else { if(att%3===0) logger(`üî® Trabalhando... [${run.status}]`); }
                    }
                }catch(e){}
                if(att>60){clearInterval(i); logger("Tempo esgotado.",1); if(btn){btn.disabled=false; btn.innerHTML="TIMEOUT";} }
            },10000);
        }

        async function link(t){
            try{
                const r=await fetch(`https://api.github.com/repos/${CFG.u}/${CFG.r}/releases/latest`,{headers:{Authorization:`token ${t}`}});
                const d=await r.json();
                const url=d.html_url; 
                const match=d.body.match(/MIRROR_LINK: (https?:\/\/[^\s]+)/);
                const turbo=(match && match[1] && !match[1].includes("Verifique"))?match[1]:null;
                const direct=d.assets?.[0]?.browser_download_url;

                const btnBuild = document.getElementById('btn-build');
                if(btnBuild) btnBuild.classList.add('hidden');
                
                const btnDown=document.getElementById('btn-download');
                const btnBackup=document.getElementById('btn-backup');

                if(turbo && btnDown){
                    btnDown.href=turbo; btnDown.classList.remove('hidden'); btnDown.innerHTML=`<i class="fas fa-bolt text-lg"></i> BAIXAR (TURBO)`; logger("‚ö° Link Turbo"); save(turbo);
                } else if(direct && btnDown){
                    btnDown.href=direct; btnDown.classList.remove('hidden'); btnDown.innerHTML=`<i class="fab fa-github text-lg"></i> BAIXAR (GITHUB)`; logger("‚úÖ Link Direto"); save(direct);
                }

                if(url && btnBackup){
                    btnBackup.href=url; btnBackup.classList.remove('hidden');
                    if(!turbo && !direct && btnDown){
                         btnDown.classList.add('hidden');
                         btnBackup.classList.remove('hidden','mt-3','bg-gray-800');
                         btnBackup.classList.add('bg-blue-600','text-white','py-4');
                         btnBackup.innerHTML=`<i class="fab fa-github text-xl"></i> ABRIR P√ÅGINA`;
                         logger("üí° P√°gina dispon√≠vel"); save(url);
                    }
                }
            }catch(e){logger("Erro link.",1);}
        }
    </script>
</body>
</html>
